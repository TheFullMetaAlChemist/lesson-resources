<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Titration Master | A-Level Chemistry</title>
    
    <!-- Fonts: Inter for UI -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* Brand Colors */
            --primary: #4f46e5; /* Indigo 600 */
            --primary-hover: #4338ca; /* Indigo 700 */
            --primary-light: #e0e7ff; /* Indigo 100 */
            
            --test-mode: #d97706; /* Amber 600 */
            --test-mode-hover: #b45309; /* Amber 700 */
            --test-mode-light: #fef3c7; /* Amber 100 */

            /* Neutral Colors */
            --bg-app: #f3f4f6; /* Gray 100 */
            --bg-panel: #ffffff;
            --text-main: #1f2937; /* Gray 800 */
            --text-muted: #6b7280; /* Gray 500 */
            --border: #e5e7eb; /* Gray 200 */

            /* Functional Colors */
            --success: #10b981; /* Emerald 500 */
            --success-bg: #ecfdf5;
            --error: #ef4444; /* Red 500 */
            --error-bg: #fef2f2;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-app);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Header --- */
        header {
            background-color: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            box-shadow: var(--shadow-sm);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .brand-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), #818cf8);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }

        h1 { margin: 0; font-size: 1.1rem; font-weight: 700; color: var(--text-main); }
        .subtitle { font-size: 0.8rem; color: var(--text-muted); font-weight: 500; }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        /* Segmented Control for Mode */
        .mode-switch {
            background: var(--bg-app);
            padding: 4px;
            border-radius: 8px;
            display: flex;
            border: 1px solid var(--border);
        }

        .mode-btn {
            padding: 6px 16px;
            border: none;
            background: transparent;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .mode-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        /* --- Main Layout --- */
        main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* --- Sidebar (Instructions) --- */
        .sidebar {
            width: 400px;
            min-width: 350px;
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 1.5rem;
            background: #fff;
            position: sticky;
            top: 0;
            z-index: 5;
            border-bottom: 1px solid var(--border);
        }

        .scenario-select {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.9rem;
            color: var(--text-main);
            background-color: var(--bg-app);
            margin-bottom: 0.5rem;
        }

        .scenario-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
            line-height: 1.4;
        }

        .steps-container {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Step Cards */
        .step-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0.6;
            pointer-events: none;
            position: relative;
            overflow: hidden;
        }

        .step-card.active {
            opacity: 1;
            pointer-events: all;
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .step-card.completed {
            opacity: 0.9;
            pointer-events: all; /* Allow reviewing */
            border-color: var(--success);
            background: #fafafa;
        }

        /* Status Bar on left of card */
        .step-status-bar {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--border);
            transition: background 0.3s;
        }
        .step-card.active .step-status-bar { background: var(--primary); }
        .step-card.completed .step-status-bar { background: var(--success); }

        .step-content { padding: 1.25rem; margin-left: 4px; }

        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .step-title {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--text-main);
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .step-badge {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
            background: var(--bg-app);
            color: var(--text-muted);
            font-weight: 600;
        }
        .step-card.completed .step-badge {
            background: var(--success-bg);
            color: var(--success);
        }

        .step-question {
            font-size: 1rem;
            line-height: 1.6;
            color: var(--text-main);
            margin-bottom: 1rem;
        }

        /* Buttons */
        .action-btn {
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            background-color: var(--primary);
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .action-btn:hover { background-color: var(--primary-hover); }
        
        .reset-btn {
            padding: 0.5rem 1rem;
            background: white;
            border: 1px solid var(--border);
            color: var(--text-muted);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
        }
        .reset-btn:hover { background: var(--bg-app); color: var(--text-main); }

        /* Answer Section */
        .answer-box {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--primary-light);
            border-radius: 8px;
            border: 1px solid #c7d2fe;
            color: var(--text-main);
            font-size: 0.95rem;
            line-height: 1.5;
            display: none;
            animation: slideDown 0.3s ease-out;
        }

        /* Test Mode Overrides */
        body.test-mode .mode-btn.active { color: var(--test-mode); }
        body.test-mode .step-card.active { border-color: var(--test-mode); }
        body.test-mode .step-card.active .step-status-bar { background: var(--test-mode); }
        body.test-mode .action-btn { background-color: var(--test-mode); }
        body.test-mode .action-btn:hover { background-color: var(--test-mode-hover); }
        body.test-mode .answer-box { background: var(--test-mode-light); border-color: #fde68a; }
        body.test-mode .brand-icon { background: linear-gradient(135deg, var(--test-mode), #fbbf24); }

        /* Indicator Table */
        .indicator-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.85rem;
            margin: 1rem 0;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }
        .indicator-table th { background: var(--bg-app); font-weight: 600; text-align: left; padding: 8px 12px; border-bottom: 1px solid var(--border); }
        .indicator-table td { padding: 8px 12px; border-bottom: 1px solid var(--border); }
        .indicator-table tr:last-child td { border-bottom: none; }
        
        .select-input {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-top: 0.5rem;
        }

        /* --- Graph Area --- */
        .workspace {
            flex: 1;
            background-color: var(--bg-app);
            padding: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        /* Graph Card */
        .graph-card {
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 900px;
            height: 100%;
            max-height: 600px;
            padding: 1.5rem;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .graph-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        .graph-title { font-weight: 700; color: var(--text-main); }
        .graph-legend { display: flex; gap: 1rem; font-size: 0.8rem; color: var(--text-muted); }
        .legend-item { display: flex; align-items: center; gap: 4px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Mobile Responsive */
        @media (max-width: 900px) {
            main { flex-direction: column; overflow-y: auto; }
            .sidebar { width: 100%; height: auto; min-height: fit-content; border-right: none; border-bottom: 1px solid var(--border); }
            .workspace { height: 500px; padding: 1rem; }
        }
    </style>
</head>
<body class="tutorial-mode">

<header>
    <div class="brand">
        <div class="brand-icon">pH</div>
        <div>
            <h1>Titration Master</h1>
            <div class="subtitle">A-Level Chemistry Simulator</div>
        </div>
    </div>

    <div class="header-controls">
        <div class="mode-switch">
            <button class="mode-btn active" id="btnTutorial" onclick="setMode('tutorial')">Tutorial</button>
            <button class="mode-btn" id="btnTest" onclick="setMode('test')">Test Yourself</button>
        </div>
        <button class="reset-btn" onclick="resetTool()">Reset View</button>
    </div>
</header>

<main>
    <!-- Left Sidebar: Stepper & Logic -->
    <div class="sidebar">
        <div class="sidebar-header">
            <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-muted); display:block; margin-bottom: 0.4rem;">Select Scenario</label>
            <select id="scenarioSelect" class="scenario-select" onchange="loadScenario()">
                <!-- Populated via JS -->
            </select>
            <div id="scenarioDescription" class="scenario-desc"></div>
        </div>

        <div class="steps-container">
            <!-- Step 1 -->
            <div class="step-card active" id="step1">
                <div class="step-status-bar"></div>
                <div class="step-content">
                    <div class="step-header">
                        <span class="step-title">1. Starting Point</span>
                        <span class="step-badge">V = 0</span>
                    </div>
                    <div class="step-question" id="q1">...</div>
                    <button class="action-btn" onclick="reveal(1)">
                        <span>Verify & Plot</span>
                    </button>
                    <div class="answer-box" id="ans1"></div>
                </div>
            </div>

            <!-- Step 2 -->
            <div class="step-card" id="step2">
                <div class="step-status-bar"></div>
                <div class="step-content">
                    <div class="step-header">
                        <span class="step-title">2. Equivalence Vol</span>
                        <span class="step-badge">Calculation</span>
                    </div>
                    <div class="step-question" id="q2">...</div>
                    <button class="action-btn" onclick="reveal(2)">
                        <span>Mark Volume</span>
                    </button>
                    <div class="answer-box" id="ans2"></div>
                </div>
            </div>

            <!-- Step 3 -->
            <div class="step-card" id="step3">
                <div class="step-status-bar"></div>
                <div class="step-content">
                    <div class="step-header">
                        <span class="step-title">3. Buffer Region</span>
                        <span class="step-badge">Pre-Equivalence</span>
                    </div>
                    <div class="step-question" id="q3">...</div>
                    <button class="action-btn" onclick="reveal(3)">
                        <span>Draw Curve</span>
                    </button>
                    <div class="answer-box" id="ans3"></div>
                </div>
            </div>

            <!-- Step 4 -->
            <div class="step-card" id="step4">
                <div class="step-status-bar"></div>
                <div class="step-content">
                    <div class="step-header">
                        <span class="step-title">4. Equivalence pH</span>
                        <span class="step-badge">Vertical Section</span>
                    </div>
                    <div class="step-question" id="q4">...</div>
                    <button class="action-btn" onclick="reveal(4)">
                        <span>Plot Equivalence</span>
                    </button>
                    <div class="answer-box" id="ans4"></div>
                </div>
            </div>

            <!-- Step 5 -->
            <div class="step-card" id="step5">
                <div class="step-status-bar"></div>
                <div class="step-content">
                    <div class="step-header">
                        <span class="step-title">5. End Point</span>
                        <span class="step-badge">Excess</span>
                    </div>
                    <div class="step-question" id="q5">...</div>
                    <button class="action-btn" onclick="reveal(5)">
                        <span>Complete Curve</span>
                    </button>
                    <div class="answer-box" id="ans5"></div>
                </div>
            </div>

            <!-- Step 6: Indicator -->
            <div class="step-card" id="step6">
                <div class="step-status-bar"></div>
                <div class="step-content">
                    <div class="step-header">
                        <span class="step-title">6. Indicator</span>
                        <span class="step-badge">Analysis</span>
                    </div>
                    <div class="step-question">
                        Select the best indicator based on the vertical section. The graph will show the indicator's range.
                        <table class="indicator-table">
                            <thead>
                                <tr><th>Indicator</th><th>Range</th><th>Change</th></tr>
                            </thead>
                            <tbody>
                                <tr><td>Methyl Orange</td><td>3.1 - 4.4</td><td>Red &rarr; Yel</td></tr>
                                <tr><td>Methyl Red</td><td>4.4 - 6.2</td><td>Red &rarr; Yel</td></tr>
                                <tr><td>Bromothymol</td><td>6.0 - 7.6</td><td>Yel &rarr; Blue</td></tr>
                                <tr><td>Phenolphthalein</td><td>8.3 - 10.0</td><td>Clr &rarr; Pink</td></tr>
                            </tbody>
                        </table>
                        <label style="font-size: 0.85rem; font-weight: 600;">Your Choice:</label>
                        <select id="indicatorChoice" class="select-input" onchange="previewIndicator()">
                            <option value="">-- Select --</option>
                            <option value="methyl_orange">Methyl Orange</option>
                            <option value="methyl_red">Methyl Red</option>
                            <option value="bromothymol_blue">Bromothymol Blue</option>
                            <option value="phenolphthalein">Phenolphthalein</option>
                            <option value="none">None (Use pH Meter)</option>
                        </select>
                    </div>
                    <button class="action-btn" onclick="checkIndicator()">
                        <span>Verify Selection</span>
                    </button>
                    <div class="answer-box" id="ans6"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Workspace: Graph -->
    <div class="workspace">
        <div class="graph-card">
            <div class="graph-header">
                <div class="graph-title">Titration Curve</div>
                <div class="graph-legend">
                    <div class="legend-item"><div class="dot" style="background:var(--primary)"></div>pH</div>
                    <div class="legend-item"><div class="dot" style="background:var(--guide)"></div>Veq</div>
                </div>
            </div>
            <div style="flex:1; position: relative;">
                <canvas id="titrationChart"></canvas>
            </div>
        </div>
    </div>
</main>

<script>
    // --- CHART PLUGINS ---
    // Custom plugin to draw the indicator band with a cleaner look
    const indicatorPlugin = {
        id: 'indicatorBand',
        beforeDraw: (chart) => {
            if (!currentIndicatorRange) return;

            const ctx = chart.ctx;
            const yAxis = chart.scales.y;
            const xAxis = chart.scales.x;

            const yTop = yAxis.getPixelForValue(currentIndicatorRange.high);
            const yBottom = yAxis.getPixelForValue(currentIndicatorRange.low);
            
            // Subtle gradient
            const gradient = ctx.createLinearGradient(0, yBottom, 0, yTop);
            gradient.addColorStop(0, currentIndicatorRange.colorLow);
            gradient.addColorStop(1, currentIndicatorRange.colorHigh);

            ctx.save();
            ctx.fillStyle = gradient;
            
            // Draw band
            ctx.fillRect(xAxis.left, yTop, xAxis.width, yBottom - yTop);
            
            // Label the band
            ctx.fillStyle = 'rgba(0,0,0,0.5)';
            ctx.font = '10px Inter';
            ctx.fillText('Indicator Range', xAxis.right - 80, yTop - 5);

            ctx.restore();
        }
    };

    // --- LOGIC & DATA ---
    // (Data structure remains robust, just referencing new colors via JS)
    
    // CSS Variable helper
    const getCssVar = (name) => getComputedStyle(document.body).getPropertyValue(name).trim();

    const allScenarios = {
        tutorial: [
            {
                id: "sasb",
                title: "Strong Acid (HCl) + Strong Base (NaOH)",
                desc: "25 cm³ 0.1 M HCl + 0.1 M NaOH. The classic titration curve.",
                maxVol: 55,
                flow: 'up', 
                indicator: { valid: ['phenolphthalein', 'methyl_orange', 'bromothymol_blue', 'methyl_red'], reason: "Since the vertical section is huge (pH 3-11), almost any indicator works. Phenolphthalein is commonly used." },
                steps: [
                    { q: "We start with 0.1 M Strong Acid. Calculate the pH.", a: "<strong>pH = 1.0</strong><br>For strong acid: [H<sup>+</sup>] = Conc. <br>pH = -log(0.1) = 1.", dataPoints: [{x:0, y:1}] },
                    { q: "Calculate V needed to neutralize 25 cm³ of 0.1 M HCl with 0.1 M NaOH.", a: "<strong>V = 25.0 cm³</strong><br>Equal concentrations (1:1 ratio) = Equal volumes.", guideLine: [{x:25, y:0}, {x:25, y:14}] },
                    { q: "Up to 24 cm³, is there a buffer?", a: "<strong>No Buffer.</strong><br>Strong acid curves rise very slowly until the very end.", dataPoints: [{x:10, y:1.5}, {x:20, y:2}, {x:24, y:2.7}] },
                    { q: "At 25 cm³ (Equivalence), what is the pH?", a: "<strong>pH = 7.0</strong><br>Strong Acid + Strong Base = Neutral Salt + Water.", dataPoints: [{x:24.9, y:3}, {x:25, y:7}, {x:25.1, y:11}] },
                    { q: "With excess 0.1 M NaOH, where does the curve end?", a: "<strong>pH ≈ 13.0</strong><br>pOH = -log(0.1) = 1, so pH = 13.", dataPoints: [{x:30, y:12}, {x:40, y:12.6}, {x:50, y:13}] }
                ]
            },
            {
                id: "wasb",
                title: "Weak Acid (Ethanoic) + Strong Base (NaOH)",
                desc: "25 cm³ 0.1 M Ethanoic Acid (Ka ≈ 1.7×10⁻⁵). Note the buffer region.",
                maxVol: 55,
                flow: 'up',
                indicator: { valid: ['phenolphthalein'], reason: "Vertical section is pH 7-11 (Basic). We need an indicator with pK<sub>in</sub> > 7. Phenolphthalein (9.3) is ideal." },
                steps: [
                    { q: "Start with 0.1 M Weak Acid. Estimate pH.", a: "<strong>pH ≈ 2.9</strong><br>Use [H<sup>+</sup>] = √(K<sub>a</sub> × C).", dataPoints: [{x:0, y:2.9}] },
                    { q: "Calculate V<sub>eq</sub> for 25 cm³ acid with equal conc base.", a: "<strong>V = 25.0 cm³</strong>", guideLine: [{x:25, y:0}, {x:25, y:14}] },
                    { q: "What happens at half-equivalence (12.5 cm³)?", a: "<strong>Buffer Region (pH = pK<sub>a</sub>)</strong><br>pH ≈ 4.8 at 12.5 cm³. <br>Notice the distinctive 'S' shape rise.", dataPoints: [{x:2, y:3.8}, {x:12.5, y:4.8}, {x:23, y:5.8}] },
                    { q: "Is the equivalence point neutral?", a: "<strong>pH ≈ 8.8 (Basic)</strong><br>The salt (ethanoate) hydrolyzes water, releasing OH<sup>-</sup>.", dataPoints: [{x:24.5, y:6.5}, {x:25, y:8.8}, {x:25.5, y:11}] },
                    { q: "Final pH with excess base?", a: "<strong>pH ≈ 13.0</strong><br>Approaches pH of the strong base.", dataPoints: [{x:35, y:12.5}, {x:50, y:13}] }
                ]
            },
            {
                id: "sawb",
                title: "Weak Base (Ammonia) + Strong Acid (HCl)",
                desc: "25 cm³ 0.1 M Ammonia + 0.1 M HCl. Curve flips upside down.",
                maxVol: 55,
                flow: 'down',
                indicator: { valid: ['methyl_orange', 'methyl_red'], reason: "Vertical section is pH 7 down to 4 (Acidic). Methyl Orange (3.7) works best." },
                steps: [
                    { q: "Start with 0.1 M Weak Base (K<sub>b</sub> ≈ 1.8×10⁻⁵).", a: "<strong>pH ≈ 11.1</strong><br>Calculate pOH first (≈2.9), then 14 - pOH.", dataPoints: [{x:0, y:11.1}] },
                    { q: "Calculate V<sub>eq</sub>.", a: "<strong>V = 25.0 cm³</strong>", guideLine: [{x:25, y:0}, {x:25, y:14}] },
                    { q: "What happens at half-equivalence (12.5 cm³)?", a: "<strong>Buffer Region</strong><br>pOH = pK<sub>b</sub> → pH = 9.26. <br>Curve drops, then flattens.", dataPoints: [{x:2, y:10.5}, {x:12.5, y:9.26}, {x:23, y:8.2}] },
                    { q: "Is the equivalence point neutral?", a: "<strong>pH ≈ 5.3 (Acidic)</strong><br>Ammonium ion is acidic.", dataPoints: [{x:24.5, y:7}, {x:25, y:5.3}, {x:25.5, y:3}] },
                    { q: "Final pH with excess acid?", a: "<strong>pH ≈ 1.0</strong><br>Approaches pH of strong acid.", dataPoints: [{x:35, y:1.5}, {x:50, y:1}] }
                ]
            },
            {
                id: "wawb",
                title: "Weak Acid + Weak Base",
                desc: "25 cm³ 0.1 M Ethanoic Acid + 0.1 M Ammonia. The difficult one.",
                maxVol: 55,
                flow: 'up',
                indicator: { valid: ['none'], reason: "There is <strong>no vertical section</strong>. The pH changes gradually throughout. No indicator gives a sharp endpoint. Use a pH meter." },
                steps: [
                    { q: "Start with 0.1 M Weak Acid.", a: "<strong>pH ≈ 2.9</strong>", dataPoints: [{x:0, y:2.9}] },
                    { q: "Calculate V<sub>eq</sub>.", a: "<strong>V = 25.0 cm³</strong>", guideLine: [{x:25, y:0}, {x:25, y:14}] },
                    { q: "Add Weak Base. Does it buffer?", a: "<strong>Yes.</strong><br>pH rises to pK<sub>a</sub> (4.8) at half-equivalence.", dataPoints: [{x:12.5, y:4.8}, {x:20, y:6}] },
                    { q: "Where is the vertical section?", a: "<strong>No Vertical Section!</strong><br>Just a 'point of inflexion' around pH 7.", dataPoints: [{x:24, y:6.8}, {x:25, y:7.0}, {x:26, y:7.2}] },
                    { q: "Excess Weak Base added.", a: "<strong>pH ≈ 10-11</strong><br>Levels off at pH of weak base.", dataPoints: [{x:35, y:9}, {x:50, y:10.5}] }
                ]
            }
        ],
        test: [
            {
                id: "test1",
                title: "Test: 20cm³ HCl + 0.2M NaOH",
                desc: "Challenge: Unequal concentrations.",
                maxVol: 40,
                flow: 'up',
                indicator: { valid: ['phenolphthalein', 'methyl_orange', 'methyl_red', 'bromothymol_blue'], reason: "Strong/Strong titration. Long vertical section covers all common indicators." },
                steps: [
                    { q: "<strong>Q1:</strong> Calculate initial pH for 0.1 M HCl.", a: "<strong>pH = 1.0</strong>", dataPoints: [{x:0, y:1}] },
                    { q: "<strong>Q2:</strong> Calculate V<sub>eq</sub>. <br>Flask: 20 cm³ 0.1 M Acid.<br>Burette: 0.2 M Base.", a: "<strong>V = 10.0 cm³</strong><br>Base is 2x conc, so we need half volume.", guideLine: [{x:10, y:0}, {x:10, y:14}] },
                    { q: "<strong>Q3:</strong> Draw the pre-equivalence section.", a: "<strong>Strong Acid = No Buffer</strong>", dataPoints: [{x:5, y:1.3}, {x:9, y:2}] },
                    { q: "<strong>Q4:</strong> What is the pH at 10 cm³?", a: "<strong>pH = 7.0</strong><br>Neutral.", dataPoints: [{x:9.9, y:3}, {x:10, y:7}, {x:10.1, y:11}] },
                    { q: "<strong>Q5:</strong> Final pH with excess 0.2 M NaOH?", a: "<strong>pH ≈ 13.3</strong><br>[OH] = 0.2, pOH = 0.7.", dataPoints: [{x:15, y:13}, {x:25, y:13.3}, {x:30, y:13.3}] }
                ]
            },
            {
                id: "test2",
                title: "Test: Methanoic Acid + NaOH",
                desc: "Challenge: Stronger weak acid (Ka 1.8x10⁻⁴).",
                maxVol: 55,
                flow: 'up',
                indicator: { valid: ['phenolphthalein'], reason: "Weak Acid/Strong Base. Basic equivalence point." },
                steps: [
                    { q: "<strong>Q1:</strong> Calculate start pH (Ka = 1.8×10<sup>-4</sup>).", a: "<strong>pH ≈ 2.4</strong><br>Lower than ethanoic acid.", dataPoints: [{x:0, y:2.4}] },
                    { q: "<strong>Q2:</strong> Calculate V<sub>eq</sub> (Equal concs).", a: "<strong>V = 25.0 cm³</strong>", guideLine: [{x:25, y:0}, {x:25, y:14}] },
                    { q: "<strong>Q3:</strong> pH at Half-Equivalence (12.5 cm³)?", a: "<strong>pH = 3.74</strong><br>pH = pK<sub>a</sub>.", dataPoints: [{x:5, y:3.1}, {x:12.5, y:3.74}, {x:22, y:4.8}] },
                    { q: "<strong>Q4:</strong> Equivalence pH?", a: "<strong>pH ≈ 8.3 (Basic)</strong>", dataPoints: [{x:24.5, y:6}, {x:25, y:8.3}, {x:25.5, y:11}] },
                    { q: "<strong>Q5:</strong> Final pH?", a: "<strong>pH ≈ 13.0</strong>", dataPoints: [{x:35, y:12.5}, {x:50, y:13}] }
                ]
            },
             {
                id: "test3",
                title: "Test: Dilute Ammonia + HCl",
                desc: "Challenge: Large volume, low concentration (0.05M).",
                maxVol: 100,
                flow: 'down',
                indicator: { valid: ['methyl_orange', 'methyl_red'], reason: "Strong Acid vs Weak Base. Equivalence is acidic." },
                steps: [
                    { q: "<strong>Q1:</strong> 50 cm³ 0.05 M Weak Base. Estimate Start pH.", a: "<strong>pH ≈ 11.0</strong>", dataPoints: [{x:0, y:11}] },
                    { q: "<strong>Q2:</strong> Calculate V<sub>eq</sub> for 50 cm³ analyte.", a: "<strong>V = 50.0 cm³</strong>", guideLine: [{x:50, y:0}, {x:50, y:14}] },
                    { q: "<strong>Q3:</strong> Buffer region center?", a: "<strong>At 25 cm³</strong><br>pH = 9.26.", dataPoints: [{x:10, y:10}, {x:25, y:9.26}, {x:45, y:8}] },
                    { q: "<strong>Q4:</strong> Equivalence pH?", a: "<strong>pH ≈ 5.5 (Acidic)</strong>", dataPoints: [{x:49, y:7}, {x:50, y:5.5}, {x:51, y:3}] },
                    { q: "<strong>Q5:</strong> Final pH?", a: "<strong>pH ≈ 1.3</strong>", dataPoints: [{x:75, y:1.5}, {x:100, y:1.3}] }
                ]
            },
             {
                id: "test4",
                title: "Test: Methylamine + HCl",
                desc: "Challenge: Stronger weak base (pKb 3.36).",
                maxVol: 40,
                flow: 'down',
                indicator: { valid: ['methyl_orange', 'methyl_red'], reason: "Acidic equivalence point." },
                steps: [
                    { q: "<strong>Q1:</strong> Methylamine (pKb 3.36). Start pH?", a: "<strong>pH ≈ 11.8</strong>", dataPoints: [{x:0, y:11.8}] },
                    { q: "<strong>Q2:</strong> V<sub>eq</sub>? Flask 20cm³ 0.1M, Burette 0.2M.", a: "<strong>V = 10.0 cm³</strong>", guideLine: [{x:10, y:0}, {x:10, y:14}] },
                    { q: "<strong>Q3:</strong> Half-Equiv pH?", a: "<strong>pH = 10.64</strong>", dataPoints: [{x:2, y:11}, {x:5, y:10.64}, {x:9, y:9.5}] },
                    { q: "<strong>Q4:</strong> Equivalence pH?", a: "<strong>pH ≈ 5.8</strong>", dataPoints: [{x:9.8, y:8}, {x:10, y:5.8}, {x:10.2, y:2}] },
                    { q: "<strong>Q5:</strong> Final pH?", a: "<strong>pH ≈ 0.7</strong>", dataPoints: [{x:20, y:0.8}, {x:30, y:0.7}] }
                ]
            }
        ]
    };

    const indicators = {
        methyl_orange: { 
            rangeLow: 3.1, rangeHigh: 4.4,
            colorLow: 'rgba(239, 68, 68, 0.4)', colorHigh: 'rgba(234, 179, 8, 0.4)'
        },
        methyl_red: { 
            rangeLow: 4.4, rangeHigh: 6.2,
            colorLow: 'rgba(220, 38, 38, 0.4)', colorHigh: 'rgba(250, 204, 21, 0.4)'
        },
        bromothymol_blue: { 
            rangeLow: 6.0, rangeHigh: 7.6,
            colorLow: 'rgba(253, 224, 71, 0.4)', colorHigh: 'rgba(59, 130, 246, 0.4)'
        },
        phenolphthalein: { 
            rangeLow: 8.3, rangeHigh: 10.0,
            colorLow: 'rgba(255, 255, 255, 0.1)', colorHigh: 'rgba(236, 72, 153, 0.4)'
        },
        none: {}
    };

    let chartInstance = null;
    let currentScenarioData = null;
    let currentDataPoints = [];
    let currentMode = 'tutorial';
    let currentIndicatorRange = null;

    // --- FUNCTIONS ---
    function initChart() {
        Chart.register(indicatorPlugin);
        const ctx = document.getElementById('titrationChart').getContext('2d');
        
        // Font setup for chart
        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.color = "#6b7280";

        chartInstance = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [
                    { 
                        label: 'pH Curve', 
                        data: [], 
                        showLine: true, 
                        borderColor: '#4f46e5', // Primary var
                        backgroundColor: '#4f46e5',
                        borderWidth: 3, 
                        tension: 0.35, 
                        pointRadius: 4, 
                        pointBackgroundColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverRadius: 6,
                        order: 1 
                    },
                    { 
                        label: 'Equivalence Vol', 
                        data: [], 
                        showLine: true, 
                        borderColor: '#94a3b8', 
                        borderDash: [6, 6], 
                        borderWidth: 2, 
                        pointRadius: 0, 
                        order: 2 
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 1000,
                    easing: 'easeOutQuart'
                },
                scales: {
                    x: { 
                        type: 'linear', 
                        position: 'bottom', 
                        title: { display: true, text: 'Volume Added (cm³)', font: {weight:'600'} }, 
                        min: 0, 
                        max: 55, 
                        grid: { color: '#f3f4f6' } 
                    },
                    y: { 
                        title: { display: true, text: 'pH', font: {weight:'600'} }, 
                        min: 0, 
                        max: 14, 
                        ticks: { stepSize: 1 }, 
                        grid: { color: '#f3f4f6' } 
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#1f2937',
                        padding: 12,
                        titleFont: { weight: 'bold' },
                        bodyFont: { size: 13 },
                        cornerRadius: 8,
                        displayColors: false,
                        callbacks: { label: (ctx) => `Vol: ${ctx.parsed.x} cm³, pH: ${ctx.parsed.y}` }
                    }
                }
            }
        });
    }

    function setMode(mode) {
        currentMode = mode;
        document.body.classList.toggle('test-mode', mode === 'test');
        document.getElementById('btnTutorial').classList.toggle('active', mode === 'tutorial');
        document.getElementById('btnTest').classList.toggle('active', mode === 'test');
        
        const curveColor = mode === 'test' ? '#d97706' : '#4f46e5';
        if(chartInstance) {
            chartInstance.data.datasets[0].borderColor = curveColor;
            chartInstance.data.datasets[0].backgroundColor = curveColor;
            chartInstance.update();
        }

        populateSelect();
        loadScenario();
    }

    function populateSelect() {
        const select = document.getElementById('scenarioSelect');
        select.innerHTML = '';
        allScenarios[currentMode].forEach((sc, index) => {
            const opt = document.createElement('option');
            opt.value = index;
            opt.text = sc.title;
            select.appendChild(opt);
        });
    }

    function loadScenario() {
        const index = document.getElementById('scenarioSelect').value || 0;
        currentScenarioData = allScenarios[currentMode][index];
        
        document.getElementById('scenarioDescription').innerText = currentScenarioData.desc || "";

        currentIndicatorRange = null;

        if(chartInstance) {
            chartInstance.options.scales.x.max = currentScenarioData.maxVol || 55;
            chartInstance.data.datasets[0].data = [];
            chartInstance.data.datasets[1].data = [];
            chartInstance.update();
        }

        // Reset Steps
        for (let i = 1; i <= 6; i++) {
            const card = document.getElementById(`step${i}`);
            card.classList.remove('active', 'completed');
            
            const ans = document.getElementById(`ans${i}`);
            ans.style.display = 'none';
            ans.innerHTML = "";

            if(i <= 5) {
                document.getElementById(`q${i}`).innerHTML = currentScenarioData.steps[i-1].q;
                card.querySelector('.action-btn').style.display = "flex";
            } else {
                document.getElementById('indicatorChoice').value = "";
                card.querySelector('.action-btn').style.display = "flex";
            }
        }
        
        document.getElementById('step1').classList.add('active');
        currentDataPoints = [];
    }

    function reveal(stepNum) {
        const stepData = currentScenarioData.steps[stepNum - 1];
        const ansDiv = document.getElementById(`ans${stepNum}`);
        
        ansDiv.innerHTML = stepData.a;
        ansDiv.style.display = 'block';

        if (stepData.dataPoints) {
            stepData.dataPoints.forEach(p => currentDataPoints.push(p));
            currentDataPoints.sort((a, b) => a.x - b.x);
            chartInstance.data.datasets[0].data = [...currentDataPoints];
        }

        if (stepData.guideLine) {
            chartInstance.data.datasets[1].data = stepData.guideLine;
        }
        
        chartInstance.update();

        const currentCard = document.getElementById(`step${stepNum}`);
        currentCard.classList.remove('active');
        currentCard.classList.add('completed');
        currentCard.querySelector('.action-btn').style.display = 'none';

        if (stepNum < 6) {
            const nextCard = document.getElementById(`step${stepNum + 1}`);
            nextCard.classList.add('active');
            nextCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
    
    // NEW: Function to instantly preview the indicator band
    function previewIndicator() {
        const choice = document.getElementById('indicatorChoice').value;
        
        if (!choice) {
            currentIndicatorRange = null;
        } else if (choice !== 'none') {
            const ind = indicators[choice];
            currentIndicatorRange = {
                low: ind.rangeLow,
                high: ind.rangeHigh,
                colorLow: ind.colorLow,
                colorHigh: ind.colorHigh
            };
        } else {
            currentIndicatorRange = null;
        }
        
        if (chartInstance) {
            chartInstance.update();
        }
    }

    function checkIndicator() {
        const choice = document.getElementById('indicatorChoice').value;
        const ansDiv = document.getElementById('ans6');
        const correctOptions = currentScenarioData.indicator.valid;
        
        if (!choice) return;

        // Note: The band is already drawn by previewIndicator()
        // We leave it there so the user can see it alongside the feedback
        
        const isCorrect = correctOptions.includes(choice);
        
        let html = "";
        if (isCorrect) {
            html = `<div style="color: var(--success); font-weight:700;">✓ Correct Choice</div>`;
        } else {
            html = `<div style="color: var(--error); font-weight:700;">✗ Incorrect Choice</div>`;
        }
        html += `<div style="margin-top:4px; font-size:0.9rem;">${currentScenarioData.indicator.reason}</div>`;

        ansDiv.innerHTML = html;
        ansDiv.style.display = 'block';

        const currentCard = document.getElementById('step6');
        currentCard.classList.remove('active');
        if(isCorrect) currentCard.classList.add('completed');
        currentCard.querySelector('.action-btn').style.display = 'none';
    }

    function resetTool() { loadScenario(); }

    window.onload = function() {
        initChart();
        populateSelect();
        loadScenario();
    };

</script>
</body>
</html>
