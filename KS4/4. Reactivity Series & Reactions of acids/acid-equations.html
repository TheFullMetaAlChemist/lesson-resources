<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Acids → Salts Practice (GCSE Foundation)</title>
  <style>
    :root{
      --bg: #f6f8fb;
      --panel: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --border: #e5e7eb;
      --accent: #2563eb;
      --accent-2: #0ea5e9;
      --good: #16a34a;
      --bad: #dc2626;
      --shadow: 0 10px 25px rgba(17,24,39,.08);
      --radius: 16px;
      --focus: 0 0 0 3px rgba(37,99,235,.25);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing: border-box; }
    body{
      margin:0;
      font-family: var(--font);
      color: var(--text);
      background: radial-gradient(900px 500px at 20% -10%, rgba(14,165,233,.15), transparent 60%),
                  radial-gradient(900px 500px at 90% 0%, rgba(37,99,235,.12), transparent 60%),
                  var(--bg);
    }

    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px 14px 40px;
    }

    header{
      display:flex;
      gap: 14px;
      align-items:flex-start;
      justify-content: space-between;
      flex-wrap: wrap;
      margin-bottom: 14px;
    }

    .title{
      display:flex;
      flex-direction: column;
      gap: 6px;
    }

    h1{
      margin:0;
      font-size: clamp(20px, 2.4vw, 30px);
      letter-spacing: -0.02em;
    }

    .subtitle{
      margin:0;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.4;
      max-width: 62ch;
    }

    .pillbar{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items:center;
      justify-content:flex-end;
    }

    .pill{
      background: rgba(37,99,235,.08);
      border: 1px solid rgba(37,99,235,.18);
      color: #0b2e7a;
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12.5px;
      line-height: 1;
      white-space: nowrap;
    }

    nav{
      background: rgba(255,255,255,.75);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding: 10px;
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 14px;
    }

    .tab{
      appearance: none;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 14px;
      cursor:pointer;
      transition: transform .05s ease, border-color .15s ease, background .15s ease;
    }
    .tab:hover{ border-color: rgba(37,99,235,.35); }
    .tab:active{ transform: translateY(1px); }
    .tab[aria-selected="true"]{
      border-color: rgba(37,99,235,.45);
      background: rgba(37,99,235,.08);
      color: #0b2e7a;
      font-weight: 600;
    }
    .tab:focus-visible{ outline: none; box-shadow: var(--focus); }

    .panel{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 14px;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      background: #fff;
    }

    .card h2{
      font-size: 16px;
      margin: 0 0 8px;
      letter-spacing: -.01em;
    }

    .rules{
      margin: 0;
      padding-left: 18px;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.5;
    }

    .rules li{ margin: 6px 0; }

    .example{
      display:grid;
      gap: 10px;
    }

    .equation{
      border: 1px dashed rgba(37,99,235,.25);
      background: rgba(37,99,235,.06);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 14px;
      line-height: 1.4;
    }

    .equation strong{ color: #0b2e7a; }

    .step{
      display:flex;
      gap: 10px;
      align-items:flex-start;
      font-size: 14px;
      color: var(--text);
      line-height: 1.4;
    }
    .badge{
      width: 26px;
      height: 26px;
      flex: 0 0 26px;
      border-radius: 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(14,165,233,.12);
      border: 1px solid rgba(14,165,233,.22);
      color: #045e7a;
      font-weight: 700;
      font-size: 13px;
    }

    .questionsHeader{
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content: space-between;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .actions{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items:center;
      justify-content:flex-end;
    }

    button{
      appearance:none;
      border: 1px solid var(--border);
      background:#fff;
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 14px;
      cursor:pointer;
      transition: transform .05s ease, border-color .15s ease, background .15s ease;
    }
    button:hover{ border-color: rgba(37,99,235,.35); }
    button:active{ transform: translateY(1px); }
    button.primary{
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }
    button.primary:hover{ background: #1d4ed8; border-color: #1d4ed8; }
    button:focus-visible{ outline:none; box-shadow: var(--focus); }

    .status{
      font-size: 13px;
      color: var(--muted);
    }

    .qList{
      display:grid;
      gap: 10px;
    }

    .q{
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      background: #fff;
    }

    .qTop{
      display:flex;
      gap: 10px;
      align-items:flex-start;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .qTitle{
      display:flex;
      gap: 10px;
      align-items:flex-start;
    }

    .qNum{
      width: 28px;
      height: 28px;
      border-radius: 10px;
      background: rgba(37,99,235,.08);
      border: 1px solid rgba(37,99,235,.2);
      color: #0b2e7a;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 700;
      font-size: 13px;
      flex: 0 0 28px;
    }

    .reactants{
      margin: 0;
      font-size: 14px;
      line-height: 1.45;
    }

    .hint{
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }

    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 720px){
      .controls{ grid-template-columns: 1fr; }
    }

    label{
      display:block;
      font-size: 12.5px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    select{
      width:100%;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 14px;
      color: var(--text);
    }
    select:focus-visible{ outline:none; box-shadow: var(--focus); border-color: rgba(37,99,235,.45); }

    .feedback{
      margin-top: 10px;
      display:flex;
      gap: 10px;
      align-items:flex-start;
      justify-content: space-between;
      flex-wrap: wrap;
      border-top: 1px solid var(--border);
      padding-top: 10px;
    }

    .msg{
      font-size: 13.5px;
      line-height: 1.4;
      margin: 0;
    }

    .tag{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--muted);
      white-space: nowrap;
    }
    .tag.good{
      border-color: rgba(22,163,74,.25);
      background: rgba(22,163,74,.08);
      color: #0f6b2a;
    }
    .tag.bad{
      border-color: rgba(220,38,38,.25);
      background: rgba(220,38,38,.06);
      color: #8b1b1b;
    }

    .sr-only{
      position:absolute;
      width:1px;height:1px;
      padding:0;margin:-1px;
      overflow:hidden;clip:rect(0,0,0,0);
      white-space:nowrap;border:0;
    }

    footer{
      margin-top: 14px;
      color: var(--muted);
      font-size: 12.5px;
      line-height: 1.4;
    }

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      background: rgba(31,41,55,.06);
      border: 1px solid rgba(31,41,55,.12);
      padding: 2px 6px;
      border-radius: 8px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Acids → Salts Practice</h1>
        <p class="subtitle">
          Choose the correct <strong>salt</strong> and the other product(s).
          Remember: the <strong>acid decides the salt ending</strong> (chloride / nitrate / sulfate).
        </p>
      </div>
      <div class="pillbar" aria-label="Key rules">
        <span class="pill">Hydrochloric → <strong>chloride</strong></span>
        <span class="pill">Nitric → <strong>nitrate</strong></span>
        <span class="pill">Sulfuric → <strong>sulfate</strong></span>
      </div>
    </header>

    <nav role="tablist" aria-label="Practice sections" id="tabs"></nav>

    <main class="panel" id="main" tabindex="-1">
      <div class="grid">
        <section class="card" aria-labelledby="sectionTitle">
          <h2 id="sectionTitle">Section</h2>
          <ul class="rules" id="rules"></ul>

          <div class="example" aria-label="Worked example" style="margin-top:12px;">
            <h2 style="margin:0 0 6px;">Worked example</h2>
            <div class="equation" id="exampleEquation"></div>
            <div class="step"><span class="badge">1</span><div id="exStep1"></div></div>
            <div class="step"><span class="badge">2</span><div id="exStep2"></div></div>
            <div class="step"><span class="badge">3</span><div id="exStep3"></div></div>
            <div class="equation" id="exampleAnswer" style="border-style: solid;"></div>
          </div>
        </section>

        <section class="card" aria-label="Practice questions">
          <div class="questionsHeader">
            <div>
              <h2 style="margin:0;">Practice</h2>
              <div class="status" id="status">0 / 0 checked</div>
            </div>
            <div class="actions">
              <button class="primary" id="checkAllBtn" type="button">Check all</button>
              <button id="resetBtn" type="button">Reset</button>
              <button id="revealBtn" type="button" title="Shows the correct answers for learning (not for tests).">Reveal answers</button>
            </div>
          </div>

          <div class="qList" id="qList"></div>

          <footer>
            Tip: Use <span class="kbd">Tab</span> to move through dropdowns. Try to say the pattern out loud:
            “Acid + … makes …”
          </footer>
        </section>
      </div>
    </main>

    <div class="sr-only" id="live" aria-live="polite" aria-atomic="true"></div>
  </div>

<script>
/* -----------------------------
   DATA (content)
--------------------------------*/

const ACID_TO_ENDING = {
  "Hydrochloric acid": "chloride",
  "Nitric acid": "nitrate",
  "Sulfuric acid": "sulfate",
};

const EXTRAS = ["hydrogen", "water", "carbon dioxide"];

const SECTIONS = [
  {
    id: "metals",
    label: "Metals → Hydrogen",
    rules: [
      "Reaction pattern: <strong>Acid + metal → salt + hydrogen</strong>.",
      "The <strong>acid</strong> gives the salt ending (chloride / nitrate / sulfate).",
      "The <strong>metal name</strong> becomes the first part of the salt name.",
    ],
    workedExample: {
      reactants: ["Hydrochloric acid", "magnesium"],
      typeHint: "metal",
      steps: [
        "Hydrochloric acid makes <strong>chlorides</strong>.",
        "Magnesium gives the first part: <strong>magnesium</strong> chloride.",
        "Metals produce <strong>hydrogen</strong> gas.",
      ],
    },
    questions: [
      { a: "Hydrochloric acid", b: "zinc", salt: "zinc chloride", extras: ["hydrogen"] },
      { a: "Hydrochloric acid", b: "iron", salt: "iron chloride", extras: ["hydrogen"] },
      { a: "Hydrochloric acid", b: "magnesium", salt: "magnesium chloride", extras: ["hydrogen"] },
      { a: "Hydrochloric acid", b: "aluminium", salt: "aluminium chloride", extras: ["hydrogen"] },
      { a: "Hydrochloric acid", b: "calcium", salt: "calcium chloride", extras: ["hydrogen"] },

      { a: "Nitric acid", b: "zinc", salt: "zinc nitrate", extras: ["hydrogen"] },
      { a: "Nitric acid", b: "iron", salt: "iron nitrate", extras: ["hydrogen"] },
      { a: "Nitric acid", b: "magnesium", salt: "magnesium nitrate", extras: ["hydrogen"] },
      { a: "Nitric acid", b: "aluminium", salt: "aluminium nitrate", extras: ["hydrogen"] },
      { a: "Nitric acid", b: "calcium", salt: "calcium nitrate", extras: ["hydrogen"] },

      { a: "Sulfuric acid", b: "zinc", salt: "zinc sulfate", extras: ["hydrogen"] },
      { a: "Sulfuric acid", b: "iron", salt: "iron sulfate", extras: ["hydrogen"] },
      { a: "Sulfuric acid", b: "magnesium", salt: "magnesium sulfate", extras: ["hydrogen"] },
      { a: "Sulfuric acid", b: "aluminium", salt: "aluminium sulfate", extras: ["hydrogen"] },
      { a: "Sulfuric acid", b: "calcium", salt: "calcium sulfate", extras: ["hydrogen"] },
    ]
  },

  {
    id: "hydroxides",
    label: "Hydroxides → Water",
    rules: [
      "Reaction pattern: <strong>Acid + hydroxide → salt + water</strong>.",
      "The <strong>acid</strong> gives the salt ending (chloride / nitrate / sulfate).",
      "The metal in the hydroxide gives the first part of the salt name.",
    ],
    workedExample: {
      reactants: ["Sulfuric acid", "sodium hydroxide"],
      typeHint: "hydroxide",
      steps: [
        "Sulfuric acid makes <strong>sulfates</strong>.",
        "Sodium hydroxide gives the first part: <strong>sodium</strong> sulfate.",
        "Hydroxides produce <strong>water</strong>.",
      ],
    },
    questions: [
      { a: "Hydrochloric acid", b: "sodium hydroxide", salt: "sodium chloride", extras: ["water"] },
      { a: "Hydrochloric acid", b: "potassium hydroxide", salt: "potassium chloride", extras: ["water"] },
      { a: "Hydrochloric acid", b: "calcium hydroxide", salt: "calcium chloride", extras: ["water"] },
      { a: "Hydrochloric acid", b: "magnesium hydroxide", salt: "magnesium chloride", extras: ["water"] },

      { a: "Nitric acid", b: "sodium hydroxide", salt: "sodium nitrate", extras: ["water"] },
      { a: "Nitric acid", b: "potassium hydroxide", salt: "potassium nitrate", extras: ["water"] },
      { a: "Nitric acid", b: "calcium hydroxide", salt: "calcium nitrate", extras: ["water"] },
      { a: "Nitric acid", b: "magnesium hydroxide", salt: "magnesium nitrate", extras: ["water"] },

      { a: "Sulfuric acid", b: "sodium hydroxide", salt: "sodium sulfate", extras: ["water"] },
      { a: "Sulfuric acid", b: "potassium hydroxide", salt: "potassium sulfate", extras: ["water"] },
      { a: "Sulfuric acid", b: "calcium hydroxide", salt: "calcium sulfate", extras: ["water"] },
      { a: "Sulfuric acid", b: "magnesium hydroxide", salt: "magnesium sulfate", extras: ["water"] },
    ]
  },

  {
    id: "oxides",
    label: "Oxides → Water",
    rules: [
      "Reaction pattern: <strong>Acid + metal oxide → salt + water</strong>.",
      "The <strong>acid</strong> gives the salt ending (chloride / nitrate / sulfate).",
      "The metal in the oxide gives the first part of the salt name.",
    ],
    workedExample: {
      reactants: ["Nitric acid", "copper oxide"],
      typeHint: "oxide",
      steps: [
        "Nitric acid makes <strong>nitrates</strong>.",
        "Copper oxide gives the first part: <strong>copper</strong> nitrate.",
        "Oxides produce <strong>water</strong>.",
      ],
    },
    questions: [
      { a: "Hydrochloric acid", b: "copper oxide", salt: "copper chloride", extras: ["water"] },
      { a: "Hydrochloric acid", b: "magnesium oxide", salt: "magnesium chloride", extras: ["water"] },
      { a: "Hydrochloric acid", b: "calcium oxide", salt: "calcium chloride", extras: ["water"] },
      { a: "Hydrochloric acid", b: "zinc oxide", salt: "zinc chloride", extras: ["water"] },
      { a: "Hydrochloric acid", b: "iron oxide", salt: "iron chloride", extras: ["water"] },

      { a: "Nitric acid", b: "copper oxide", salt: "copper nitrate", extras: ["water"] },
      { a: "Nitric acid", b: "magnesium oxide", salt: "magnesium nitrate", extras: ["water"] },
      { a: "Nitric acid", b: "calcium oxide", salt: "calcium nitrate", extras: ["water"] },
      { a: "Nitric acid", b: "zinc oxide", salt: "zinc nitrate", extras: ["water"] },
      { a: "Nitric acid", b: "iron oxide", salt: "iron nitrate", extras: ["water"] },

      { a: "Sulfuric acid", b: "copper oxide", salt: "copper sulfate", extras: ["water"] },
      { a: "Sulfuric acid", b: "magnesium oxide", salt: "magnesium sulfate", extras: ["water"] },
      { a: "Sulfuric acid", b: "calcium oxide", salt: "calcium sulfate", extras: ["water"] },
      { a: "Sulfuric acid", b: "zinc oxide", salt: "zinc sulfate", extras: ["water"] },
      { a: "Sulfuric acid", b: "iron oxide", salt: "iron sulfate", extras: ["water"] },
    ]
  },

  {
    id: "carbonates",
    label: "Carbonates → CO₂",
    rules: [
      "Reaction pattern: <strong>Acid + carbonate → salt + water + carbon dioxide</strong>.",
      "The <strong>acid</strong> gives the salt ending (chloride / nitrate / sulfate).",
      "The metal in the carbonate gives the first part of the salt name.",
    ],
    workedExample: {
      reactants: ["Hydrochloric acid", "calcium carbonate"],
      typeHint: "carbonate",
      steps: [
        "Hydrochloric acid makes <strong>chlorides</strong>.",
        "Calcium carbonate gives the first part: <strong>calcium</strong> chloride.",
        "Carbonates produce <strong>water</strong> and <strong>carbon dioxide</strong>.",
      ],
    },
    questions: [
      { a: "Hydrochloric acid", b: "calcium carbonate", salt: "calcium chloride", extras: ["water","carbon dioxide"] },
      { a: "Hydrochloric acid", b: "magnesium carbonate", salt: "magnesium chloride", extras: ["water","carbon dioxide"] },
      { a: "Hydrochloric acid", b: "sodium carbonate", salt: "sodium chloride", extras: ["water","carbon dioxide"] },
      { a: "Hydrochloric acid", b: "zinc carbonate", salt: "zinc chloride", extras: ["water","carbon dioxide"] },
      { a: "Hydrochloric acid", b: "copper carbonate", salt: "copper chloride", extras: ["water","carbon dioxide"] },

      { a: "Nitric acid", b: "calcium carbonate", salt: "calcium nitrate", extras: ["water","carbon dioxide"] },
      { a: "Nitric acid", b: "magnesium carbonate", salt: "magnesium nitrate", extras: ["water","carbon dioxide"] },
      { a: "Nitric acid", b: "sodium carbonate", salt: "sodium nitrate", extras: ["water","carbon dioxide"] },
      { a: "Nitric acid", b: "zinc carbonate", salt: "zinc nitrate", extras: ["water","carbon dioxide"] },
      { a: "Nitric acid", b: "copper carbonate", salt: "copper nitrate", extras: ["water","carbon dioxide"] },

      { a: "Sulfuric acid", b: "calcium carbonate", salt: "calcium sulfate", extras: ["water","carbon dioxide"] },
      { a: "Sulfuric acid", b: "magnesium carbonate", salt: "magnesium sulfate", extras: ["water","carbon dioxide"] },
      { a: "Sulfuric acid", b: "sodium carbonate", salt: "sodium sulfate", extras: ["water","carbon dioxide"] },
      { a: "Sulfuric acid", b: "zinc carbonate", salt: "zinc sulfate", extras: ["water","carbon dioxide"] },
      { a: "Sulfuric acid", b: "copper carbonate", salt: "copper sulfate", extras: ["water","carbon dioxide"] },
    ]
  },

  {
    id: "challenge",
    label: "Final Challenge",
    rules: [
      "Mixed questions: work out the reaction type first.",
      "Then name the salt (acid decides the ending).",
      "Finally choose the correct other product(s).",
    ],
    workedExample: {
      reactants: ["Sulfuric acid", "zinc carbonate"],
      typeHint: "mixed",
      steps: [
        "Zinc carbonate is a <strong>carbonate</strong>.",
        "Sulfuric acid makes <strong>sulfates</strong> → zinc sulfate.",
        "Carbonates produce <strong>water</strong> and <strong>carbon dioxide</strong>.",
      ],
    },
    questions: [
      { a: "Hydrochloric acid", b: "zinc", salt: "zinc chloride", extras: ["hydrogen"] },
      { a: "Nitric acid", b: "magnesium oxide", salt: "magnesium nitrate", extras: ["water"] },
      { a: "Sulfuric acid", b: "calcium carbonate", salt: "calcium sulfate", extras: ["water","carbon dioxide"] },
      { a: "Hydrochloric acid", b: "sodium hydroxide", salt: "sodium chloride", extras: ["water"] },
      { a: "Nitric acid", b: "iron", salt: "iron nitrate", extras: ["hydrogen"] },
      { a: "Sulfuric acid", b: "copper oxide", salt: "copper sulfate", extras: ["water"] },
      { a: "Hydrochloric acid", b: "magnesium carbonate", salt: "magnesium chloride", extras: ["water","carbon dioxide"] },
      { a: "Nitric acid", b: "potassium hydroxide", salt: "potassium nitrate", extras: ["water"] },
      { a: "Sulfuric acid", b: "aluminium", salt: "aluminium sulfate", extras: ["hydrogen"] },
      { a: "Hydrochloric acid", b: "zinc oxide", salt: "zinc chloride", extras: ["water"] },
      { a: "Nitric acid", b: "calcium carbonate", salt: "calcium nitrate", extras: ["water","carbon dioxide"] },
      { a: "Sulfuric acid", b: "sodium carbonate", salt: "sodium sulfate", extras: ["water","carbon dioxide"] },
      { a: "Hydrochloric acid", b: "calcium", salt: "calcium chloride", extras: ["hydrogen"] },
      { a: "Nitric acid", b: "copper oxide", salt: "copper nitrate", extras: ["water"] },
      { a: "Sulfuric acid", b: "magnesium carbonate", salt: "magnesium sulfate", extras: ["water","carbon dioxide"] },
    ]
  }
];

/* -----------------------------
   HELPERS
--------------------------------*/

function capFirst(s){ return s.charAt(0).toUpperCase() + s.slice(1); }

function buildAllSalts(){
  const salts = new Set();
  for (const sec of SECTIONS){
    for (const q of sec.questions){
      salts.add(q.salt);
    }
  }
  return Array.from(salts).sort((a,b)=>a.localeCompare(b));
}
const ALL_SALTS = buildAllSalts();

function shuffle(arr){
  const a = arr.slice();
  for (let i=a.length-1; i>0; i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

/* ✅ FIX: Include sectionId in key so identical questions in different sections
      do NOT share the same "completed" state (especially Final Challenge). */
function uniqueKey(sectionId, q){
  return `${sectionId}||${q.a}||${q.b}||${q.salt}||${q.extras.join(",")}`;
}

function optionsForSalt(correctSalt){
  // Include correct + plausible distractors (same ending + some random)
  const ending = correctSalt.split(" ").slice(-1)[0]; // chloride/nitrate/sulfate
  const sameEnding = ALL_SALTS.filter(s => s.endsWith(ending) && s !== correctSalt);
  const randomOthers = ALL_SALTS.filter(s => !s.endsWith(ending));
  const picks = [
    correctSalt,
    ...shuffle(sameEnding).slice(0, 4),
    ...shuffle(randomOthers).slice(0, 4)
  ];
  const uniq = Array.from(new Set(picks)).slice(0, 9);
  return shuffle(uniq);
}

function optionsForExtra(){
  return EXTRAS.slice();
}

function announce(msg){
  const live = document.getElementById("live");
  live.textContent = msg;
}

/* -----------------------------
   UI STATE
--------------------------------*/

let currentSectionId = SECTIONS[0].id;

// store user answers by key
const state = {
  answers: new Map(),   // key -> {salt, extra1, extra2}
  checked: new Map(),   // key -> {isCorrect, message}
  reveal: false
};

/* -----------------------------
   RENDER
--------------------------------*/

function renderTabs(){
  const tabs = document.getElementById("tabs");
  tabs.innerHTML = "";

  for (const sec of SECTIONS){
    const btn = document.createElement("button");
    btn.className = "tab";
    btn.type = "button";
    btn.setAttribute("role", "tab");
    btn.id = `tab-${sec.id}`;
    btn.setAttribute("aria-controls", `panel-${sec.id}`);
    btn.setAttribute("aria-selected", String(sec.id === currentSectionId));
    btn.textContent = sec.label;

    btn.addEventListener("click", () => {
      currentSectionId = sec.id;
      state.reveal = false;
      renderAll();
      document.getElementById("main").focus();
      announce(`Section changed to ${sec.label}`);
    });

    tabs.appendChild(btn);
  }
}

function getSection(){
  return SECTIONS.find(s => s.id === currentSectionId);
}

function renderHeaderAndExample(){
  const sec = getSection();
  document.getElementById("sectionTitle").textContent = sec.label;

  const rulesEl = document.getElementById("rules");
  rulesEl.innerHTML = "";
  sec.rules.forEach(r => {
    const li = document.createElement("li");
    li.innerHTML = r;
    rulesEl.appendChild(li);
  });

  const ex = sec.workedExample;
  const eq = `${ex.reactants[0]} + ${ex.reactants[1]} → ?`;
  document.getElementById("exampleEquation").innerHTML =
    `<strong>Example:</strong> ${eq}`;

  document.getElementById("exStep1").innerHTML = ex.steps[0];
  document.getElementById("exStep2").innerHTML = ex.steps[1];
  document.getElementById("exStep3").innerHTML = ex.steps[2];

  // Compute example answer
  const acid = ex.reactants[0];
  const other = ex.reactants[1];
  const ending = ACID_TO_ENDING[acid];
  const firstWord = other.replace(/ (hydroxide|oxide|carbonate)$/, "");
  const saltName = `${firstWord} ${ending}`;

  let extras = [];
  if (ex.typeHint === "metal") extras = ["hydrogen"];
  else if (ex.typeHint === "hydroxide" || ex.typeHint === "oxide") extras = ["water"];
  else if (ex.typeHint === "carbonate") extras = ["water","carbon dioxide"];
  else {
    if (other.includes("carbonate")) extras = ["water","carbon dioxide"];
    else if (other.includes("hydroxide") || other.includes("oxide")) extras = ["water"];
    else extras = ["hydrogen"];
  }

  document.getElementById("exampleAnswer").innerHTML =
    `<strong>Answer:</strong> ${capFirst(saltName)} + ${extras.map(capFirst).join(" + ")}`;
}

function renderQuestions(){
  const sec = getSection();
  const list = document.getElementById("qList");
  list.innerHTML = "";

  sec.questions.forEach((q, idx) => {
    const key = uniqueKey(sec.id, q); // ✅ FIX
    const saved = state.answers.get(key) || { salt:"", extra1:"", extra2:"" };
    const checked = state.checked.get(key);

    const qEl = document.createElement("div");
    qEl.className = "q";
    qEl.id = `q-${idx+1}`;

    const extrasNeeded = q.extras.length;

    qEl.innerHTML = `
      <div class="qTop">
        <div class="qTitle">
          <div class="qNum" aria-hidden="true">${idx+1}</div>
          <div>
            <p class="reactants"><strong>Reactants:</strong> ${q.a} + ${q.b}</p>
            <p class="hint">Choose the <strong>salt</strong> and the other product${extrasNeeded>1 ? "s" : ""}.</p>
          </div>
        </div>
        <span class="tag" id="tag-${idx+1}">Not checked</span>
      </div>

      <div class="controls">
        <div>
          <label for="salt-${idx+1}">Salt formed</label>
          <select id="salt-${idx+1}" data-key="${key}" data-field="salt">
            <option value="">Select…</option>
          </select>
        </div>

        <div>
          <label for="extra1-${idx+1}">Other product${extrasNeeded>1 ? " (1)" : ""}</label>
          <select id="extra1-${idx+1}" data-key="${key}" data-field="extra1">
            <option value="">Select…</option>
          </select>
        </div>

        <div>
          <label for="extra2-${idx+1}">Other product (2)</label>
          <select id="extra2-${idx+1}" data-key="${key}" data-field="extra2">
            <option value="">Select…</option>
          </select>
        </div>
      </div>

      <div class="feedback">
        <p class="msg" id="msg-${idx+1}">—</p>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button type="button" data-check-one="${idx+1}" class="checkOneBtn">Check</button>
          <button type="button" data-clear-one="${idx+1}" class="clearOneBtn">Clear</button>
        </div>
      </div>
    `;

    list.appendChild(qEl);

    // Populate dropdown options
    const saltSel = qEl.querySelector(`#salt-${idx+1}`);
    const saltOptions = optionsForSalt(q.salt);
    saltOptions.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s;
      opt.textContent = capFirst(s);
      saltSel.appendChild(opt);
    });

    const extra1Sel = qEl.querySelector(`#extra1-${idx+1}`);
    const extra2Sel = qEl.querySelector(`#extra2-${idx+1}`);

    optionsForExtra().forEach(e => {
      const opt1 = document.createElement("option");
      opt1.value = e;
      opt1.textContent = capFirst(e);
      extra1Sel.appendChild(opt1);

      const opt2 = document.createElement("option");
      opt2.value = e;
      opt2.textContent = capFirst(e);
      extra2Sel.appendChild(opt2);
    });

    if (extrasNeeded < 2){
      extra2Sel.value = "";
      extra2Sel.disabled = true;
      extra2Sel.closest("div").style.opacity = "0.55";
      extra2Sel.closest("div").style.pointerEvents = "none";
    } else {
      extra2Sel.disabled = false;
      extra2Sel.closest("div").style.opacity = "1";
      extra2Sel.closest("div").style.pointerEvents = "auto";
    }

    // Restore saved answers
    if (saved.salt) saltSel.value = saved.salt;
    if (saved.extra1) extra1Sel.value = saved.extra1;
    if (saved.extra2) extra2Sel.value = saved.extra2;

    // If reveal mode, fill correct answers (for THIS section only)
    if (state.reveal){
      saltSel.value = q.salt;
      extra1Sel.value = q.extras[0] || "";
      if (extrasNeeded > 1) extra2Sel.value = q.extras[1] || "";
      state.answers.set(key, {
        salt: q.salt,
        extra1: q.extras[0] || "",
        extra2: q.extras[1] || ""
      });
    }

    applyCheckedUI(idx+1, q, checked);
  });

  // wire events
  list.querySelectorAll("select").forEach(sel => {
    sel.addEventListener("change", (e) => {
      const key = e.target.dataset.key;
      const field = e.target.dataset.field;
      const current = state.answers.get(key) || { salt:"", extra1:"", extra2:"" };
      current[field] = e.target.value;
      state.answers.set(key, current);
      state.checked.delete(key); // uncheck if changed
      updateStatus();
    });
  });

  list.querySelectorAll(".checkOneBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      const n = Number(btn.dataset.checkOne);
      checkOne(n);
    });
  });

  list.querySelectorAll(".clearOneBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      const n = Number(btn.dataset.clearOne);
      clearOne(n);
    });
  });

  updateStatus();
}

function applyCheckedUI(n, q, checked){
  const tag = document.getElementById(`tag-${n}`);
  const msg = document.getElementById(`msg-${n}`);

  if (!checked){
    tag.className = "tag";
    tag.textContent = "Not checked";
    msg.textContent = "—";
    return;
  }

  if (checked.isCorrect){
    tag.className = "tag good";
    tag.textContent = "Correct";
    msg.innerHTML = `✅ ${checked.message}`;
  } else {
    tag.className = "tag bad";
    tag.textContent = "Not quite";
    msg.innerHTML = `❌ ${checked.message}`;
  }
}

function updateStatus(){
  const sec = getSection();
  const total = sec.questions.length;
  let checkedCount = 0;
  let correctCount = 0;

  sec.questions.forEach(q => {
    const key = uniqueKey(sec.id, q); // ✅ FIX
    const c = state.checked.get(key);
    if (c){
      checkedCount++;
      if (c.isCorrect) correctCount++;
    }
  });

  document.getElementById("status").textContent =
    `${checkedCount} / ${total} checked • ${correctCount} correct`;
}

function checkOne(n){
  const sec = getSection();
  const q = sec.questions[n-1];
  const key = uniqueKey(sec.id, q); // ✅ FIX

  const ans = state.answers.get(key) || { salt:"", extra1:"", extra2:"" };
  const extrasNeeded = q.extras.length;

  if (!ans.salt || !ans.extra1 || (extrasNeeded > 1 && !ans.extra2)){
    state.checked.set(key, {
      isCorrect: false,
      message: `Select a salt and the required other product${extrasNeeded>1 ? "s" : ""} first.`
    });
    applyCheckedUI(n, q, state.checked.get(key));
    updateStatus();
    announce(`Question ${n}: incomplete`);
    return;
  }

  const saltOk = ans.salt === q.salt;

  let extrasOk = false;
  if (extrasNeeded === 1){
    extrasOk = ans.extra1 === q.extras[0];
  } else {
    const chosen = [ans.extra1, ans.extra2].sort().join("|");
    const correct = q.extras.slice().sort().join("|");
    extrasOk = chosen === correct;
  }

  if (saltOk && extrasOk){
    state.checked.set(key, {
      isCorrect: true,
      message: `Well done: <strong>${capFirst(q.salt)}</strong> + ${q.extras.map(capFirst).join(" + ")}.`
    });
  } else {
    const acidEnding = ACID_TO_ENDING[q.a];
    const baseMetal = q.b.replace(/ (hydroxide|oxide|carbonate)$/, "");
    const hintParts = [];
    if (!saltOk){
      hintParts.push(`Check the salt ending: <strong>${q.a}</strong> → <strong>${acidEnding}</strong>.`);
      hintParts.push(`The first part comes from <strong>${baseMetal}</strong>.`);
    }
    if (!extrasOk){
      if (q.b.includes("carbonate")){
        hintParts.push(`Carbonates make <strong>water</strong> and <strong>carbon dioxide</strong>.`);
      } else if (q.b.includes("hydroxide") || q.b.includes("oxide")){
        hintParts.push(`Hydroxides/oxides make <strong>water</strong>.`);
      } else {
        hintParts.push(`Metals make <strong>hydrogen</strong>.`);
      }
    }

    state.checked.set(key, {
      isCorrect: false,
      message: hintParts.join(" ")
    });
  }

  applyCheckedUI(n, q, state.checked.get(key));
  updateStatus();
  announce(`Question ${n} checked`);
}

function clearOne(n){
  const sec = getSection();
  const q = sec.questions[n-1];
  const key = uniqueKey(sec.id, q); // ✅ FIX

  state.answers.set(key, { salt:"", extra1:"", extra2:"" });
  state.checked.delete(key);

  renderQuestions();
  announce(`Question ${n} cleared`);
}

function checkAll(){
  const sec = getSection();
  for (let i=1; i<=sec.questions.length; i++){
    checkOne(i);
  }
  announce(`Checked all questions in ${sec.label}`);
}

function resetSection(){
  const sec = getSection();
  sec.questions.forEach(q => {
    const key = uniqueKey(sec.id, q); // ✅ FIX
    state.answers.set(key, { salt:"", extra1:"", extra2:"" });
    state.checked.delete(key);
  });
  state.reveal = false;
  renderQuestions();
  announce(`Reset section ${sec.label}`);
}

function revealAnswers(){
  state.reveal = true;
  const sec = getSection();
  sec.questions.forEach(q => state.checked.delete(uniqueKey(sec.id, q))); // ✅ FIX
  renderQuestions();
  announce(`Answers revealed for ${sec.label}`);
}

function renderAll(){
  renderTabs();
  renderHeaderAndExample();
  renderQuestions();

  SECTIONS.forEach(sec => {
    const tab = document.getElementById(`tab-${sec.id}`);
    if (tab) tab.setAttribute("aria-selected", String(sec.id === currentSectionId));
  });
}

/* -----------------------------
   INIT
--------------------------------*/

document.getElementById("checkAllBtn").addEventListener("click", checkAll);
document.getElementById("resetBtn").addEventListener("click", resetSection);
document.getElementById("revealBtn").addEventListener("click", revealAnswers);

renderAll();
</script>
</body>
</html>
