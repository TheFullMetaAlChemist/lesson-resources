<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Percentage Mass Calculator - Interactive Chemistry Lesson</title>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --tertiary-color: #e74c3c;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --hover-color: #1abc9c;
            --shadow: 0 4px 8px rgba(0,0,0,0.1);
            --input-border-color: #bdc3c7;
            --input-focus-border-color: var(--primary-color);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-color);
            color: var(--dark-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px;
            box-shadow: var(--shadow);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        h2 {
            font-size: 1.8rem;
            margin: 20px 0;
            color: var(--primary-color);
        }

        h3 {
            font-size: 1.5rem;
            margin: 15px 0;
            color: var(--dark-color);
        }

        p {
            margin: 15px 0;
            font-size: 1.1rem;
        }

        .screen {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .screen.active {
            display: block;
        }

        .intro-screen {
            text-align: center;
        }

        .button-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s, transform 0.2s;
            box-shadow: var(--shadow);
        }

        button:hover {
            background-color: var(--hover-color);
            transform: translateY(-2px);
        }
        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }


        button.secondary {
            background-color: var(--secondary-color);
        }
         button.secondary:hover:not(:disabled) {
             background-color: #27ae60; /* Darker green */
         }


        button.tertiary {
            background-color: var(--tertiary-color);
        }
         button.tertiary:hover:not(:disabled) {
             background-color: #c0392b; /* Darker red */
         }


        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            flex-wrap: wrap; /* Allow wrapping */
            gap: 10px; /* Add gap for wrapped buttons */
        }

        .example-container {
            background-color: rgba(52, 152, 219, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid var(--primary-color);
        }

        .step {
            margin-bottom: 15px;
            padding: 10px;
            background-color: rgba(46, 204, 113, 0.1);
            border-radius: 5px;
        }

        .formula {
            font-family: 'Courier New', Courier, monospace;
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 5px;
            display: inline-block;
            margin: 10px 0;
            font-weight: bold;
            word-wrap: break-word; /* Prevent overflow */
        }

        .question-container {
            background-color: rgba(52, 152, 219, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 5px solid var(--primary-color);
        }
        .question-container p.instructions {
            font-style: italic;
            color: var(--dark-color);
            background-color: rgba(241, 196, 15, 0.1); /* Light yellow background */
            padding: 8px;
            border-radius: 4px;
            border-left: 3px solid #f1c40f; /* Yellow border */
        }


        .answer-container {
            display: flex;
            align-items: center;
            margin-top: 15px;
            gap: 10px;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }
        .rfm-container { /* Specific container for RFM input */
             margin-top: 20px;
             padding-top: 15px;
             border-top: 1px dashed var(--input-border-color);
        }

        input[type="number"] {
            padding: 10px;
            border: 2px solid var(--input-border-color);
            border-radius: 5px;
            font-size: 1rem;
            width: 100px;
            transition: border-color 0.3s;
        }
         input[type="number"]:focus {
            outline: none;
            border-color: var(--input-focus-border-color);
         }
         input[type="number"].table-input {
            width: 80px; /* Smaller inputs for table */
            font-size: 0.95rem;
            padding: 8px;
         }
         input[type="number"].rfm-input {
             width: 120px;
         }
         input[type="number"]:disabled {
             background-color: #eee;
             cursor: not-allowed;
         }

        .feedback {
            margin-top: 15px; /* Increased space */
            font-weight: bold;
            display: none;
            width: 100%; /* Ensure feedback takes full width below input */
            padding: 10px;
            border-radius: 5px;
            border-width: 2px;
            border-style: solid;
        }

        .feedback.correct {
            color: #1a5d2a; /* Darker green */
            background-color: rgba(46, 204, 113, 0.2); /* Lighter green bg */
            border-color: var(--secondary-color);
        }

        .feedback.incorrect {
            color: #a51306; /* Darker red */
            background-color: rgba(231, 76, 60, 0.15); /* Lighter red bg */
            border-color: var(--tertiary-color);
        }
        /* Style for list within feedback */
        .feedback ul {
            margin-top: 8px;
            margin-left: 20px;
            list-style: disc;
        }
         .feedback li {
             margin-bottom: 4px;
             font-weight: normal; /* Normal weight for list items */
         }

        .hint {
            display: none;
            padding: 15px;
            background-color: rgba(241, 196, 15, 0.2);
            border-radius: 5px;
            margin-top: 10px;
            border-left: 5px solid #f1c40f;
            width: 100%; /* Ensure hint takes full width */
        }

        .difficulty-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap; /* Allow wrapping */
        }

        .difficulty-btn {
            padding: 10px 20px;
            background-color: #bdc3c7;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            border: none; /* Explicitly remove border for consistency */
            color: var(--dark-color); /* Ensure text color */
        }

        .difficulty-btn.active {
            background-color: var(--primary-color);
            color: white;
        }

        .progress-container {
            width: 100%;
            height: 10px;
            background-color: #ddd;
            border-radius: 5px;
            margin: 20px 0;
            overflow: hidden; /* Ensure progress bar stays within bounds */
        }

        .progress-bar {
            height: 100%;
            background-color: var(--secondary-color);
            border-radius: 5px;
            width: 0;
            transition: width 0.3s ease-in-out; /* Smoother transition */
        }

        .table-container {
            overflow-x: auto;
            margin: 20px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            table-layout: auto; /* Allow columns to adjust */
        }

        th, td {
            padding: 10px 8px; /* Adjusted padding */
            text-align: center; /* Center align table content */
            border-bottom: 1px solid #ddd;
            vertical-align: middle; /* Align content vertically */
        }
        th {
            background-color: var(--primary-color);
            color: white;
            font-size: 0.9rem; /* Slightly smaller header font */
            white-space: nowrap; /* Prevent header text wrapping */
        }
        td:first-child {
            text-align: left; /* Align element name left */
            font-weight: bold;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        /* Ensure footer aligns well */
        tfoot td {
            font-weight: bold;
            text-align: right;
            border-bottom: none; /* No bottom border for footer */
        }
        tfoot td:last-child {
             text-align: center;
        }


        .element-box {
            display: inline-block;
            padding: 5px 10px;
            margin-right: 5px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 3px;
        }

        .challenge-result {
            font-size: 1.2rem;
            font-weight: bold;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            text-align: center;
            display: none;
        }

        .matches {
            background-color: rgba(46, 204, 113, 0.2);
            border: 2px solid var(--secondary-color);
            color: #1a5d2a; /* Darker green text */
        }

        .does-not-match {
            background-color: rgba(231, 76, 60, 0.2);
            border: 2px solid var(--tertiary-color);
            color: #a51306; /* Darker red text */
        }


        .responsive-img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 20px auto;
        }

        /* Styles moved from the bottom */
        .css-storage-notice {
            text-align: center;
            font-size: 0.8rem;
            margin-top: 5px;
            color: #eee; /* Lightened for better contrast on primary background */
        }

        #progressSummary {
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            display: none; /* Initially hidden, shown by JS if progress exists */
        }

        #progressSummary h3 {
            margin-top: 0;
            color: var(--primary-color);
            margin-bottom: 10px; /* Added margin */
        }

        .progress-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px; /* Increased margin */
            padding: 8px 0;   /* Increased padding */
            border-bottom: 1px dashed #eee;
            font-size: 0.95rem; /* Slightly adjusted font size */
        }
         .progress-stat:last-of-type {
            border-bottom: none; /* Remove border from last item */
            margin-bottom: 15px; /* Add margin below last stat before button */
        }

        .progress-value {
            font-weight: bold;
            color: var(--secondary-color);
        }

        #clearProgressBtn {
            background-color: var(--tertiary-color); /* Use tertiary color var */
            margin-top: 10px;
            display: block; /* Make it block level */
            width: 100%;    /* Make it full width */
        }
         #clearProgressBtn:hover {
             background-color: #c0392b; /* Darker red on hover */
         }

        #startChallenge, #startMurderMystery {
            display: none; /* Initially hidden */
            margin-top: 10px; /* Add some space if they appear next to each other */
        }

        #practiceNavButtons button {
             margin-top: 10px; /* Add consistent top margin to all nav buttons */
        }

        #finalAnswerSelect {
             padding: 10px;
             border: 2px solid var(--primary-color);
             border-radius: 5px;
             font-size: 1rem;
             margin-right: 10px; /* Add space before button */
        }


    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Percentage Mass Calculator</h1>
            <p>Learn how to calculate the percentage mass of elements in chemical compounds</p>
            <div class="css-storage-notice">Your progress is automatically saved on this device</div>
        </header>

        <div id="progressSummary">
            <h3>Your Progress</h3>
            <div class="progress-stat">
                <span>Difficulty Level:</span>
                <span class="progress-value" id="savedDifficulty">Beginner</span>
            </div>
            <div class="progress-stat">
                <span>Completed Questions:</span>
                <span class="progress-value" id="completedQuestions">0 of 5</span>
            </div>
            <div class="progress-stat">
                <span>Correct Answers:</span>
                <span class="progress-value" id="correctAnswersCount">0</span>
            </div>
            <button id="clearProgressBtn">Clear Saved Progress</button>
        </div>

        <!-- Introduction Screen -->
        <div id="introScreen" class="screen active intro-screen">
             <h2>Welcome to the Interactive Chemistry Lesson!</h2>
            <p>In chemistry, understanding the composition of compounds is essential. One way we analyze compounds is by determining the percentage mass of each element.</p>

            <div class="example-container">
                <h3>What is Percentage Mass?</h3>
                <p>Percentage mass tells us what percentage of a compound's total mass is made up of a specific element.</p>
                <p>For example, in water (H<sub>2</sub>O), we can calculate what percentage of the total mass comes from hydrogen and what percentage comes from oxygen.</p>
            </div>

            <div class="example-container">
                <h3>Why is it Important?</h3>
                <ul>
                    <li>Helps identify unknown compounds</li>
                    <li>Used in quality control for manufacturing</li>
                    <li>Essential for forensic analysis</li>
                    <li>Used to verify the purity of substances</li>
                </ul>
            </div>

            <div class="example-container">
                <h3>The Formula</h3>
                <p>To calculate the percentage mass of an element in a compound:</p>
                <div class="formula">% mass = (Total mass of element in compound ÷ Formula mass of compound) × 100%</div>
                <p>Where: Total mass of element = Atomic mass of element × Number of atoms of that element</p>
            </div>

            <div class="button-container">
                <button id="startTutorial" class="secondary">Start Tutorial</button>
                <button id="startPractice">Start Practice</button>
            </div>
        </div>

        <!-- Tutorial Screen -->
        <div id="tutorialScreen" class="screen">
             <h2>Tutorial: Calculating Percentage Mass</h2>

            <div class="example-container">
                <h3>Step 1: Find the Relative Atomic Masses (R.A.M.)</h3>
                <p>First, we need the R.A.M. of each element in the compound. These are usually found in the periodic table (often rounded for GCSE level).</p>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Element</th>
                                <th>Symbol</th>
                                <th>Relative Atomic Mass (approx.)</th>
                            </tr>
                         </thead>
                         <tbody>
                            <tr><td>Hydrogen</td><td>H</td><td>1</td></tr>
                            <tr><td>Carbon</td><td>C</td><td>12</td></tr>
                            <tr><td>Nitrogen</td><td>N</td><td>14</td></tr>
                            <tr><td>Oxygen</td><td>O</td><td>16</td></tr>
                            <tr><td>Sodium</td><td>Na</td><td>23</td></tr>
                            <tr><td>Magnesium</td><td>Mg</td><td>24</td></tr>
                            <tr><td>Sulfur</td><td>S</td><td>32</td></tr>
                            <tr><td>Chlorine</td><td>Cl</td><td>35.5</td></tr>
                            <tr><td>Calcium</td><td>Ca</td><td>40</td></tr>
                            <tr><td>Iron</td><td>Fe</td><td>56</td></tr>
                            <tr><td>Copper</td><td>Cu</td><td>63.5</td></tr>
                            <tr><td>Arsenic</td><td>As</td><td>75</td></tr>
                            <tr><td>Phosphorus</td><td>P</td><td>31</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="example-container">
                <h3>Step 2: Determine the Number of Atoms of Each Element</h3>
                <p>Look at the chemical formula. Subscripts tell you the number of atoms. Pay attention to brackets!</p>
                <p>Example: H<sub>2</sub>O means 2 Hydrogen atoms (H) and 1 Oxygen atom (O).</p>
                <p>Example: Ca(OH)<sub>2</sub> means 1 Calcium atom (Ca), 2 Oxygen atoms (O), and 2 Hydrogen atoms (H) because the subscript '2' applies to everything inside the bracket.</p>
            </div>

            <div class="example-container">
                <h3>Step 3: Calculate the Total Mass of Each Element in the Compound</h3>
                <p>Multiply the R.A.M. by the number of atoms for each element:</p>
                <div class="step">
                    <p>Total mass of element = R.A.M. × Number of atoms</p>
                </div>
            </div>

            <div class="example-container">
                <h3>Step 4: Calculate the Relative Formula Mass (R.F.M.) of the Compound</h3>
                <p>Add up the total masses of all elements calculated in Step 3:</p>
                <div class="step">
                    <p>R.F.M. = Sum of (R.A.M. × Number of atoms) for all elements</p>
                </div>
            </div>

            <div class="example-container">
                <h3>Step 5: Calculate the Percentage Mass of the Desired Element</h3>
                <p>Divide the total mass of the element (from Step 3) by the R.F.M. (from Step 4) and multiply by 100:</p>
                <div class="step">
                    <p>% mass of Element X = (Total mass of Element X ÷ R.F.M. of compound) × 100%</p>
                </div>
            </div>

            <div class="example-container">
                <h3>Example 1: Percentage mass of Hydrogen in Water (H<sub>2</sub>O)</h3>
                <div class="step">
                    <p><strong>Step 1 & 2:</strong> H (R.A.M. 1, count 2), O (R.A.M. 16, count 1)</p>
                </div>
                <div class="step">
                    <p><strong>Step 3:</strong> Total mass of H = 1 × 2 = 2. Total mass of O = 16 × 1 = 16.</p>
                </div>
                <div class="step">
                    <p><strong>Step 4:</strong> R.F.M. of H<sub>2</sub>O = 2 + 16 = 18.</p>
                </div>
                <div class="step">
                    <p><strong>Step 5:</strong> % mass of H = (2 ÷ 18) × 100% = 11.1% (to 1 decimal place)</p>
                </div>
                 <p><em>(Similarly, % mass of O = (16 ÷ 18) × 100% = 88.9%)</em></p>
            </div>

            <div class="example-container">
                <h3>Example 2: Percentage mass of Carbon in Carbon Dioxide (CO<sub>2</sub>)</h3>
                 <div class="step">
                    <p><strong>Step 1 & 2:</strong> C (R.A.M. 12, count 1), O (R.A.M. 16, count 2)</p>
                </div>
                <div class="step">
                    <p><strong>Step 3:</strong> Total mass of C = 12 × 1 = 12. Total mass of O = 16 × 2 = 32.</p>
                </div>
                 <div class="step">
                    <p><strong>Step 4:</strong> R.F.M. of CO<sub>2</sub> = 12 + 32 = 44.</p>
                </div>
                <div class="step">
                    <p><strong>Step 5:</strong> % mass of C = (12 ÷ 44) × 100% = 27.3% (to 1 d.p.)</p>
                </div>
                <p><em>(Similarly, % mass of O = (32 ÷ 44) × 100% = 72.7%)</em></p>
            </div>

            <div class="nav-buttons">
                <button id="tutorialBackToIntro">Back to Intro</button>
                <button id="tutorialNext" class="secondary">Start Practice</button>
            </div>
        </div>

        <!-- Practice Screen -->
        <div id="practiceScreen" class="screen">
            <h2>Practice: Calculate Percentage Mass</h2>

            <div class="difficulty-selector">
                <button class="difficulty-btn active" data-difficulty="beginner">Beginner</button>
                <button class="difficulty-btn" data-difficulty="intermediate">Intermediate</button>
                <button class="difficulty-btn" data-difficulty="expert">Expert</button>
            </div>

            <div class="progress-container">
                <div class="progress-bar"></div>
            </div>

            <div id="questionArea">
                <!-- Questions will be loaded here by JavaScript -->
                 <p>Select a difficulty level to begin.</p>
            </div>

            <!-- Challenge Screens Container (Remains hidden until unlocked) -->
             <div id="challengeScreensContainer">
                  <div id="challengeScreen" class="screen" style="display: none;">
                     <h2>Real-World Challenge: Forensic Analysis</h2>
                     <p>You are a forensic chemist analyzing a substance found at a crime scene. You need to determine if it matches the composition of a known nerve agent (A-234, a Novichok-class compound).</p>

                     <div class="example-container">
                         <h3>Information:</h3>
                         <p>A simplified representation of A-234 has the molecular formula C<sub>7</sub>H<sub>14</sub>N<sub>2</sub>O<sub>2</sub>P.</p>
                         <p>Your task is to:</p>
                         <ol>
                             <li>Calculate the R.F.M. of A-234.</li>
                             <li>Calculate the percentage composition by mass of each element in A-234 (to 1 d.p.).</li>
                             <li>Compare with the analysis from the crime scene sample.</li>
                             <li>Determine if the sample is likely to be A-234.</li>
                         </ol>
                         <p>Use R.A.M. values: C=12, H=1, N=14, O=16, P=31.</p>
                         <p>Calculated R.F.M = (7×12) + (14×1) + (2×14) + (2×16) + (1×31) = 84+14+28+32+31 = 189</p>
                     </div>

                     <div class="example-container">
                         <h3>Crime Scene Sample Analysis:</h3>
                         <p>The forensic lab has provided the following percentage composition for the unknown sample:</p>
                         <ul>
                             <li>Carbon: 44.4%</li>
                             <li>Hydrogen: 7.4%</li>
                             <li>Nitrogen: 14.8%</li>
                             <li>Oxygen: 16.9%</li>
                             <li>Phosphorus: 16.4%</li>
                         </ul>
                     </div>

                     <div class="question-container">
                         <h3>Challenge Calculations:</h3>
                         <p>(Calculate percentages based on the R.F.M. of 189)</p>

                         <div class="step">
                             <p>1. Percentage of <strong>Carbon (C)</strong>:</p>
                             <div class="answer-container">
                                 <input type="number" step="0.1" min="0" max="100" id="carbonAnswer"> %
                                 <button class="check-btn secondary" data-element="carbon" data-correct="44.4">Check C%</button>
                                 <button class="hint-btn tertiary" data-hint="carbonHint">Hint</button>
                             </div>
                             <div id="carbonHint" class="hint">
                                 Total mass C = 7 × 12 = 84. %C = (84 / 189) × 100%.
                             </div>
                             <div class="feedback" id="carbonFeedback"></div>
                         </div>

                         <div class="step">
                             <p>2. Percentage of <strong>Hydrogen (H)</strong>:</p>
                             <div class="answer-container">
                                 <input type="number" step="0.1" min="0" max="100" id="hydrogenAnswer"> %
                                 <button class="check-btn secondary" data-element="hydrogen" data-correct="7.4">Check H%</button>
                                 <button class="hint-btn tertiary" data-hint="hydrogenHint">Hint</button>
                             </div>
                             <div id="hydrogenHint" class="hint">
                                  Total mass H = 14 × 1 = 14. %H = (14 / 189) × 100%.
                             </div>
                             <div class="feedback" id="hydrogenFeedback"></div>
                         </div>

                         <div class="step">
                             <p>3. Percentage of <strong>Nitrogen (N)</strong>:</p>
                             <div class="answer-container">
                                 <input type="number" step="0.1" min="0" max="100" id="nitrogenAnswer"> %
                                 <button class="check-btn secondary" data-element="nitrogen" data-correct="14.8">Check N%</button>
                                 <button class="hint-btn tertiary" data-hint="nitrogenHint">Hint</button>
                             </div>
                             <div id="nitrogenHint" class="hint">
                                Total mass N = 2 × 14 = 28. %N = (28 / 189) × 100%.
                             </div>
                             <div class="feedback" id="nitrogenFeedback"></div>
                         </div>

                          <div class="step">
                             <p>4. Percentage of <strong>Oxygen (O)</strong>:</p>
                             <div class="answer-container">
                                 <input type="number" step="0.1" min="0" max="100" id="oxygenAnswer"> %
                                 <button class="check-btn secondary" data-element="oxygen" data-correct="16.9">Check O%</button>
                                 <button class="hint-btn tertiary" data-hint="oxygenHint">Hint</button>
                             </div>
                             <div id="oxygenHint" class="hint">
                                 Total mass O = 2 × 16 = 32. %O = (32 / 189) × 100%.
                             </div>
                             <div class="feedback" id="oxygenFeedback"></div>
                         </div>

                         <div class="step">
                             <p>5. Percentage of <strong>Phosphorus (P)</strong>:</p>
                             <div class="answer-container">
                                 <input type="number" step="0.1" min="0" max="100" id="phosphorusAnswer"> %
                                 <button class="check-btn secondary" data-element="phosphorus" data-correct="16.4">Check P%</button>
                                 <button class="hint-btn tertiary" data-hint="phosphorusHint">Hint</button>
                             </div>
                             <div id="phosphorusHint" class="hint">
                                 Total mass P = 1 × 31 = 31. %P = (31 / 189) × 100%.
                             </div>
                             <div class="feedback" id="phosphorusFeedback"></div>
                         </div>

                         <div class="step">
                             <p>6. Based on your calculations, does the crime scene sample match A-234?</p>
                             <div class="answer-container">
                                 <button id="checkMatchBtn" class="secondary">Compare Results</button>
                             </div>
                             <div class="challenge-result" id="matchResult"></div>
                         </div>
                     </div>

                     <div class="nav-buttons">
                         <button id="challengeBackToPractice">Back to Practice</button>
                         <button id="restartChallenge" class="secondary">Restart Challenge</button>
                     </div>
                 </div>

                  <div id="murderMysteryScreen" class="screen" style="display: none;">
                     <h2>Forensic Challenge: The Poisoned Tea</h2>

                     <div class="example-container">
                         <h3>Murder Mystery Scenario</h3>
                         <p>A wealthy businessman has been found dead. Autopsy suggests poison, possibly administered in his tea. A white powder residue was found in the cup. The detective suspects arsenic trioxide (As₂O₃), a historical poison.</p>
                         <p>Your task: Analyze if the residue matches As₂O₃.</p>
                         <p>Use R.A.M. values: As=75, O=16.</p>
                     </div>

                     <div class="example-container">
                         <h3>The Evidence</h3>
                         <p>Lab analysis of the teacup powder:</p>
                         <ul>
                             <li>Contains only Arsenic (As) and Oxygen (O).</li>
                             <li>Percentage composition: Arsenic = 75.8%, Oxygen = 24.2%.</li>
                         </ul>
                     </div>

                     <div class="question-container">
                         <h3>Forensic Analysis</h3>

                         <div class="step">
                             <p>1. First, determine the formula mass of arsenic trioxide (As₂O₃):</p>
                             <div class="answer-container">
                                 <input type="number" step="any" min="0" max="500" id="formulaMassAnswer"> <!-- Allow any step -->
                                 <button class="check-btn secondary" data-element="formulaMass" data-correct="198">Check R.F.M.</button>
                                 <button class="hint-btn tertiary" data-hint="formulaMassHint">Hint</button>
                             </div>
                             <div id="formulaMassHint" class="hint">
                                 R.F.M. = (Number of As atoms × R.A.M. of As) + (Number of O atoms × R.A.M. of O) = (2 × 75) + (3 × 16)
                             </div>
                             <div class="feedback" id="formulaMassFeedback"></div>
                         </div>

                         <div class="step">
                             <p>2. Calculate the percentage by mass of <strong>Arsenic (As)</strong> in As₂O₃:</p>
                             <div class="answer-container">
                                 <input type="number" step="0.1" min="0" max="100" id="arsenicPercentAnswer"> %
                                 <button class="check-btn secondary" data-element="arsenicPercent" data-correct="75.8">Check As%</button>
                                 <button class="hint-btn tertiary" data-hint="arsenicPercentHint">Hint</button>
                             </div>
                             <div id="arsenicPercentHint" class="hint">
                                 Total mass of As = 2 × 75 = 150. R.F.M = 198. % As = (150 / 198) × 100%.
                             </div>
                             <div class="feedback" id="arsenicPercentFeedback"></div>
                         </div>

                         <div class="step">
                             <p>3. Calculate the percentage by mass of <strong>Oxygen (O)</strong> in As₂O₃:</p>
                             <div class="answer-container">
                                 <input type="number" step="0.1" min="0" max="100" id="oxygenPercentAnswer"> %
                                 <button class="check-btn secondary" data-element="oxygenPercent" data-correct="24.2">Check O%</button>
                                 <button class="hint-btn tertiary" data-hint="oxygenPercentHint">Hint</button>
                             </div>
                             <div id="oxygenPercentHint" class="hint">
                                 Total mass of O = 3 × 16 = 48. R.F.M = 198. % O = (48 / 198) × 100%. (Or 100% - %As)
                             </div>
                             <div class="feedback" id="oxygenPercentFeedback"></div>
                         </div>


                         <div class="step">
                             <p>4. Compare your calculated percentages for As₂O₃ with the lab results for the teacup sample (As=75.8%, O=24.2%). Does the teacup sample match arsenic trioxide?</p>
                             <div class="answer-container">
                                 <button id="matchYesBtn" class="secondary">Yes, it's a match</button>
                                 <button id="matchNoBtn" class="tertiary">No, it doesn't match</button>
                             </div>
                             <div class="feedback" id="matchFeedback"></div>
                             <div class="challenge-result" id="caseResult"></div>
                         </div>

                         <!-- This section remains hidden as the sample data matches As2O3 -->
                         <div id="additionalAnalysis" style="display: none;">
                             <h3>Further Investigation (If it didn't match)</h3>
                             <p>If the percentages didn't match, you would investigate other arsenic oxides, like Arsenic Pentoxide (As₂O₅).</p>
                             <div class="step">
                                 <p>Calculate the % of As in As₂O₅ (R.A.M. As=75, O=16):</p>
                                 <div class="answer-container">
                                     <input type="number" step="0.1" min="0" max="100" id="as2o5Answer"> %
                                     <button class="check-btn secondary" data-element="as2o5" data-correct="65.2">Check As% in As₂O₅</button>
                                     <button class="hint-btn tertiary" data-hint="as2o5Hint">Hint</button>
                                 </div>
                                 <div id="as2o5Hint" class="hint">
                                     R.F.M. of As₂O₅ = (2×75) + (5×16) = 150 + 80 = 230. Total As mass = 150. %As = (150/230)×100.
                                 </div>
                                 <div class="feedback" id="as2o5Feedback"></div>
                             </div>
                         </div>
                     </div>

                     <div class="nav-buttons">
                         <button id="murderBackToPractice">Back to Practice</button>
                         <button id="restartMurder" class="secondary">Restart Investigation</button>
                     </div>
                  </div>
            </div> <!-- End Challenge Screens Container -->

            <div id="practiceNavButtons" class="nav-buttons"> <!-- Moved nav buttons outside challenge screens -->
                <button id="practiceBackToIntro">Back to Intro</button>
                <button id="practiceNext" class="secondary">Next Question</button>
                <button id="startChallenge" class="tertiary">Challenge: Nerve Agent</button>
                <button id="startMurderMystery" class="tertiary">Challenge: Poisoned Tea</button>
            </div>
        </div> <!-- End Practice Screen -->

    </div> <!-- End Container -->

    <script>
        // Data for practice questions (R.A.M values: H=1, C=12, N=14, O=16, Na=23, Mg=24, S=32, Cl=35.5, Ca=40, Fe=56, Cu=63.5, P=31, As=75)
        // Added 'rfm' property to intermediate and expert questions
        const questions = {
            beginner: [ // Beginner remains the same - no table inputs needed
                {
                    id: 1, compound: "H₂O (Water)", formula: "H<sub>2</sub>O",
                    elements: [{ name: "Hydrogen", symbol: "H", count: 2, mass: 1 }, { name: "Oxygen", symbol: "O", count: 1, mass: 16 }],
                    questionElement: "Hydrogen", correctAnswer: 11.1, rfm: 18,
                    hint: "R.F.M. = (1×2) + 16 = 18. Total H mass = 1×2 = 2. %H = (2 / 18) × 100."
                },
                {
                    id: 2, compound: "CO₂ (Carbon Dioxide)", formula: "CO<sub>2</sub>",
                    elements: [{ name: "Carbon", symbol: "C", count: 1, mass: 12 }, { name: "Oxygen", symbol: "O", count: 2, mass: 16 }],
                    questionElement: "Oxygen", correctAnswer: 72.7, rfm: 44,
                    hint: "R.F.M. = 12 + (16×2) = 44. Total O mass = 16×2 = 32. %O = (32 / 44) × 100."
                },
                {
                    id: 3, compound: "NaCl (Sodium Chloride)", formula: "NaCl",
                    elements: [{ name: "Sodium", symbol: "Na", count: 1, mass: 23 }, { name: "Chlorine", symbol: "Cl", count: 1, mass: 35.5 }],
                    questionElement: "Sodium", correctAnswer: 39.3, rfm: 58.5,
                    hint: "R.F.M. = 23 + 35.5 = 58.5. Total Na mass = 23. %Na = (23 / 58.5) × 100."
                },
                {
                    id: 4, compound: "NH₃ (Ammonia)", formula: "NH<sub>3</sub>",
                    elements: [{ name: "Nitrogen", symbol: "N", count: 1, mass: 14 }, { name: "Hydrogen", symbol: "H", count: 3, mass: 1 }],
                    questionElement: "Nitrogen", correctAnswer: 82.4, rfm: 17,
                    hint: "R.F.M. = 14 + (1×3) = 17. Total N mass = 14. %N = (14 / 17) × 100."
                },
                {
                    id: 5, compound: "MgO (Magnesium Oxide)", formula: "MgO",
                    elements: [{ name: "Magnesium", symbol: "Mg", count: 1, mass: 24 }, { name: "Oxygen", symbol: "O", count: 1, mass: 16 }],
                    questionElement: "Magnesium", correctAnswer: 60.0, rfm: 40,
                    hint: "R.F.M. = 24 + 16 = 40. Total Mg mass = 24. %Mg = (24 / 40) × 100."
                }
            ],
            intermediate: [ // Requires table inputs
                 {
                    id: 6, // Unique ID
                    compound: "CaCO₃ (Calcium Carbonate)", formula: "CaCO<sub>3</sub>",
                    elements: [{ name: "Calcium", symbol: "Ca", count: 1, mass: 40 }, { name: "Carbon", symbol: "C", count: 1, mass: 12 }, { name: "Oxygen", symbol: "O", count: 3, mass: 16 }],
                    questionElement: "Calcium", correctAnswer: 40.0, rfm: 100.0,
                    hint: "Check atom counts (Ca=1, C=1, O=3). Calculate total mass for each. Sum for R.F.M. Then %Ca = (Total Ca mass / R.F.M.) × 100."
                },
                {
                    id: 7, compound: "H₂SO₄ (Sulfuric Acid)", formula: "H<sub>2</sub>SO<sub>4</sub>",
                    elements: [{ name: "Hydrogen", symbol: "H", count: 2, mass: 1 }, { name: "Sulfur", symbol: "S", count: 1, mass: 32 }, { name: "Oxygen", symbol: "O", count: 4, mass: 16 }],
                    questionElement: "Oxygen", correctAnswer: 65.3, rfm: 98.0,
                    hint: "Check atom counts (H=2, S=1, O=4). Calculate total mass for each. Sum for R.F.M. Then %O = (Total O mass / R.F.M.) × 100."
                },
                {
                    id: 8, compound: "Ca(OH)₂ (Calcium Hydroxide)", formula: "Ca(OH)<sub>2</sub>",
                    elements: [{ name: "Calcium", symbol: "Ca", count: 1, mass: 40 }, { name: "Oxygen", symbol: "O", count: 2, mass: 16 }, { name: "Hydrogen", symbol: "H", count: 2, mass: 1 }],
                    questionElement: "Hydrogen", correctAnswer: 2.7, rfm: 74.0,
                    hint: "Brackets mean multiply inside counts by subscript outside (O=1×2, H=1×2). Calculate total mass for each (Ca, O, H). Sum for R.F.M. Then %H = (Total H mass / R.F.M.) × 100."
                },
                 {
                    id: 9, compound: "CH₃COOH (Acetic Acid)", formula: "CH<sub>3</sub>COOH",
                    elements: [{ name: "Carbon", symbol: "C", count: 2, mass: 12 }, { name: "Hydrogen", symbol: "H", count: 4, mass: 1 }, { name: "Oxygen", symbol: "O", count: 2, mass: 16 }],
                    questionElement: "Carbon", correctAnswer: 40.0, rfm: 60.0,
                    hint: "Count total atoms of each type (C=1+1, H=3+1, O=1+1). Calculate total mass for each. Sum for R.F.M. Then %C = (Total C mass / R.F.M.) × 100."
                },
                {
                    id: 10, compound: "NaHCO₃ (Sodium Bicarbonate)", formula: "NaHCO<sub>3</sub>",
                    elements: [{ name: "Sodium", symbol: "Na", count: 1, mass: 23 }, { name: "Hydrogen", symbol: "H", count: 1, mass: 1 }, { name: "Carbon", symbol: "C", count: 1, mass: 12 }, { name: "Oxygen", symbol: "O", count: 3, mass: 16 }],
                    questionElement: "Oxygen", correctAnswer: 57.1, rfm: 84.0,
                     hint: "Check atom counts (Na=1, H=1, C=1, O=3). Calculate total mass for each. Sum for R.F.M. Then %O = (Total O mass / R.F.M.) × 100."
                }
            ],
            expert: [ // Requires table inputs
                 {
                    id: 11, compound: "C₆H₁₂O₆ (Glucose)", formula: "C<sub>6</sub>H<sub>12</sub>O<sub>6</sub>",
                    elements: [{ name: "Carbon", symbol: "C", count: 6, mass: 12 }, { name: "Hydrogen", symbol: "H", count: 12, mass: 1 }, { name: "Oxygen", symbol: "O", count: 6, mass: 16 }],
                    questionElement: "Carbon", correctAnswer: 40.0, rfm: 180.0,
                    hint: "Check atom counts (C=6, H=12, O=6). Calculate total mass for each. Sum for R.F.M. Then %C = (Total C mass / R.F.M.) × 100."
                },
                {
                    id: 12, compound: "CuCl₂ (Copper(II) Chloride)", formula: "CuCl<sub>2</sub>",
                    elements: [{ name: "Copper", symbol: "Cu", count: 1, mass: 63.5 }, { name: "Chlorine", symbol: "Cl", count: 2, mass: 35.5 }],
                    questionElement: "Copper", correctAnswer: 47.2, rfm: 134.5,
                    hint: "Check atom counts (Cu=1, Cl=2). Calculate total mass for each. Sum for R.F.M. Then %Cu = (Total Cu mass / R.F.M.) × 100."
                },
                {
                    id: 13, compound: "Fe₂O₃ (Iron(III) Oxide)", formula: "Fe<sub>2</sub>O<sub>3</sub>",
                    elements: [{ name: "Iron", symbol: "Fe", count: 2, mass: 56 }, { name: "Oxygen", symbol: "O", count: 3, mass: 16 }],
                    questionElement: "Iron", correctAnswer: 70.0, rfm: 160.0,
                     hint: "Check atom counts (Fe=2, O=3). Calculate total mass for each. Sum for R.F.M. Then %Fe = (Total Fe mass / R.F.M.) × 100."
                },
                 {
                    id: 14, compound: "C₈H₁₀N₄O₂ (Caffeine)", formula: "C<sub>8</sub>H<sub>10</sub>N<sub>4</sub>O<sub>2</sub>",
                    elements: [ { name: "Carbon", symbol: "C", count: 8, mass: 12 }, { name: "Hydrogen", symbol: "H", count: 10, mass: 1 }, { name: "Nitrogen", symbol: "N", count: 4, mass: 14 }, { name: "Oxygen", symbol: "O", count: 2, mass: 16 }],
                    questionElement: "Nitrogen", correctAnswer: 28.9, rfm: 194.0,
                     hint: "Check atom counts (C=8, H=10, N=4, O=2). Calculate total mass for each. Sum for R.F.M. Then %N = (Total N mass / R.F.M.) × 100."
                },
                {
                    id: 15, compound: "CuSO₄·5H₂O (Copper(II) Sulfate Pentahydrate)", formula: "CuSO<sub>4</sub>·5H<sub>2</sub>O",
                    elements: [ { name: "Copper", symbol: "Cu", count: 1, mass: 63.5 }, { name: "Sulfur", symbol: "S", count: 1, mass: 32 }, { name: "Oxygen", symbol: "O", count: 9, mass: 16 }, { name: "Hydrogen", symbol: "H", count: 10, mass: 1 }], // Note: O count is 4 + 5 = 9, H count is 5*2 = 10
                    questionElement: "Water (H₂O)", correctAnswer: 36.1, rfm: 249.5, // R.F.M. includes the 5 water molecules
                    hint: "Careful with water of crystallisation! Total atoms: Cu=1, S=1, O=4+(1×5)=9, H=2×5=10. Calculate total mass for each. Sum for R.F.M. Mass of 5H₂O = 5 × ((1×2)+16) = 90. %Water = (90 / R.F.M.) × 100."
                }
            ]
        };

        // Global variables
        let currentDifficulty = 'beginner';
        let currentQuestionIndex = 0;
        let correctAnswersTotal = 0;
        let questionAnsweredCorrectly = false; // Tracks if the *current* question is fully correct

        // DOM elements (Defined globally, assigned in DOMContentLoaded)
        const screens = {};
        const buttons = {};
        let questionArea, progressBar, difficultyBtns;
        let progressSummaryDiv;

        // --- Local Storage Functions --- (Keep these as they are)
        function saveProgress() {
             const progress = {
                 difficulty: currentDifficulty,
                 questionIndex: currentQuestionIndex,
                 correctAnswersTotal: correctAnswersTotal,
                 lastScreen: getCurrentScreen()
             };
             localStorage.setItem('percentageMassProgress', JSON.stringify(progress));
             updateProgressSummary();
        }

        function loadProgress() {
            const savedProgress = localStorage.getItem('percentageMassProgress');
            if (savedProgress) {
                try {
                    const progress = JSON.parse(savedProgress);
                    currentDifficulty = progress.difficulty || 'beginner';
                    currentQuestionIndex = progress.questionIndex || 0;
                    correctAnswersTotal = progress.correctAnswersTotal || 0;

                    difficultyBtns.forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.getAttribute('data-difficulty') === currentDifficulty) {
                            btn.classList.add('active');
                        }
                    });

                    const lastScreen = progress.lastScreen || 'intro';
                    if (screens[lastScreen]) {
                         showScreen(lastScreen, false);
                    } else {
                         showScreen('intro', false);
                    }

                    if (lastScreen === 'practice') {
                         if (screens.practice && screens.practice.classList.contains('active')) {
                            loadQuestion();
                             const totalQuestionsInDifficulty = questions[currentDifficulty] ? questions[currentDifficulty].length : 0;
                             // Show challenge buttons only if progress indicates completion
                             if (totalQuestionsInDifficulty > 0 && correctAnswersTotal >= totalQuestionsInDifficulty) {
                                buttons.startChallenge.style.display = 'inline-block';
                                buttons.startMurderMystery.style.display = 'inline-block';
                            } else {
                                buttons.startChallenge.style.display = 'none';
                                buttons.startMurderMystery.style.display = 'none';
                            }
                         }
                    } else {
                         buttons.startChallenge.style.display = 'none';
                         buttons.startMurderMystery.style.display = 'none';
                    }

                    updateProgressSummary();
                    progressSummaryDiv.style.display = 'block';
                    return true;
                } catch (e) {
                    console.error("Error parsing saved progress:", e);
                    clearProgress();
                    return false;
                }
            }
             // If no saved progress, ensure challenge buttons are hidden initially
             buttons.startChallenge.style.display = 'none';
             buttons.startMurderMystery.style.display = 'none';
            return false;
        }


        function updateProgressSummary() {
             if (!progressSummaryDiv) return;

            const difficultyDisplay = currentDifficulty.charAt(0).toUpperCase() + currentDifficulty.slice(1);
            const totalQuestions = questions[currentDifficulty] ? questions[currentDifficulty].length : 0;
            // Show questions *attempted* based on index, capped at total
            const completedInDifficulty = Math.min(currentQuestionIndex, totalQuestions);

            document.getElementById('savedDifficulty').textContent = difficultyDisplay;
             // If index is beyond length (completed), show total length
             const displayIndex = (currentQuestionIndex >= totalQuestions && totalQuestions > 0) ? totalQuestions : completedInDifficulty;
            document.getElementById('completedQuestions').textContent = `${displayIndex} of ${totalQuestions}`;
            document.getElementById('correctAnswersCount').textContent = correctAnswersTotal;

             progressSummaryDiv.style.display = (currentQuestionIndex > 0 || correctAnswersTotal > 0) ? 'block' : 'none';
        }


        function clearProgress() {
            localStorage.removeItem('percentageMassProgress');
            currentDifficulty = 'beginner';
            currentQuestionIndex = 0;
            correctAnswersTotal = 0;
            questionAnsweredCorrectly = false;

            difficultyBtns.forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-difficulty') === 'beginner') {
                    btn.classList.add('active');
                }
            });

            if (progressSummaryDiv) progressSummaryDiv.style.display = 'none';

             resetChallengeScreen();
             resetMurderMysteryScreen();
             hideChallengeScreens();


            showScreen('intro', false);


            buttons.startChallenge.style.display = 'none';
            buttons.startMurderMystery.style.display = 'none';

             loadQuestion(); // Reload first beginner question view
        }

        function getCurrentScreen() {
            for (const [name, screen] of Object.entries(screens)) {
                if (['intro', 'tutorial', 'practice'].includes(name) && screen.classList.contains('active')) {
                    return name;
                }
            }
             return 'intro';
        }

        // --- Challenge Functions (Keep as they are) ---
        function hideChallengeScreens() {
            if (screens.challenge) screens.challenge.style.display = 'none';
            if (screens.murderMystery) screens.murderMystery.style.display = 'none';
             if (questionArea) questionArea.style.display = 'block';
            if (buttons.practiceNavButtons) buttons.practiceNavButtons.style.display = 'flex';
        }
         function showChallengeScreen(challengeType) {
             if (questionArea) questionArea.style.display = 'none';
             if (buttons.practiceNavButtons) buttons.practiceNavButtons.style.display = 'none';
             if (challengeType === 'novichok' && screens.challenge) {
                 resetChallengeScreen();
                 screens.challenge.style.display = 'block';
                 if(screens.murderMystery) screens.murderMystery.style.display = 'none';
             } else if (challengeType === 'murder' && screens.murderMystery) {
                  resetMurderMysteryScreen();
                 screens.murderMystery.style.display = 'block';
                 if(screens.challenge) screens.challenge.style.display = 'none';
             }
        }
         function backToPractice() {
            hideChallengeScreens();
            showScreen('practice');
        }
         function resetChallengeScreen() {
             if (!screens.challenge) return;
            screens.challenge.querySelectorAll('input[type="number"]').forEach(input => {input.value = ''; input.disabled = false;});
             screens.challenge.querySelectorAll('.check-btn').forEach(btn => btn.disabled = false); // Re-enable buttons
            screens.challenge.querySelectorAll('.feedback').forEach(fb => { fb.textContent = ''; fb.style.display = 'none'; fb.classList.remove('correct', 'incorrect'); });
             screens.challenge.querySelectorAll('.hint').forEach(h => h.style.display = 'none');
             const matchResult = document.getElementById('matchResult');
             if (matchResult) { matchResult.textContent = ''; matchResult.style.display = 'none'; matchResult.classList.remove('matches', 'does-not-match'); }
        }
         function resetMurderMysteryScreen() {
             if (!screens.murderMystery) return;
            screens.murderMystery.querySelectorAll('input[type="number"]').forEach(input => {input.value = ''; input.disabled = false;});
            screens.murderMystery.querySelectorAll('.check-btn').forEach(btn => btn.disabled = false); // Re-enable buttons
             screens.murderMystery.querySelectorAll('.feedback').forEach(fb => { fb.textContent = ''; fb.style.display = 'none'; fb.classList.remove('correct', 'incorrect'); });
             screens.murderMystery.querySelectorAll('.hint').forEach(h => h.style.display = 'none');
             const matchFeedback = document.getElementById('matchFeedback');
             if(matchFeedback) { matchFeedback.textContent = ''; matchFeedback.style.display = 'none'; }
             const caseResult = document.getElementById('caseResult');
             if (caseResult) { caseResult.textContent = ''; caseResult.style.display = 'none'; caseResult.classList.remove('matches', 'does-not-match'); }
             const additionalAnalysis = document.getElementById('additionalAnalysis');
             if (additionalAnalysis) additionalAnalysis.style.display = 'none';
             const finalAnswerSelect = document.getElementById('finalAnswerSelect');
              if (finalAnswerSelect) finalAnswerSelect.value = '';
         }


        // --- Initialize the application on DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', function() {
            // Assign DOM elements
            screens.intro = document.getElementById('introScreen');
            screens.tutorial = document.getElementById('tutorialScreen');
            screens.practice = document.getElementById('practiceScreen');
            screens.challenge = document.getElementById('challengeScreen');
            screens.murderMystery = document.getElementById('murderMysteryScreen');

            buttons.startTutorial = document.getElementById('startTutorial');
            buttons.startPractice = document.getElementById('startPractice');
            buttons.tutorialBackToIntro = document.getElementById('tutorialBackToIntro');
            buttons.tutorialNext = document.getElementById('tutorialNext');
            buttons.practiceBackToIntro = document.getElementById('practiceBackToIntro');
            buttons.practiceNext = document.getElementById('practiceNext');
            buttons.startChallenge = document.getElementById('startChallenge');
            buttons.startMurderMystery = document.getElementById('startMurderMystery');
            buttons.challengeBackToPractice = document.getElementById('challengeBackToPractice');
            buttons.restartChallenge = document.getElementById('restartChallenge');
            buttons.murderBackToPractice = document.getElementById('murderBackToPractice');
            buttons.restartMurder = document.getElementById('restartMurder');
            buttons.checkMatchBtn = document.getElementById('checkMatchBtn');
            buttons.matchYesBtn = document.getElementById('matchYesBtn');
            buttons.matchNoBtn = document.getElementById('matchNoBtn');
            buttons.checkFinalAnswer = document.getElementById('checkFinalAnswer');
            buttons.clearProgressBtn = document.getElementById('clearProgressBtn');
            buttons.practiceNavButtons = document.getElementById('practiceNavButtons');

            questionArea = document.getElementById('questionArea');
            progressBar = document.querySelector('.progress-bar');
            difficultyBtns = document.querySelectorAll('.difficulty-btn');
            progressSummaryDiv = document.getElementById('progressSummary');

            // --- Event Listeners Setup ---

            // Main Navigation
            buttons.startTutorial.addEventListener('click', () => showScreen('tutorial'));
            buttons.startPractice.addEventListener('click', () => { showScreen('practice'); loadQuestion(); });
            buttons.tutorialBackToIntro.addEventListener('click', () => showScreen('intro'));
            buttons.tutorialNext.addEventListener('click', () => { showScreen('practice'); loadQuestion(); });
            buttons.practiceBackToIntro.addEventListener('click', () => showScreen('intro'));

            // Practice Screen Navigation
            buttons.practiceNext.addEventListener('click', () => {
                 const totalQuestionsInDifficulty = questions[currentDifficulty] ? questions[currentDifficulty].length : 0;
                 if (totalQuestionsInDifficulty === 0) return; // No questions to navigate through

                 currentQuestionIndex++;
                 questionAnsweredCorrectly = false; // Reset for the new question

                 if (currentQuestionIndex >= totalQuestionsInDifficulty) {
                     // Reached end of this difficulty level
                     // Optionally show completion message or loop
                      // For now, just loop back to the start
                     currentQuestionIndex = 0;
                     console.log("Looping back to first question.");
                     // Check if challenges should be permanently unlocked after one full correct round
                     // The check is now primarily within loadProgress and checkPracticeAnswer
                 }
                 loadQuestion();
                 saveProgress(); // Save progress when moving to next question
            });


            // Difficulty Selection
            difficultyBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    if (btn.classList.contains('active')) return; // Do nothing if already active

                    difficultyBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentDifficulty = btn.getAttribute('data-difficulty');
                    currentQuestionIndex = 0;
                    // Decide whether to reset score on difficulty change - let's reset for now
                    correctAnswersTotal = 0;
                    questionAnsweredCorrectly = false;
                    hideChallengeScreens();
                    loadQuestion();
                    buttons.startChallenge.style.display = 'none';
                    buttons.startMurderMystery.style.display = 'none';
                    saveProgress();
                    updateProgressSummary(); // Update summary display for new level
                });
            });

             // Start Challenges
            buttons.startChallenge.addEventListener('click', () => showChallengeScreen('novichok'));
            buttons.startMurderMystery.addEventListener('click', () => showChallengeScreen('murder'));

            // Challenge Navigation/Reset
            buttons.challengeBackToPractice.addEventListener('click', backToPractice);
            buttons.restartChallenge.addEventListener('click', resetChallengeScreen);
            buttons.murderBackToPractice.addEventListener('click', backToPractice);
            buttons.restartMurder.addEventListener('click', resetMurderMysteryScreen);

            // Progress Management
            buttons.clearProgressBtn.addEventListener('click', clearProgress);


            // --- Challenge Specific Logic (Handlers remain the same) ---
            document.querySelectorAll('#challengeScreen .check-btn, #murderMysteryScreen .check-btn').forEach(btn => {
                btn.addEventListener('click', handleChallengeCheckButton);
            });
             document.querySelectorAll('.hint-btn').forEach(btn => { // Generic hint handler
                 btn.addEventListener('click', handleHintButton);
             });
            buttons.checkMatchBtn.addEventListener('click', handleNovichokMatchCheck);
            buttons.matchYesBtn.addEventListener('click', handleMurderMatchYes);
            buttons.matchNoBtn.addEventListener('click', handleMurderMatchNo);
            // Final answer check remains unused currently
            // buttons.checkFinalAnswer.addEventListener('click', handleMurderFinalAnswer);


            // --- Initial Load ---
            const hasProgress = loadProgress();
            if (!hasProgress) {
                showScreen('intro', false);
                updateProgressSummary();
            } else {
                // Ensure UI state matches loaded progress
                const totalQuestionsInDifficulty = questions[currentDifficulty] ? questions[currentDifficulty].length : 0;
                if (totalQuestionsInDifficulty > 0 && correctAnswersTotal >= totalQuestionsInDifficulty && screens.practice.classList.contains('active')) {
                    buttons.startChallenge.style.display = 'inline-block';
                    buttons.startMurderMystery.style.display = 'inline-block';
                } else {
                     buttons.startChallenge.style.display = 'none';
                     buttons.startMurderMystery.style.display = 'none';
                 }
            }

        }); // End DOMContentLoaded


        // --- Core Functions ---

        function showScreen(screenName, doSaveProgress = true) {
             Object.keys(screens).forEach(key => {
                 if (['intro', 'tutorial', 'practice'].includes(key) && screens[key]) {
                    screens[key].classList.remove('active');
                 }
            });
            if (screenName !== 'practice') {
                 hideChallengeScreens();
             }
            if (screens[screenName]) {
                screens[screenName].classList.add('active');
            } else {
                 console.error(`Screen "${screenName}" not found.`);
                 screens.intro.classList.add('active');
            }
            if (doSaveProgress) {
                 saveProgress();
             }
        }

        function loadQuestion() {
            const questionsForDifficulty = questions[currentDifficulty];
            if (!questionsForDifficulty || questionsForDifficulty.length === 0) {
                questionArea.innerHTML = `<p>No questions available for ${currentDifficulty} level.</p>`;
                progressBar.style.width = '0%';
                return;
            }

            // Handle index wrapping/completion
             if (currentQuestionIndex >= questionsForDifficulty.length) {
                  console.log("Reached end of questions for difficulty:", currentDifficulty);
                  // Optionally show completion message here instead of just looping in practiceNext
                  // For now, practiceNext handles looping, so we might load index 0
                  currentQuestionIndex = 0; // Ensure index is valid if practiceNext looped
                  questionAnsweredCorrectly = false;
             }


            const question = questionsForDifficulty[currentQuestionIndex];
             if (!question) {
                 console.error(`Question not found for difficulty ${currentDifficulty}, index ${currentQuestionIndex}`);
                 questionArea.innerHTML = `<p>Error loading question.</p>`;
                  progressBar.style.width = '0%';
                 return;
             }


            const totalQuestionsInDifficulty = questionsForDifficulty.length;
            questionAnsweredCorrectly = false; // Reset correctness flag for new question load

            // Update progress bar
            const progressPercentage = ((currentQuestionIndex) / totalQuestionsInDifficulty) * 100;
            progressBar.style.width = `${progressPercentage}%`;

            const isInteractiveTable = currentDifficulty === 'intermediate' || currentDifficulty === 'expert';

            // Generate question HTML
            let html = `
                <div class="question-container" data-question-id="${question.id}"> <!-- Add question ID for easier targeting -->
                    <h3>Question ${currentQuestionIndex + 1} of ${totalQuestionsInDifficulty}: ${question.compound}</h3>
                    <p>Calculate the percentage mass of <strong>${question.questionElement}</strong> in the compound ${question.formula}.</p>
                    <p><em>(Round your final percentage answer to one decimal place)</em></p>
                    ${isInteractiveTable ? '<p class="instructions">First, fill in the table and calculate the Relative Formula Mass (R.F.M.) below.</p>' : ''}

                    <div class="table-container">
                        <table>
                         <thead>
                            <tr>
                                <th>Element</th><th>Symbol</th><th>Number of Atoms</th><th>R.A.M.</th><th>Total Mass</th>
                            </tr>
                         </thead>
                         <tbody>`;

            // Generate table rows
            question.elements.forEach(element => {
                 const totalMass = element.mass * element.count; // Correct total mass for this element
                html += `<tr>
                            <td>${element.name}</td>
                            <td>${element.symbol}</td>`;
                if (isInteractiveTable) {
                    // Input for Number of Atoms
                    html += `<td><input type="number" class="table-input atoms-input" id="atoms-${element.symbol}-${question.id}" data-symbol="${element.symbol}" data-correct-atoms="${element.count}" min="0" step="1" required></td>`;
                    // Display R.A.M.
                     html += `<td>${element.mass}</td>`;
                     // Input for Total Mass
                     html += `<td><input type="number" class="table-input totalmass-input" id="totalMass-${element.symbol}-${question.id}" data-symbol="${element.symbol}" data-correct-mass="${totalMass.toFixed(1)}" min="0" step="any" required></td>`;
                } else {
                    // Display calculated values for Beginner
                    html += `<td>${element.count}</td>
                             <td>${element.mass}</td>
                             <td>${totalMass.toFixed(1)}</td>`;
                }
                html += `</tr>`;
            });

            html += `</tbody>`;

            // Generate Footer (R.F.M. Input for Intermediate/Expert)
            if (isInteractiveTable) {
                 html += `<tfoot><tr><td colspan="4" style="text-align:right; font-weight:bold;">Calculate R.F.M.:</td>
                                     <td><input type="number" class="table-input rfm-input" id="rfm-${question.id}" data-correct-rfm="${question.rfm.toFixed(1)}" min="0" step="any" required></td>
                                  </tr></tfoot>`;
            } else {
                // Display R.F.M for Beginner
                 html += `<tfoot><tr><td colspan="4" style="text-align:right; font-weight:bold;">Relative Formula Mass (R.F.M.):</td>
                                    <td style="font-weight:bold;">${question.rfm.toFixed(1)}</td>
                                  </tr></tfoot>`;
            }


            html += `</table></div>`; // Close table container

             // Final Answer Section
             html += `
                    <div class="answer-container">
                        <label for="answer">Final Answer (% ${question.questionElement}):</label>
                        <input type="number" id="answer" step="0.1" min="0" max="100" placeholder="e.g. 45.5">
                        <button id="checkAnswer" class="secondary">Check Answer</button>
                        <button id="showHint" class="tertiary">Show Hint</button>
                    </div>

                    <div class="hint" id="hint">${question.hint}</div>
                    <div class="feedback" id="feedback"></div>
                </div>`; // Close question-container

            questionArea.innerHTML = html;

            // Add event listeners for this specific question's buttons
            document.getElementById('checkAnswer').addEventListener('click', checkPracticeAnswer);
            document.getElementById('showHint').addEventListener('click', () => {
                const hint = document.getElementById('hint');
                if (hint) hint.style.display = (hint.style.display === 'block') ? 'none' : 'block';
            });
        }


        function checkPracticeAnswer() {
            const questionContainer = questionArea.querySelector('.question-container');
             if (!questionContainer) return; // Should not happen

             const questionId = questionContainer.getAttribute('data-question-id');
             const question = questions[currentDifficulty].find(q => q.id == questionId); // Find question data by ID
             if (!question) return; // Should not happen

            const feedback = document.getElementById('feedback');
            const userAnswerInput = document.getElementById('answer');
            const checkButton = document.getElementById('checkAnswer');
             const isInteractiveTable = currentDifficulty === 'intermediate' || currentDifficulty === 'expert';

             feedback.textContent = '';
             feedback.classList.remove('correct', 'incorrect');
             feedback.style.display = 'none';

            let tableAndRfmCorrect = true;
            let tableErrors = [];

             // --- Step 1: Validate Table and R.F.M. Inputs (for Intermediate/Expert) ---
            if (isInteractiveTable) {
                 // Check Atom Counts and Total Masses
                 question.elements.forEach(element => {
                     const atomInput = document.getElementById(`atoms-${element.symbol}-${question.id}`);
                     const totalMassInput = document.getElementById(`totalMass-${element.symbol}-${question.id}`);

                     const userAtoms = parseInt(atomInput.value, 10);
                     const userTotalMass = parseFloat(totalMassInput.value);
                     const correctAtoms = element.count;
                     const correctTotalMass = parseFloat((element.mass * element.count).toFixed(1)); // Match precision

                     if (isNaN(userAtoms) || userAtoms !== correctAtoms) {
                         tableAndRfmCorrect = false;
                         tableErrors.push(`Number of atoms for ${element.symbol} is incorrect (should be ${correctAtoms}).`);
                         atomInput.style.borderColor = 'var(--tertiary-color)'; // Highlight error
                     } else {
                         atomInput.style.borderColor = 'var(--input-border-color)'; // Reset border
                     }


                     if (isNaN(userTotalMass) || Math.abs(userTotalMass - correctTotalMass) > 0.15) { // Allow tolerance
                         tableAndRfmCorrect = false;
                         tableErrors.push(`Total mass for ${element.symbol} is incorrect (should be approx ${correctTotalMass}).`);
                          totalMassInput.style.borderColor = 'var(--tertiary-color)';
                     } else {
                          totalMassInput.style.borderColor = 'var(--input-border-color)';
                     }

                 });

                 // Check R.F.M.
                 const rfmInput = document.getElementById(`rfm-${question.id}`);
                 const userRfm = parseFloat(rfmInput.value);
                 const correctRfm = parseFloat(question.rfm.toFixed(1)); // Match precision

                 if (isNaN(userRfm) || Math.abs(userRfm - correctRfm) > 0.15) { // Allow tolerance
                      tableAndRfmCorrect = false;
                      tableErrors.push(`Calculated R.F.M. is incorrect (should be approx ${correctRfm}).`);
                      rfmInput.style.borderColor = 'var(--tertiary-color)';
                 } else {
                      rfmInput.style.borderColor = 'var(--input-border-color)';
                 }


                 // If table/RFM errors exist, show them and stop
                 if (!tableAndRfmCorrect) {
                     feedback.innerHTML = 'Please correct the errors in the table:<ul><li>' + tableErrors.join('</li><li>') + '</li></ul>';
                     feedback.classList.add('incorrect');
                     feedback.style.display = 'block';
                     return; // Don't check final percentage yet
                 } else {
                      // Table is correct, visually confirm maybe? Or just proceed.
                      // Let's remove error borders if any were set previously
                      questionContainer.querySelectorAll('.table-input').forEach(inp => inp.style.borderColor = 'var(--input-border-color)');
                 }
            }


            // --- Step 2: Validate Final Percentage Answer ---
            const userAnswer = parseFloat(userAnswerInput.value);
            const correctAnswer = question.correctAnswer;

             if (isNaN(userAnswer)) {
                 feedback.textContent = 'Please enter a numerical answer for the final percentage.';
                 feedback.classList.add('incorrect');
                 feedback.style.display = 'block';
                 return;
             }

             // Check final answer (allow tolerance)
             if (Math.abs(userAnswer - correctAnswer) <= 0.15) {
                 // --- ALL CORRECT (Table/RFM and Final Percentage) ---
                 feedback.textContent = 'Correct! Well done.';
                 if (isInteractiveTable) {
                     feedback.textContent = 'Table and Final Answer Correct! Well done.';
                 }
                 feedback.classList.add('correct');
                 feedback.classList.remove('incorrect');

                 // Disable all inputs for this question
                 userAnswerInput.disabled = true;
                 checkButton.disabled = true;
                 document.getElementById('showHint').disabled = true; // Disable hint too
                  if (isInteractiveTable) {
                       questionContainer.querySelectorAll('.table-input').forEach(inp => inp.disabled = true);
                  }


                 if (!questionAnsweredCorrectly) {
                      correctAnswersTotal++;
                      questionAnsweredCorrectly = true;
                      updateProgressSummary();
                      saveProgress(); // Save after full correct answer
                 }

                  // Check if this completion unlocks challenges
                  const totalQuestionsInDifficulty = questions[currentDifficulty].length;
                   if (totalQuestionsInDifficulty > 0 && correctAnswersTotal >= totalQuestionsInDifficulty) {
                       // Challenges unlocked (buttons will appear if not already visible)
                       buttons.startChallenge.style.display = 'inline-block';
                       buttons.startMurderMystery.style.display = 'inline-block';
                       console.log("Challenges unlocked!"); // Debugging
                   }

             } else {
                 // --- Final Percentage Incorrect (Table/RFM was correct if applicable) ---
                 feedback.textContent = `The final percentage for ${question.questionElement} is incorrect. The correct answer is ${correctAnswer}%.`;
                 if (isInteractiveTable && tableAndRfmCorrect) {
                     feedback.textContent = `Your table calculations are correct, but the final percentage for ${question.questionElement} is incorrect. It should be ${correctAnswer}%. Check your final step: (% = (Total Element Mass / R.F.M.) × 100).`;
                 }
                 feedback.classList.add('incorrect');
                 feedback.classList.remove('correct');
             }

             feedback.style.display = 'block';
        }


        // --- Challenge Event Handlers (Simplified - assumes previous implementation works) ---
        function handleChallengeCheckButton(event) {
            const btn = event.target;
            const element = btn.getAttribute('data-element');
            const correct = parseFloat(btn.getAttribute('data-correct'));
            const input = document.getElementById(`${element}Answer`);
            const feedback = document.getElementById(`${element}Feedback`);
             if (!input || !feedback) return;
            const userAnswer = parseFloat(input.value);
            if (isNaN(userAnswer)) {
                 feedback.textContent = 'Enter number.'; feedback.className = 'feedback incorrect'; feedback.style.display = 'block'; return;
            }
            if (Math.abs(userAnswer - correct) <= 0.15) {
                 feedback.textContent = 'Correct!'; feedback.className = 'feedback correct'; input.disabled = true; btn.disabled = true;
            } else {
                 feedback.textContent = `Incorrect (${correct}).`; feedback.className = 'feedback incorrect'; input.disabled = false; btn.disabled = false;
            }
            feedback.style.display = 'block';
        }
        function handleHintButton(event) {
             const hintId = event.target.getAttribute('data-hint');
             const hint = document.getElementById(hintId);
             if (hint) hint.style.display = (hint.style.display === 'block') ? 'none' : 'block';
        }
        function handleNovichokMatchCheck() {
             const inputs = [ { id: 'carbonAnswer', correct: 44.4 }, { id: 'hydrogenAnswer', correct: 7.4 }, { id: 'nitrogenAnswer', correct: 14.8 }, { id: 'oxygenAnswer', correct: 16.9 }, { id: 'phosphorusAnswer', correct: 16.4 } ];
             let allCorrect = true;
             inputs.forEach(item => { const inputElement = document.getElementById(item.id); if (!inputElement || !inputElement.disabled) allCorrect = false; }); // Check if all inputs are correct (disabled)
             const resultDiv = document.getElementById('matchResult');
             if (allCorrect) { resultDiv.textContent = 'Excellent! Your calculated percentages match the crime scene sample. The substance is likely A-234.'; resultDiv.className = 'challenge-result matches'; }
             else { resultDiv.textContent = `Not quite. Ensure all individual element percentages are calculated correctly and checked first.`; resultDiv.className = 'challenge-result does-not-match'; }
             resultDiv.style.display = 'block';
        }
        function handleMurderMatchYes() {
             const feedback = document.getElementById('matchFeedback'); const caseResult = document.getElementById('caseResult');
             // Check if As% and O% were checked correctly
             const asInput = document.getElementById('arsenicPercentAnswer'); const oInput = document.getElementById('oxygenPercentAnswer');
             if (asInput && oInput && asInput.disabled && oInput.disabled) { // Check if inputs are disabled (meaning correct)
                 feedback.textContent = 'Correct! Your calculations match the lab\'s analysis.'; feedback.className = 'feedback correct';
                 caseResult.textContent = 'Case Solved: The poison is confirmed to be Arsenic Trioxide (As₂O₃).'; caseResult.className = 'challenge-result matches';
                 caseResult.style.display = 'block';
             } else {
                 feedback.textContent = 'Please calculate and check the percentages for As and O in As₂O₃ first.'; feedback.className = 'feedback incorrect';
                 caseResult.style.display = 'none';
             }
            feedback.style.display = 'block';
        }
        function handleMurderMatchNo() {
             const feedback = document.getElementById('matchFeedback'); const caseResult = document.getElementById('caseResult');
             feedback.textContent = 'Incorrect. Review your calculations for As₂O₃; they should match the lab results (As=75.8%, O=24.2%).'; feedback.className = 'feedback incorrect';
             caseResult.style.display = 'none';
            feedback.style.display = 'block';
        }
        // function handleMurderFinalAnswer() { /* ... (remains unused currently) ... */ }


    </script>

</body>
</html>
