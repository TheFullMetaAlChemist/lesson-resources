<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bio-Extraction Sim: Phytomining & Bioleaching</title>
    <style>
        body {
            font-family: 'Segoe UI', 'Roboto', Helvetica, Arial, sans-serif;
            background-color: #eef2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
            color: #444;
            user-select: none;
        }

        h1 { color: #2c3e50; margin-bottom: 5px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); margin-top: 0; }
        h3 { color: #666; margin-top: 0; font-weight: normal; margin-bottom: 15px; letter-spacing: 0.5px;}

        /* Main Wrapper */
        .main-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 800px;
        }

        /* Dialog Box */
        .dialog-box {
            background: #fff;
            width: 100%;
            padding: 20px 30px; 
            border-radius: 8px;
            border-left: 6px solid #007bff;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 15px; 
            text-align: left; 
            font-size: 1.15em;
            line-height: 1.6;
            color: #2c3e50;
            box-sizing: border-box;
            min-height: 90px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-start; 
        }

        #game-container {
            position: relative;
            width: 800px;
            height: 550px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            overflow: hidden;
            cursor: default;
            border: 1px solid #ddd;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* Controls */
        .controls {
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            padding: 10px;
            background: #fff; 
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            min-height: 60px;
            box-sizing: border-box;
            align-items: center;
        }

        button {
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(145deg, #007bff, #0069d9);
            color: white;
            border: none;
            border-radius: 8px;
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px rgba(0,123,255,0.2);
            text-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }

        button:hover { 
            background: linear-gradient(145deg, #0069d9, #0056b3); 
            transform: translateY(-2px); 
            box-shadow: 0 6px 12px rgba(0,123,255,0.3);
        }
        button:active { transform: translateY(0); }
        
        button.metal-btn { 
            background: linear-gradient(145deg, #6c757d, #5a6268); 
            box-shadow: 0 4px 6px rgba(108,117,125,0.2);
        }
        button.metal-btn:hover { background: linear-gradient(145deg, #5a6268, #4e555b); }
        
        button.tool-btn { 
            background: linear-gradient(145deg, #28a745, #218838); 
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 6px rgba(40,167,69,0.2);
        }
        button.tool-btn:hover { background: linear-gradient(145deg, #218838, #1e7e34); }

        .hidden { display: none !important; }

        /* Status Colors */
        .success { border-left-color: #28a745; background: #f0fff4; }
        .error { border-left-color: #dc3545; background: #fff5f5; }
        .warning { border-left-color: #ffc107; background: #fffff5; }

    </style>
</head>
<body>

    <h1>Copper Extraction Simulation</h1>
    <h3>Topic: Phytomining, Bioleaching & Electrolysis</h3>

    <div class="main-wrapper">
        <!-- 1. Text Area Top -->
        <div id="dialog" class="dialog-box">
            Welcome! High-grade copper ore is running out. <br>
            Choose a biological method to extract copper from low-grade ore.
        </div>

        <!-- 2. Animation Window Middle -->
        <div id="game-container">
            <canvas id="simCanvas" width="800" height="550"></canvas>
        </div>

        <!-- 3. Controls Bottom -->
        <div id="controls-area" class="controls">
            <!-- Buttons injected via JS -->
        </div>
    </div>

<script>
/**
 * SIMULATION ENGINE
 */
const canvas = document.getElementById('simCanvas');
const ctx = canvas.getContext('2d');
const dialog = document.getElementById('dialog');
const controls = document.getElementById('controls-area');

// Game State Enum
const STATES = {
    MENU: 0,
    PHYTO_PLANT: 1,
    PHYTO_GROW: 2,
    PHYTO_HARVEST: 3,
    PHYTO_BURN: 4,
    BIO_LEACH: 5,
    DISPLACEMENT_SELECT: 6,
    DISPLACEMENT_REACT: 7,
    ELECTROLYSIS: 8,
    FINISHED: 9
};

let currentState = STATES.MENU;
let frames = 0;

// MOUSE / INPUT
let mouse = { x: 0, y: 0, isDown: false };
let currentTool = null; // 'seeds', 'scythe'

// VARIABLES
let particles = [];
let plants = [];
let anodeWidth = 60;
let cathodeWidth = 15;
let solutionColor = {r: 255, g: 255, b: 255}; 
let reactionProgress = 0;
let copperPrecipitateHeight = 0;

// BIOLEACHING SPECIFIC
let bioRocks = [];
let bioBacteria = [];
let bioDroplets = [];

// ASSETS / CONSTANTS
const groundLevel = 400; 

// --- INITIALIZATION ---
function init() {
    setupInput();
    showMenu();
    loop();
}

function setupInput() {
    canvas.addEventListener('mousemove', e => {
        const rect = canvas.getBoundingClientRect();
        mouse.x = e.clientX - rect.left;
        mouse.y = e.clientY - rect.top;
        handleToolAction();
    });
    canvas.addEventListener('mousedown', () => { mouse.isDown = true; handleToolAction(); });
    canvas.addEventListener('mouseup', () => { mouse.isDown = false; });
    
    canvas.addEventListener('touchmove', e => {
        e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        mouse.x = e.touches[0].clientX - rect.left;
        mouse.y = e.touches[0].clientY - rect.top;
        mouse.isDown = true;
        handleToolAction();
    }, {passive: false});
    canvas.addEventListener('touchstart', () => { mouse.isDown = true; });
    canvas.addEventListener('touchend', () => { mouse.isDown = false; });
}

function handleToolAction() {
    if (!mouse.isDown) return;

    if (currentState === STATES.PHYTO_PLANT && currentTool === 'seeds') {
        if (mouse.y > groundLevel - 50 && mouse.y < groundLevel + 50) {
            let tooClose = plants.some(p => Math.abs(p.x - mouse.x) < 30);
            if (!tooClose) {
                plants.push({ x: mouse.x, height: 0, cut: false, variance: Math.random() });
                if (plants.length >= 3 && document.getElementById('grow-btn').classList.contains('hidden')) {
                    document.getElementById('grow-btn').classList.remove('hidden');
                    setDialog("Great! Click 'Grow Plants' when ready, or plant more.");
                }
            }
        }
    }

    if (currentState === STATES.PHYTO_HARVEST && currentTool === 'scythe') {
        plants.forEach(p => {
            if (!p.cut && Math.abs(mouse.x - p.x) < 25 && mouse.y < groundLevel && mouse.y > groundLevel - p.height - 20) {
                p.cut = true;
            }
        });

        const allCut = plants.length > 0 && plants.every(p => p.cut);
        if (allCut && document.getElementById('burn-btn').classList.contains('hidden')) {
            document.getElementById('burn-btn').classList.remove('hidden');
            setDialog("All plants harvested! They are rich in copper. Click 'Burn' to extract the ash.", "success");
        }
    }
}


// --- MAIN LOOP ---
function loop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    frames++;

    switch (currentState) {
        case STATES.MENU:
            drawMenuBackground();
            break;
        case STATES.PHYTO_PLANT:
            drawPhytoEnvironment();
            drawPlants();
            drawToolOverlay();
            break;
        case STATES.PHYTO_GROW:
            drawPhytoEnvironment();
            drawPlants();
            updatePhytoParticles();
            drawPhytoLabels();
            break;
        case STATES.PHYTO_HARVEST:
            drawPhytoEnvironment();
            drawPlants();
            drawToolOverlay();
            break;
        case STATES.PHYTO_BURN:
            drawBurning();
            break;
        case STATES.BIO_LEACH:
            updateBioleaching();
            drawBioleaching();
            break;
        case STATES.DISPLACEMENT_SELECT:
        case STATES.DISPLACEMENT_REACT:
            drawBeakerScene();
            if(currentState === STATES.DISPLACEMENT_REACT) updateReaction();
            break;
        case STATES.ELECTROLYSIS:
            drawElectrolysisScene();
            updateElectrolysis();
            break;
        case STATES.FINISHED:
            drawFinished();
            break;
    }

    requestAnimationFrame(loop);
}

// --- SCENE: MENU ---
function drawMenuBackground() {
    // Left: Nature
    let gradSky = ctx.createLinearGradient(0, 0, 0, 400);
    gradSky.addColorStop(0, "#4FC3F7");
    gradSky.addColorStop(1, "#B3E5FC");
    ctx.fillStyle = gradSky;
    ctx.fillRect(0, 0, 400, 550);
    
    // Soil Left
    ctx.fillStyle = "#5D4037";
    ctx.fillRect(0, 400, 400, 150);
    ctx.fillStyle = "#66BB6A"; // Grass
    ctx.fillRect(0, 390, 400, 10);
    
    // Right: Industrial
    ctx.fillStyle = "#ECEFF1"; 
    ctx.fillRect(400, 0, 400, 550);
    // Floor
    ctx.fillStyle = "#CFD8DC";
    ctx.fillRect(400, 400, 400, 150);
    
    drawOrePile(600, 420, 100);
    
    // Divider
    ctx.strokeStyle = "#B0BEC5";
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.moveTo(400,0); ctx.lineTo(400,550);
    ctx.stroke();

    // Labels
    ctx.shadowColor="rgba(255,255,255,0.8)"; ctx.shadowBlur=4;
    ctx.fillStyle = "#2c3e50";
    ctx.font = "bold 24px Segoe UI";
    ctx.textAlign = "center";
    ctx.fillText("Method A: Phytomining", 200, 120);
    ctx.fillText("Method B: Bioleaching", 600, 120);
    ctx.shadowBlur=0;
}

// --- SCENE: PHYTOMINING ---
function drawPhytoEnvironment() {
    // Sky
    let grad = ctx.createLinearGradient(0, 0, 0, groundLevel);
    grad.addColorStop(0, "#87CEEB");
    grad.addColorStop(1, "#E0F7FA");
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, 800, groundLevel);

    // Soil
    let gradSoil = ctx.createLinearGradient(0, groundLevel, 0, 550);
    gradSoil.addColorStop(0, "#5D4037");
    gradSoil.addColorStop(1, "#3E2723");
    ctx.fillStyle = gradSoil;
    ctx.fillRect(0, groundLevel, 800, 550 - groundLevel);
    
    // Soil Texture
    ctx.fillStyle = "rgba(0,0,0,0.1)";
    for(let i=0; i<100; i++) {
        let x = Math.random() * 800;
        let y = groundLevel + Math.random() * 150;
        ctx.fillRect(x, y, 2, 2);
    }
}

function drawPlants() {
    plants.forEach(p => {
        let h = p.height;
        let x = p.x;
        let variance = p.variance; 

        if (p.cut) {
            ctx.save();
            ctx.translate(x, groundLevel);
            ctx.rotate(Math.PI / 2 + 0.2); 
            ctx.strokeStyle = "#558B2F"; 
            ctx.lineWidth = 4;
            ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(0, -h); ctx.stroke();
            ctx.fillStyle = "#689F38";
            ctx.beginPath(); ctx.ellipse(-10, -h+10, 8, 4, 0.5, 0, Math.PI*2); ctx.fill();
            ctx.restore();
            return;
        }

        // Roots
        if (h > 5) {
            ctx.strokeStyle = "#D7CCC8";
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            ctx.moveTo(x, groundLevel);
            ctx.quadraticCurveTo(x - 10, groundLevel + 20, x - 5, groundLevel + h/2);
            ctx.moveTo(x, groundLevel);
            ctx.quadraticCurveTo(x + 10, groundLevel + 20, x + 5, groundLevel + h/2);
            ctx.stroke();
        }

        // Stem
        ctx.strokeStyle = "#4CAF50";
        ctx.lineWidth = 4;
        ctx.lineCap = "round";
        ctx.beginPath();
        ctx.moveTo(x, groundLevel);
        let curveX = x + (variance - 0.5) * 10;
        ctx.quadraticCurveTo(curveX, groundLevel - h/2, x, groundLevel - h);
        ctx.stroke();

        // Leaves
        if (h > 5) {
            ctx.fillStyle = currentState === STATES.PHYTO_PLANT ? "#AED581" : "#2E7D32";
            if (h > 20) {
                ctx.beginPath(); 
                ctx.ellipse(x - 12, groundLevel - h + 15, 12, 6, Math.PI / 4, 0, Math.PI * 2); 
                ctx.fill();
                ctx.beginPath(); 
                ctx.ellipse(x + 12, groundLevel - h + 18, 12, 6, -Math.PI / 4, 0, Math.PI * 2); 
                ctx.fill();
            }
            ctx.beginPath(); 
            ctx.ellipse(x, groundLevel - h, 8, 4, 0, 0, Math.PI * 2); 
            ctx.fill();
        }

        if (currentState === STATES.PHYTO_GROW && h < 120 + variance * 40) p.height += 0.5;
        if (currentState === STATES.PHYTO_PLANT && h < 15) p.height = 15;
    });

    if (currentState === STATES.PHYTO_GROW || currentState === STATES.PHYTO_HARVEST) {
        particles.forEach(p => {
            if (p.absorbed) return;
            let grad = ctx.createRadialGradient(p.x, p.y, 1, p.x, p.y, 6);
            grad.addColorStop(0, "#FF7043");
            grad.addColorStop(1, "rgba(255,112,67,0)");
            ctx.fillStyle = grad;
            ctx.beginPath(); ctx.arc(p.x, p.y, 6, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = "#D84315";
            ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill();
        });
    }
}

function updatePhytoParticles() {
    let activeParticles = 0;
    particles.forEach((p) => {
        if (p.absorbed) return;
        activeParticles++;

        let target = plants[0];
        let minDist = 9999;
        plants.forEach(plant => {
            let d = Math.abs(plant.x - p.x);
            if (d < minDist) { minDist = d; target = plant; }
        });

        if (minDist > 150) return;

        let dx = target.x - p.x;
        let dy = groundLevel - p.y;
        p.x += dx * 0.025;
        p.y += dy * 0.025;

        if (Math.abs(dx) < 8 && Math.abs(dy) < 8) {
            p.absorbed = true;
        }
    });
    
    if (activeParticles === 0 && currentState === STATES.PHYTO_GROW) {
        startHarvesting();
    }
}

function drawToolOverlay() {
    if (currentTool === 'seeds') {
        ctx.font = "30px Arial";
        ctx.shadowColor = "white"; ctx.shadowBlur = 10;
        ctx.fillText("üå±", mouse.x, mouse.y);
        ctx.shadowBlur = 0;
        ctx.fillStyle = "rgba(0,0,0,0.6)";
        ctx.font = "bold 14px Segoe UI";
        ctx.fillText("Drag to plant", mouse.x + 20, mouse.y);
    } else if (currentTool === 'scythe') {
        ctx.font = "30px Arial";
        ctx.shadowColor = "white"; ctx.shadowBlur = 10;
        ctx.fillText("üåæ", mouse.x, mouse.y);
        ctx.shadowBlur = 0;
        ctx.fillStyle = "rgba(0,0,0,0.6)";
        ctx.font = "bold 14px Segoe UI";
        ctx.fillText("Drag to cut", mouse.x + 20, mouse.y);
    }
}

function drawPhytoLabels() {
    if (frames < 300) {
        ctx.fillStyle = "rgba(255,255,255,0.9)";
        ctx.font = "bold 16px Segoe UI";
        ctx.fillText("Copper Ions (Red) move into roots", 100, 480);
    }
}

function drawBurning() {
    ctx.fillStyle = "#1a1a1a";
    ctx.fillRect(0, 0, 800, 550); 
    
    let gradAsh = ctx.createLinearGradient(0, 300, 0, 500);
    gradAsh.addColorStop(0, "#757575");
    gradAsh.addColorStop(1, "#424242");
    ctx.fillStyle = gradAsh;
    ctx.beginPath();
    ctx.moveTo(300, 500);
    ctx.quadraticCurveTo(400, 380, 500, 500);
    ctx.fill();
    ctx.fillStyle = "#BDBDBD";
    ctx.font = "16px Segoe UI";
    ctx.fillText("Ash (contains Copper Compounds)", 400, 530);

    ctx.globalCompositeOperation = "lighter";
    for(let i=0; i<15; i++) {
        let x = 320 + Math.random() * 160;
        let h = 50 + Math.random() * 150;
        let w = 10 + Math.random() * 20;
        if (Math.random() > 0.5) h += Math.sin(frames * 0.5) * 20;

        let gradFire = ctx.createLinearGradient(x, 500, x, 500 - h);
        gradFire.addColorStop(0, "rgba(255, 87, 34, 0.8)"); 
        gradFire.addColorStop(0.4, "rgba(255, 193, 7, 0.6)"); 
        gradFire.addColorStop(1, "rgba(255, 235, 59, 0)"); 

        ctx.fillStyle = gradFire;
        ctx.beginPath();
        ctx.ellipse(x, 500 - h/2, w, h/2, 0, 0, Math.PI*2);
        ctx.fill();
    }
    ctx.globalCompositeOperation = "source-over";
}

// --- SCENE: BIOLEACHING (OVERHAULED) ---

function initBioleaching() {
    // Generate static rocks pile
    bioRocks = [];
    const centerX = 350;
    const centerY = 350;
    // Build pyramid
    for(let row=0; row<5; row++) {
        for(let col=0; col<=row; col++) {
            let r = 25 + Math.random()*10;
            let x = centerX - (row*20) + (col*45) + Math.random()*10;
            let y = 150 + (row*40) + Math.random()*10;
            bioRocks.push({x, y, r, color: Math.random()>0.5 ? '#795548' : '#5D4037'});
        }
    }

    // Generate Bacteria
    bioBacteria = [];
    bioRocks.forEach(rock => {
        // Add 2-4 bacteria per rock
        let count = 2 + Math.floor(Math.random()*3);
        for(let i=0; i<count; i++) {
            let angle = Math.random() * Math.PI * 2;
            let dist = Math.random() * (rock.r * 0.8);
            bioBacteria.push({
                rock: rock,
                angle: angle,
                dist: dist,
                speed: 0.01 + Math.random() * 0.02,
                size: 6
            });
        }
    });

    bioDroplets = [];
}

function updateBioleaching() {
    // Spawn Water
    if(frames % 10 === 0) {
        bioDroplets.push({x: 350 + Math.random()*100 - 50, y: 50, vy: 2, state: 'water'}); // state: water or leachate
    }

    // Move Droplets
    bioDroplets.forEach(d => {
        d.y += d.vy;
        
        // Interaction with rocks
        if(d.state === 'water') {
            bioRocks.forEach(r => {
                let dx = d.x - r.x;
                let dy = d.y - r.y;
                if(Math.sqrt(dx*dx + dy*dy) < r.r + 5) {
                    d.state = 'leachate'; // Turns blue on contact
                    d.vy = 1; // Slow down trickling
                    // Jitter
                    d.x += (Math.random()-0.5)*2;
                }
            });
        }
        
        // Flow into tank
        if(d.y > 450) {
            d.vy = 0; // Stop? Or flow away?
            // Simple visual hack: remove if too low
        }
    });
    
    // Prune droplets
    bioDroplets = bioDroplets.filter(d => d.y < 500);

    // Animate Bacteria (Crawling)
    bioBacteria.forEach(b => {
        b.angle += b.speed;
        // Keep strictly on rock surface
        b.x = b.rock.x + Math.cos(b.angle) * b.dist;
        b.y = b.rock.y + Math.sin(b.angle) * b.dist;
    });
}

function drawBioleaching() {
    // Lab Bg
    let gradBg = ctx.createLinearGradient(0,0,0,550);
    gradBg.addColorStop(0, "#f5f5f5");
    gradBg.addColorStop(1, "#e0e0e0");
    ctx.fillStyle = gradBg;
    ctx.fillRect(0, 0, 800, 550);

    // 1. Sprinkler System
    ctx.strokeStyle = "#90A4AE";
    ctx.lineWidth = 6;
    ctx.beginPath();
    ctx.moveTo(350, 0); ctx.lineTo(350, 40); // Vertical pipe
    ctx.moveTo(300, 40); ctx.lineTo(400, 40); // Horizontal spray bar
    ctx.stroke();
    // Spray nozzles
    ctx.fillStyle = "#607D8B";
    for(let i=300; i<=400; i+=20) {
        ctx.fillRect(i-3, 38, 6, 8);
    }

    // 2. Collection Tank / Trough
    ctx.fillStyle = "#CFD8DC";
    ctx.beginPath();
    ctx.moveTo(150, 450);
    ctx.lineTo(550, 450);
    ctx.lineTo(530, 500);
    ctx.lineTo(170, 500);
    ctx.fill();
    ctx.strokeStyle = "#B0BEC5"; ctx.lineWidth = 2; ctx.stroke();
    
    // Liquid in tank
    ctx.fillStyle = "rgba(33, 150, 243, 0.6)";
    ctx.beginPath();
    ctx.moveTo(175, 495);
    ctx.lineTo(525, 495);
    ctx.lineTo(540, 460);
    ctx.lineTo(160, 460);
    ctx.fill();

    // 3. Rocks
    bioRocks.forEach(r => {
        ctx.fillStyle = r.color;
        ctx.beginPath();
        ctx.arc(r.x, r.y, r.r, 0, Math.PI*2);
        ctx.fill();
        // Highlight
        ctx.fillStyle = "rgba(255,255,255,0.1)";
        ctx.beginPath(); ctx.arc(r.x-5, r.y-5, r.r/3, 0, Math.PI*2); ctx.fill();
    });

    // 4. Bacteria (Rod shaped)
    ctx.fillStyle = "#76FF03"; // Bright bacteria green
    ctx.strokeStyle = "#33691E";
    ctx.lineWidth = 1;
    
    bioBacteria.forEach(b => {
        ctx.save();
        ctx.translate(b.x, b.y);
        ctx.rotate(b.angle + Math.PI/2); // Align with movement roughly
        // Draw Rod (Pill shape)
        ctx.beginPath();
        ctx.roundRect(-4, -2, 8, 4, 2); // Modern canvas API
        ctx.fill();
        ctx.stroke();
        ctx.restore();
    });

    // 5. Droplets
    bioDroplets.forEach(d => {
        if(d.state === 'water') ctx.fillStyle = "rgba(179, 229, 252, 0.8)";
        else ctx.fillStyle = "rgba(33, 150, 243, 0.8)"; // Leachate blue
        
        ctx.beginPath();
        ctx.arc(d.x, d.y, 3, 0, Math.PI*2);
        ctx.fill();
    });

    // 6. Zoom Bubble (Magnifying Glass)
    const zoomX = 600; 
    const zoomY = 250;
    const zoomR = 80;
    
    // Draw Glass
    ctx.save();
    ctx.beginPath(); ctx.arc(zoomX, zoomY, zoomR, 0, Math.PI*2); ctx.clip();
    ctx.fillStyle = "#fff"; ctx.fill();
    
    // Draw Zoomed Content (Single Rock Surface)
    ctx.fillStyle = "#795548"; ctx.fillRect(zoomX-80, zoomY-80, 160, 160);
    // Big Bacteria
    ctx.fillStyle = "#76FF03"; ctx.strokeStyle="#33691E"; ctx.lineWidth=2;
    let bTime = frames * 0.05;
    for(let i=0; i<3; i++) {
        let bx = zoomX + Math.sin(bTime+i)*20;
        let by = zoomY + Math.cos(bTime+i*2)*20 + (i*30 - 30);
        ctx.save();
        ctx.translate(bx, by);
        ctx.rotate(Math.sin(bTime)*0.5);
        ctx.beginPath(); ctx.roundRect(-15, -8, 30, 16, 8); ctx.fill(); ctx.stroke();
        // Cilia/Flagella details
        ctx.beginPath(); ctx.moveTo(-15, 0); ctx.lineTo(-25, Math.sin(frames*0.5)*5); ctx.stroke();
        ctx.restore();
    }
    // Reaction Bubbles
    ctx.strokeStyle = "#2962FF";
    ctx.beginPath(); ctx.arc(zoomX+30, zoomY-20, 5, 0, Math.PI*2); ctx.stroke();
    ctx.beginPath(); ctx.arc(zoomX+40, zoomY-35, 8, 0, Math.PI*2); ctx.stroke();
    
    ctx.restore();
    
    // Magnifying Glass Frame
    ctx.strokeStyle = "#444"; ctx.lineWidth=8;
    ctx.beginPath(); ctx.arc(zoomX, zoomY, zoomR, 0, Math.PI*2); ctx.stroke();
    // Handle
    ctx.strokeStyle = "#5D4037"; ctx.lineWidth=12;
    ctx.beginPath(); ctx.moveTo(zoomX + zoomR*0.7, zoomY + zoomR*0.7); ctx.lineTo(zoomX+100, zoomY+100); ctx.stroke();
    
    // Labels
    ctx.fillStyle = "#333";
    ctx.font = "bold 14px Segoe UI";
    ctx.fillText("Sprinkler System", 280, 30);
    ctx.fillText("Leachate Collection", 350, 530);
    ctx.fillText("Bacteria Zoom", 560, 350);
}

function drawOrePile(x, y, size) {
    // Pile shape
    ctx.fillStyle = "#5D4037";
    ctx.beginPath(); ctx.arc(x, y, size, Math.PI, 0); ctx.fill();
    
    let grad = ctx.createRadialGradient(x-30, y-30, 10, x, y, size);
    grad.addColorStop(0, "rgba(255,255,255,0.1)");
    grad.addColorStop(1, "rgba(0,0,0,0.3)");
    ctx.fillStyle = grad;
    ctx.beginPath(); ctx.arc(x, y, size, Math.PI, 0); ctx.fill();

    for(let i=0; i<25; i++) {
        let ang = Math.PI + Math.random()*Math.PI;
        let rad = Math.random() * size * 0.8;
        let px = x + Math.cos(ang)*rad;
        let py = y + Math.sin(ang)*(rad * 0.6);
        
        ctx.fillStyle = i % 2 === 0 ? "#795548" : "#4E342E";
        ctx.beginPath();
        ctx.moveTo(px, py);
        ctx.lineTo(px+10, py+5);
        ctx.lineTo(px+8, py+15);
        ctx.lineTo(px-5, py+12);
        ctx.closePath();
        ctx.fill();
    }
}

function drawBeakerScene() {
    ctx.fillStyle = "#ECEFF1"; ctx.fillRect(0,0,800,550);
    ctx.fillStyle = "#CFD8DC"; ctx.fillRect(0, 420, 800, 130);
    ctx.fillStyle = "#B0BEC5"; ctx.fillRect(0, 420, 800, 10); 

    let bx = 300, by = 150, bw = 200, bh = 300;
    
    let c = solutionColor;
    let liquidGrad = ctx.createLinearGradient(bx, by, bx+bw, by);
    liquidGrad.addColorStop(0, `rgba(${c.r}, ${c.g}, ${c.b}, 0.8)`);
    liquidGrad.addColorStop(0.5, `rgba(${c.r}, ${c.g}, ${c.b}, 0.6)`); 
    liquidGrad.addColorStop(1, `rgba(${c.r}, ${c.g}, ${c.b}, 0.8)`);
    
    ctx.fillStyle = liquidGrad;
    ctx.fillRect(bx+5, by+50, bw-10, bh-55);

    ctx.lineWidth = 4;
    ctx.strokeStyle = "rgba(176, 190, 197, 0.8)";
    ctx.strokeRect(bx, by, bw, bh);
    
    ctx.beginPath();
    ctx.ellipse(bx + bw/2, by, bw/2, 10, 0, 0, Math.PI*2);
    ctx.stroke();
    
    ctx.fillStyle = "rgba(255,255,255,0.4)";
    ctx.fillRect(bx + 10, by + 20, 20, bh - 40);
    ctx.fillRect(bx + bw - 25, by + 20, 10, bh - 40);

    if(currentState === STATES.DISPLACEMENT_REACT && reactionProgress < 1) {
        ctx.fillStyle = "rgba(255,255,255,0.6)";
        for(let i=0; i<15; i++) {
            ctx.beginPath(); 
            ctx.arc(bx + 20 + Math.random()*(bw-40), 450 - Math.random()*200, 2 + Math.random()*4, 0, Math.PI*2); 
            ctx.fill();
        }
    }

    if (reactionProgress > 0) {
        if(copperPrecipitateHeight < reactionProgress * 40) copperPrecipitateHeight += 0.5;
        ctx.fillStyle = "#D84315"; 
        ctx.beginPath();
        ctx.moveTo(bx+5, by+bh-5);
        ctx.lineTo(bx+bw-5, by+bh-5);
        ctx.lineTo(bx+bw-5, by+bh-5 - copperPrecipitateHeight);
        ctx.quadraticCurveTo(bx+bw/2, by+bh-5 - copperPrecipitateHeight - 15, bx+5, by+bh-5 - copperPrecipitateHeight);
        ctx.fill();
        
        if(reactionProgress > 0.8) {
             ctx.fillStyle = "#333"; ctx.font = "bold 16px Segoe UI"; 
             ctx.fillText("Solid Copper", bx + bw/2, by+bh - 10);
        }
    }
}

function updateReaction() {
    if (reactionProgress < 1) reactionProgress += 0.005;
}

function drawElectrolysisScene() {
    ctx.fillStyle = "#FAFAFA"; ctx.fillRect(0,0,800,550);

    const tankX = 200, tankY = 200, tankW = 400, tankH = 300;
    const wireY = 80;
    
    ctx.strokeStyle = "#555"; ctx.lineWidth = 6; ctx.strokeRect(tankX, tankY, tankW, tankH);
    
    let liqGrad = ctx.createLinearGradient(tankX, tankY, tankX, tankY+tankH);
    liqGrad.addColorStop(0, "rgba(33, 150, 243, 0.4)");
    liqGrad.addColorStop(1, "rgba(25, 118, 210, 0.7)");
    ctx.fillStyle = liqGrad;
    ctx.fillRect(tankX+5, tankY+10, tankW-10, tankH-15);

    let anodeGrad = ctx.createLinearGradient(250, 0, 250 + anodeWidth, 0);
    anodeGrad.addColorStop(0, "#8D6E63");
    anodeGrad.addColorStop(0.5, "#A1887F"); 
    anodeGrad.addColorStop(1, "#6D4C41");
    ctx.fillStyle = anodeGrad;
    ctx.fillRect(250, tankY - 40, anodeWidth, 250);
    
    let cathGrad = ctx.createLinearGradient(550 - cathodeWidth, 0, 550, 0);
    cathGrad.addColorStop(0, "#E64A19"); 
    cathGrad.addColorStop(0.5, "#FF7043");
    cathGrad.addColorStop(1, "#BF360C");
    ctx.fillStyle = cathGrad;
    ctx.fillRect(550 - cathodeWidth, tankY - 40, cathodeWidth, 250);

    particles.forEach(p => {
        if(p.type === 'sludge') {
            ctx.fillStyle = "#3E2723"; ctx.fillRect(p.x, p.y, 6, 6);
        } else if (p.type === 'ion') {
            ctx.fillStyle = "#1565C0"; ctx.beginPath(); ctx.arc(p.x, p.y, 5, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = "white"; ctx.font="8px Arial"; ctx.fillText("Cu¬≤‚Å∫", p.x-6, p.y-6);
        }
    });

    ctx.strokeStyle = "#333"; ctx.lineWidth = 4;
    ctx.beginPath(); 
    ctx.moveTo(270, tankY - 40); ctx.lineTo(270, wireY); ctx.lineTo(370, wireY);
    ctx.moveTo(530, tankY - 40); ctx.lineTo(530, wireY); ctx.lineTo(430, wireY); 
    ctx.stroke();

    ctx.fillStyle ="#FFC107"; 
    ctx.beginPath(); ctx.arc(400, wireY, 25, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle="#000"; ctx.textAlign="center"; 
    ctx.font = "bold 16px Arial"; ctx.fillText("DC", 400, wireY+6);

    ctx.fillStyle = "#333";
    ctx.font = "bold 15px Segoe UI";
    
    ctx.fillText("Impure Anode (+)", 230, 130);
    ctx.fillText("Pure Cathode (-)", 570, 130);
    
    ctx.fillStyle = "rgba(255,255,255,0.8)";
    ctx.fillRect(300, 350, 200, 30);
    ctx.fillStyle = "#01579B";
    ctx.font = "italic 16px Segoe UI";
    ctx.fillText("Cu¬≤‚Å∫ ions migrate to cathode", 400, 370);
    
    if(anodeWidth < 50) {
        ctx.fillStyle = "#3E2723";
        ctx.fillText("Sludge (Impurities)", 300, 480);
    }
}

function updateElectrolysis() {
    if (anodeWidth > 10) {
        anodeWidth -= 0.15;
        cathodeWidth += 0.12; 
        if (Math.random() < 0.15) particles.push({x: 250 + anodeWidth, y: 220 + Math.random()*200, type: 'ion', speed: 1 + Math.random()});
        if (Math.random() < 0.05) particles.push({x: 250 + Math.random()*anodeWidth, y: 450, type: 'sludge'});
    } else {
        if(document.getElementById('finish-btn').classList.contains('hidden')) {
             setDialog("Electrolysis Complete! The impure anode has dissolved. Pure copper has plated onto the cathode.", "success");
             document.getElementById('finish-btn').classList.remove('hidden');
        }
    }

    particles.forEach(p => {
        if (p.type === 'ion') {
            p.x += p.speed;
            if (p.x > 550 - cathodeWidth) p.x = 550 - cathodeWidth;
        } else if (p.type === 'sludge') {
            p.y += 2;
            if (p.y > 480) p.y = 480 + Math.random()*5;
        }
    });
}

function drawFinished() {
    ctx.fillStyle = "#fff"; ctx.fillRect(0,0,800,550);
    ctx.save(); ctx.translate(400, 275); ctx.rotate(frames * 0.005);
    ctx.fillStyle = "#FFF3E0";
    for(let i=0; i<12; i++) { ctx.rotate(Math.PI/6); ctx.fillRect(0, -40, 600, 80); }
    ctx.restore();

    ctx.fillStyle = "#333"; ctx.font = "bold 36px Segoe UI"; ctx.textAlign = "center";
    ctx.fillText("Extraction Complete!", 400, 150);
    
    let bx = 300, by = 250;
    ctx.fillStyle = "#8D6E63"; ctx.beginPath(); ctx.moveTo(bx, by); ctx.lineTo(bx+20, by-20); ctx.lineTo(bx+220, by-20); ctx.lineTo(bx+200, by); ctx.fill();
    ctx.fillStyle = "#A1887F"; ctx.fillRect(bx+200, by, 20, 60);
    ctx.beginPath(); ctx.moveTo(bx+200, by); ctx.lineTo(bx+220, by-20); ctx.lineTo(bx+220, by+40); ctx.lineTo(bx+200, by+60); ctx.fill();
    
    let gradCopper = ctx.createLinearGradient(bx, by, bx, by+60);
    gradCopper.addColorStop(0, "#D84315");
    gradCopper.addColorStop(1, "#BF360C");
    ctx.fillStyle = gradCopper;
    ctx.fillRect(bx, by, 200, 60);
    
    ctx.fillStyle = "rgba(255,255,255,0.3)";
    ctx.beginPath(); ctx.moveTo(bx, by+60); ctx.lineTo(bx+200, by); ctx.lineTo(bx+200, by-5); ctx.lineTo(bx, by+55); ctx.fill();

    ctx.fillStyle = "white"; ctx.font = "bold 24px Segoe UI"; 
    ctx.shadowColor="rgba(0,0,0,0.5)"; ctx.shadowBlur=4;
    ctx.fillText("99.9% PURE COPPER", 400, 288);
    ctx.shadowBlur=0;
}

// --- UI LOGIC ---

function showMenu() {
    currentState = STATES.MENU;
    setDialog("<b>Method Select</b><br>Traditional mining is damaging.<br>Select a sustainable biological method to begin.");
    controls.innerHTML = `
        <button onclick="startPhyto()">Start Phytomining</button>
        <button onclick="startBio()">Start Bioleaching</button>
    `;
}

function startPhyto() {
    currentState = STATES.PHYTO_PLANT;
    currentTool = 'seeds';
    plants = [];
    
    setDialog("<b>Step 1: Planting</b><br>The low-grade ore is in the soil. <br>Select the <b>Seed Bag</b> and drag your mouse across the field to plant seeds.");
    
    controls.innerHTML = `
        <button class="tool-btn" onclick="selectTool('seeds')">üí∞ Use Seed Bag</button>
        <button id="grow-btn" class="hidden" onclick="startGrowing()">Start Growing</button>
    `;
}

function selectTool(tool) {
    currentTool = tool;
}

function startGrowing() {
    currentState = STATES.PHYTO_GROW;
    currentTool = null;
    setDialog("<b>Step 2: Growing</b><br>Plants absorb copper ions through their roots. Watch the red dots move into the plants.");
    controls.innerHTML = ""; // No controls while growing
    
    particles = [];
    for(let i=0; i<80; i++) {
        particles.push({
            x: Math.random() * 800,
            y: groundLevel + 15 + Math.random() * 120,
            absorbed: false
        });
    }
}

function startHarvesting() {
    currentState = STATES.PHYTO_HARVEST;
    currentTool = 'scythe'; 
    setDialog("<b>Step 3: Harvesting</b><br>The plants are now rich in copper. <br>Use the <b>Scythe</b> and drag over plants to cut them down.");
    
    controls.innerHTML = `
        <button class="tool-btn" onclick="selectTool('scythe')">üó°Ô∏è Use Scythe</button>
        <button id="burn-btn" class="hidden" onclick="doBurn()">Burn Plants</button>
    `;
}

function doBurn() {
    currentState = STATES.PHYTO_BURN;
    setDialog("<b>Step 4: Burning</b><br>The plants are burnt. The resulting ash contains copper compounds.");
    controls.innerHTML = `<button onclick="addAcid()">Add Acid to Ash</button>`;
}

function startBio() {
    currentState = STATES.BIO_LEACH;
    frames = 0; 
    setDialog("<b>Bioleaching</b><br>Bacteria on the rocks feed on the ore. <br>The sprinkling system adds water, which the bacteria turn into an acidic copper solution (leachate).");
    initBioleaching();
    controls.innerHTML = `<button onclick="collectLeachate()">Collect Leachate</button>`;
}

function addAcid() {
    startDisplacement("Ash dissolved in acid. We now have a blue Copper Sulfate solution.");
}

function collectLeachate() {
    startDisplacement("Leachate collected. We have a blue solution rich in Copper ions.");
}

function startDisplacement(msg) {
    currentState = STATES.DISPLACEMENT_SELECT;
    solutionColor = {r: 30, g: 144, b: 255}; 
    reactionProgress = 0;
    copperPrecipitateHeight = 0;
    
    setDialog(msg + "<br><b>Step 5: Displacement</b><br>We need solid copper. Choose a metal to displace the copper:");
    
    controls.innerHTML = `
        <button class="metal-btn" onclick="tryMetal('Gold')">Gold (Au)</button>
        <button class="metal-btn" onclick="tryMetal('Zinc')">Zinc (Zn)</button>
        <button class="metal-btn" onclick="tryMetal('Iron')">Scrap Iron (Fe)</button>
    `;
}

function tryMetal(metal) {
    if (metal === 'Gold') {
        setDialog("<b>Failed.</b> Gold is less reactive than Copper.<br>It sits at the bottom and does nothing.", "error");
    } else if (metal === 'Zinc') {
        setDialog("<b>Success... but costly.</b><br>Zinc is more reactive than Copper, but it is expensive.<br><i>Zn + CuSO‚ÇÑ ‚Üí ZnSO‚ÇÑ + Cu</i>", "warning");
        runDisplacementAnim({r:245, g:245, b:245}); 
    } else if (metal === 'Iron') {
        setDialog("<b>Perfect!</b> Scrap iron is cheap and more reactive than Copper.<br><i>Fe + CuSO‚ÇÑ ‚Üí FeSO‚ÇÑ + Cu</i>", "success");
        runDisplacementAnim({r:152, g:251, b:152}); 
    }
}

function runDisplacementAnim(targetColor) {
    currentState = STATES.DISPLACEMENT_REACT;
    controls.innerHTML = ""; 
    setTimeout(() => {
        controls.innerHTML = `<button onclick="startElectrolysis()">Purify Copper (Electrolysis)</button>`;
        setDialog("We have solid copper, but it contains impurities.<br><b>Step 6: Purification</b> via Electrolysis.");
    }, 4000);
}

function startElectrolysis() {
    currentState = STATES.ELECTROLYSIS;
    particles = []; 
    anodeWidth = 60;
    cathodeWidth = 15;
    setDialog("<b>Electrolysis</b><br>Anode: Impure Copper | Cathode: Pure Copper<br>Copper ions move to the cathode. Impurities fall as sludge.");
    controls.innerHTML = `<button id="finish-btn" class="hidden" onclick="finishSim()">Finish Extraction</button>`;
}

function finishSim() {
    currentState = STATES.FINISHED;
    setDialog("<b>Module Complete</b><br>Phytomining/Bioleaching + Displacement + Electrolysis = Sustainable Copper.", "success");
    controls.innerHTML = `<button onclick="init()">Restart Simulation</button>`;
}

function setDialog(text, type="") {
    dialog.innerHTML = text;
    dialog.className = "dialog-box " + type;
}

// Start
init();

</script>
</body>
</html>
