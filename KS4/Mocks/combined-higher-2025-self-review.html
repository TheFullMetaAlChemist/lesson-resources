<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chemistry Paper 1H (Trilogy) – Question Level Analysis (June 2025)</title>
  <style>
    :root{
      --bg: #f5f7fb;
      --card: #ffffff;
      --ink: #182230;
      --muted: #52606d;
      --border: #d8e0ea;
      --soft: #eef3f8;
      --accent: #2a6fdb;
      --accent-2: #1f4fb3;

      --good-bg: #e7f7ee;
      --good-bd: #bfead1;
      --good-tx: #135a2b;

      --mid-bg: #fff6df;
      --mid-bd: #f2dfad;
      --mid-tx: #6a4b00;

      --low-bg: #fde8ea;
      --low-bd: #f4b9c0;
      --low-tx: #7a1020;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      background: var(--bg);
      color: var(--ink);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      line-height: 1.35;
    }

    .wrap{
      max-width: 1100px;
      margin: 28px auto 40px;
      padding: 0 16px;
    }

    .header{
      display:flex;
      gap: 14px;
      align-items:flex-start;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .titleblock h1{
      font-size: 22px;
      margin: 0 0 6px;
      font-weight: 780;
      letter-spacing: -0.2px;
    }
    .titleblock p{
      margin:0;
      color: var(--muted);
      font-size: 14px;
    }

    .badge{
      background: var(--soft);
      border: 1px solid var(--border);
      color: var(--muted);
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 12px;
      white-space: nowrap;
      align-self: flex-start;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 1px 0 rgba(17,24,39,0.03);
      padding: 16px;
      margin-bottom: 14px;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 900px){ .grid2{ grid-template-columns: 1fr; } }

    label{
      display:block;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px;
      font-weight: 650;
    }
    input[type="text"], input[type="number"]{
      width: 100%;
      padding: 10px 10px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fff;
      font-size: 14px;
      color: var(--ink);
      outline: none;
    }
    input[type="text"]:focus, input[type="number"]:focus, textarea:focus{
      border-color: rgba(42,111,219,0.55);
      box-shadow: 0 0 0 4px rgba(42,111,219,0.12);
    }

    .hint{
      margin: 10px 0 0;
      font-size: 12px;
      color: var(--muted);
    }

    .tablewrap{
      overflow:auto;
      border-radius: 14px;
      border: 1px solid var(--border);
      margin-top: 12px;
    }
    table{
      width:100%;
      border-collapse: collapse;
      min-width: 860px;
      background: #fff;
    }
    thead th{
      position: sticky;
      top: 0;
      background: #f0f5fb;
      border-bottom: 1px solid var(--border);
      padding: 10px 10px;
      text-align: left;
      font-size: 12.5px;
      color: #304254;
      z-index: 1;
      white-space: nowrap;
    }
    tbody td{
      border-top: 1px solid var(--border);
      padding: 8px 10px;
      vertical-align: middle;
      font-size: 13.5px;
    }
    tbody tr:hover{ background: #fbfdff; }

    .qid{
      font-weight: 800;
      letter-spacing: 0.2px;
      width: 80px;
      white-space: nowrap;
    }
    .max{
      width: 110px;
      white-space: nowrap;
      color: var(--muted);
      font-weight: 700;
    }
    .scorecell{ width: 170px; }
    .scoreinput{
      width: 120px !important;
      padding: 8px 10px !important;
      border-radius: 12px !important;
    }

    .tag{
      display:inline-flex;
      align-items:center;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--muted);
      font-size: 12px;
      font-weight: 750;
      white-space: nowrap;
    }

    .btnrow{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    button{
      appearance:none;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--ink);
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 780;
      font-size: 13.5px;
      cursor:pointer;
    }
    button.primary{
      background: var(--accent);
      border-color: var(--accent);
      color:#fff;
    }
    button.primary:hover{ background: var(--accent-2); border-color: var(--accent-2); }
    button:hover{ background: #f3f7ff; }

    .error{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--low-bd);
      background: var(--low-bg);
      color: var(--low-tx);
      font-weight: 700;
      font-size: 13px;
      display:none;
    }

    /* Report */
    .reportHeader{
      display:flex;
      gap: 10px;
      align-items: baseline;
      justify-content: space-between;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .reportHeader .who{
      font-size: 18px;
      font-weight: 850;
      letter-spacing: -0.2px;
      margin:0;
    }
    .reportHeader .meta{
      margin:0;
      color: var(--muted);
      font-size: 13px;
      font-weight: 700;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 12.5px;
      font-weight: 800;
      color: #2a3a4a;
    }
    .pill strong{ font-weight: 950; }

    .sectionTitle{
      margin: 0 0 10px;
      font-size: 14px;
      font-weight: 900;
      letter-spacing: -0.1px;
      color: #243243;
    }

    .topicList{
      display:flex;
      flex-direction: column;
      gap: 8px;
    }
    .topicRow{
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px 12px;
      background: #fff;
      display:flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
    }
    .topicRow .left{ min-width: 0; }
    .topicRow .name{
      font-weight: 900;
      font-size: 13.5px;
      margin:0 0 3px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 520px;
    }
    .topicRow .sub{
      margin:0;
      color: var(--muted);
      font-size: 12.5px;
      font-weight: 750;
    }
    .topicRow .right{
      display:flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 3px;
      white-space: nowrap;
    }
    .topicRow .pct{
      font-weight: 950;
      font-size: 13.5px;
    }
    .topicRow.good{ background: var(--good-bg); border-color: var(--good-bd); }
    .topicRow.good .pct{ color: var(--good-tx); }
    .topicRow.mid{ background: var(--mid-bg); border-color: var(--mid-bd); }
    .topicRow.mid .pct{ color: var(--mid-tx); }
    .topicRow.low{ background: var(--low-bg); border-color: var(--low-bd); }
    .topicRow.low .pct{ color: var(--low-tx); }

    .skillBox{
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      background: #fff;
      margin-bottom: 10px;
    }
    .skillBox h3{
      margin:0 0 8px;
      font-size: 13.5px;
      font-weight: 950;
      color:#243243;
    }
    .skillLine{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      padding: 8px 0;
      border-top: 1px solid var(--border);
      font-size: 13px;
      font-weight: 780;
    }
    .skillLine:first-of-type{ border-top: none; padding-top: 0; }
    .skillLine span{
      color: var(--muted);
      font-weight: 800;
    }

    textarea{
      width: 100%;
      min-height: 130px;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 14px;
      color: var(--ink);
      resize: vertical;
    }

    .smallnote{
      color: var(--muted);
      font-size: 12.5px;
      margin: 10px 0 0;
    }

    .hidden{ display:none !important; }

    /* Print styles: report only */
    @media print{
      body{ background:#fff; }
      .wrap{ max-width: none; margin: 0; padding: 0; }
      .noPrint{ display:none !important; }
      .card{ border:none; box-shadow:none; border-radius: 0; padding: 0; }
      .topicRow{ break-inside: avoid; }
      textarea{ min-height: 140px; }
      .badge{ display:none; }
      .header{ margin-bottom: 10px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div class="titleblock">
        <h1>Chemistry Paper 1H – Question Level Analysis</h1>
        <p>AQA GCSE Combined Science: Trilogy (June 2025) • Higher Tier • Max: 70</p>
      </div>
      <div class="badge">Light theme • Report prints cleanly</div>
    </div>

    <!-- INPUT SECTION -->
    <div id="inputSection" class="card noPrint">
      <div class="grid2">
        <div>
          <label for="studentName">Student name</label>
          <input id="studentName" type="text" placeholder="e.g., Alex Turner" autocomplete="name">
        </div>
        <div>
          <label for="studentGrade">Grade (target or achieved)</label>
          <input id="studentGrade" type="text" placeholder="e.g., 7 / 6-5 / Target 8" autocomplete="off">
        </div>
      </div>

      <p class="hint">
        Enter your marks for each sub-question. Use <strong>Tab</strong> to move quickly between boxes.
        Scores must be whole numbers between <strong>0</strong> and the <strong>max</strong>.
      </p>

      <div class="tablewrap" aria-label="Score entry table">
        <table>
          <thead>
            <tr>
              <th style="width:90px;">Q</th>
              <th>Sub-question focus</th>
              <th style="width:120px;">Max</th>
              <th style="width:190px;">Your score</th>
              <th style="width:140px;">Quick tags</th>
            </tr>
          </thead>
          <tbody id="scoreRows"></tbody>
        </table>
      </div>

      <div id="errorBox" class="error" role="alert"></div>

      <div class="btnrow">
        <button class="primary" id="generateBtn">Generate report</button>
        <button id="fillZerosBtn" title="Fills any empty boxes with 0">Fill blanks with 0</button>
        <button id="resetBtn" title="Clears all scores">Reset</button>
      </div>
    </div>

    <!-- REPORT SECTION -->
    <div id="reportSection" class="card hidden">
      <div class="reportHeader">
        <div>
          <p class="who" id="reportName">Report</p>
          <p class="meta" id="reportMeta"></p>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <div class="pill">Overall score: <strong id="overallScore">0/70</strong></div>
          <div class="pill">Overall %: <strong id="overallPct">0%</strong></div>
        </div>
      </div>

      <div class="grid2">
        <!-- LEFT COLUMN -->
        <div>
          <h2 class="sectionTitle">Topic performance (strongest → weakest)</h2>
          <div id="topicList" class="topicList"></div>
          <p class="smallnote">
            Traffic lights: Green ≥ 70% • Amber 40–69% • Red &lt; 40%
          </p>
        </div>

        <!-- RIGHT COLUMN -->
        <div>
          <h2 class="sectionTitle">Skills summary</h2>

          <div class="skillBox">
            <h3>Assessment objectives</h3>
            <div class="skillLine"><span>AO1</span><div id="ao1Line">–</div></div>
            <div class="skillLine"><span>AO2</span><div id="ao2Line">–</div></div>
            <div class="skillLine"><span>AO3</span><div id="ao3Line">–</div></div>
          </div>

          <div class="skillBox">
            <h3>Maths & working scientifically</h3>
            <div class="skillLine"><span>Maths skills (MS)</span><div id="msLine">–</div></div>
            <div class="skillLine"><span>Working scientifically (WS)</span><div id="wsLine">–</div></div>
          </div>

          <div class="skillBox">
            <h3>Action / revision plan</h3>
            <label class="hidden" for="actionPlan">Action plan</label>
            <textarea id="actionPlan" placeholder="Write your next steps here (e.g. revise weakest topics, practise similar questions, make flashcards, do corrections, etc.)."></textarea>
            <p class="smallnote">This box will appear on your printed PDF.</p>
          </div>
        </div>
      </div>

      <div class="btnrow noPrint">
        <button class="primary" id="printBtn">Print / Save as PDF</button>
        <button id="editBtn">Edit scores</button>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // DATA (Individual sub-questions)
    // =========================

    const TOTAL_PAPER_MARKS = 70;

    // Exactly 10 content topics (sub-spec feel, capped as requested)
    const TOPICS = [
      "Electrolysis & ionic structures",
      "Quantitative chemistry (concentration, moles & equations)",
      "Energy changes in reactions",
      "Atomic structure & ions",
      "Group 7 properties & reactivity",
      "Reactivity of metals & extraction",
      "Metallic bonding & alloys",
      "Acids, pH & ionisation",
      "Conservation of mass & reactions",
      "Covalent bonding & carbon structures"
    ];

    // Each sub-question:
    // - id: "1.1" etc (as student sees it)
    // - label: short focus
    // - max: from paper
    // - topic: ONE topic only
    // - ao: split across AO1/2/3 (usually one; some questions split)
    // - msMarks: marks in this question that are maths skill assessed
    // - wsMarks: marks linked to Working Scientifically (non-granular)
    const ITEMS = [
      // Q1
      { id:"1.1", label:"Electrolysis safety (chlorine risk control)", max:1,
        topic:TOPICS[0], ao:{AO1:0, AO2:0, AO3:1}, msMarks:0, wsMarks:1 },
      { id:"1.2", label:"Plot graph + line of best fit (mass vs time)", max:3,
        topic:TOPICS[0], ao:{AO1:0, AO2:3, AO3:0}, msMarks:3, wsMarks:3 },
      { id:"1.3", label:"Use results to challenge hypothesis (pattern/trend)", max:1,
        topic:TOPICS[0], ao:{AO1:0, AO2:0, AO3:1}, msMarks:0, wsMarks:1 },
      { id:"1.4", label:"Concentration calculation (g/dm³)", max:3,
        topic:TOPICS[1], ao:{AO1:0, AO2:3, AO3:0}, msMarks:3, wsMarks:0 },
      { id:"1.5", label:"Reactivity series explanation (why H₂ forms in KCl electrolysis)", max:1,
        topic:TOPICS[0], ao:{AO1:0, AO2:1, AO3:0}, msMarks:0, wsMarks:0 },

      // Q2
      { id:"2.1", label:"Define exothermic reaction", max:1,
        topic:TOPICS[2], ao:{AO1:1, AO2:0, AO3:0}, msMarks:0, wsMarks:0 },
      { id:"2.2", label:"% by mass of oxygen in Ca(OH)₂", max:3,
        topic:TOPICS[1], ao:{AO1:0, AO2:3, AO3:0}, msMarks:3, wsMarks:0 },
      { id:"2.3", label:"Plan method (mass of CaO vs temperature change)", max:6,
        topic:TOPICS[2], ao:{AO1:6, AO2:0, AO3:0}, msMarks:0, wsMarks:6 },

      // Q3
      { id:"3.1", label:"Alpha scattering conclusions (tick two)", max:2,
        topic:TOPICS[3], ao:{AO1:2, AO2:0, AO3:0}, msMarks:0, wsMarks:0 },
      { id:"3.2", label:"Why particle X is not an atom (subatomic particles)", max:1,
        topic:TOPICS[3], ao:{AO1:0, AO2:0, AO3:1}, msMarks:0, wsMarks:0 },
      { id:"3.3", label:"Representation of particle X (use periodic table)", max:1,
        topic:TOPICS[3], ao:{AO1:0, AO2:1, AO3:0}, msMarks:0, wsMarks:0 },
      { id:"3.4", label:"Explain Group 7 boiling point trend", max:3,
        topic:TOPICS[4], ao:{AO1:3, AO2:0, AO3:0}, msMarks:0, wsMarks:0 },
      { id:"3.5", label:"Bonding type in ClF₃", max:1,
        topic:TOPICS[9], ao:{AO1:1, AO2:0, AO3:0}, msMarks:0, wsMarks:0 },
      { id:"3.6", label:"Displacement word equation (Cl₂ + NaBr)", max:1,
        topic:TOPICS[4], ao:{AO1:0, AO2:1, AO3:0}, msMarks:0, wsMarks:0 },
      { id:"3.7", label:"Explain why Group 7 reactivity decreases down group", max:3,
        topic:TOPICS[4], ao:{AO1:3, AO2:0, AO3:0}, msMarks:0, wsMarks:0 },

      // Q4
      { id:"4.1", label:"Why iron can be extracted with carbon (reactivity)", max:1,
        topic:TOPICS[5], ao:{AO1:1, AO2:0, AO3:0}, msMarks:0, wsMarks:0 },
      { id:"4.2", label:"Why cryolite is used with aluminium oxide", max:2,
        topic:TOPICS[5], ao:{AO1:2, AO2:0, AO3:0}, msMarks:0, wsMarks:0 },
      { id:"4.3", label:"Half-equation for oxygen at positive electrode", max:2,
        topic:TOPICS[5], ao:{AO1:0, AO2:2, AO3:0}, msMarks:0, wsMarks:0 },
      { id:"4.4", label:"Identify which substance is reduced (chromium extraction)", max:1,
        topic:TOPICS[5], ao:{AO1:0, AO2:1, AO3:0}, msMarks:0, wsMarks:0 },
      { id:"4.5", label:"Reason for aluminium vs iron extraction cost difference", max:1,
        topic:TOPICS[5], ao:{AO1:0, AO2:0, AO3:1}, msMarks:0, wsMarks:0 },
      { id:"4.6", label:"Reason for aluminium vs chromium extraction cost difference", max:1,
        topic:TOPICS[5], ao:{AO1:0, AO2:0, AO3:1}, msMarks:0, wsMarks:0 },
      { id:"4.7", label:"Why alloys are harder than pure metals", max:3,
        topic:TOPICS[6], ao:{AO1:3, AO2:0, AO3:0}, msMarks:0, wsMarks:0 },

      // Q5
      { id:"5.1", label:"State symbols (HCl, water, hydrochloric acid)", max:1,
        topic:TOPICS[7], ao:{AO1:0, AO2:1, AO3:0}, msMarks:0, wsMarks:0 },
      { id:"5.2", label:"pH to [H⁺] (standard form)", max:1,
        topic:TOPICS[7], ao:{AO1:0, AO2:1, AO3:0}, msMarks:1, wsMarks:0 },
      { id:"5.3", label:"Complete dot-and-cross diagram (HOCl)", max:2,
        topic:TOPICS[9], ao:{AO1:0, AO2:2, AO3:0}, msMarks:0, wsMarks:0 },
      { id:"5.4", label:"Weak vs strong acid (ionisation and pH)", max:2,
        topic:TOPICS[7], ao:{AO1:2, AO2:0, AO3:0}, msMarks:0, wsMarks:0 },
      { id:"5.5", label:"Bond energies overall energy change", max:3,
        topic:TOPICS[2], ao:{AO1:0, AO2:3, AO3:0}, msMarks:3, wsMarks:0 },

      // Q6
      { id:"6.1", label:"Why use Bunsen burner not water bath (heating solids)", max:1,
        topic:TOPICS[8], ao:{AO1:0, AO2:0, AO3:1}, msMarks:0, wsMarks:1 },
      // 6.2 has 4 marks split AO2/AO3/AO2/AO3 in mark scheme
      { id:"6.2", label:"Explain trends for first 3 minutes (two graphs)", max:4,
        topic:TOPICS[8], ao:{AO1:0, AO2:2, AO3:2}, msMarks:0, wsMarks:4 },
      { id:"6.3", label:"Why final mass is same for both reactions", max:1,
        topic:TOPICS[8], ao:{AO1:0, AO2:0, AO3:1}, msMarks:0, wsMarks:0 },
      { id:"6.4", label:"Use results to challenge conclusion (predicted vs actual)", max:1,
        topic:TOPICS[8], ao:{AO1:0, AO2:0, AO3:1}, msMarks:0, wsMarks:1 },
      { id:"6.5", label:"Determine balanced equation from moles (Fe + steam)", max:4,
        topic:TOPICS[1], ao:{AO1:0, AO2:4, AO3:0}, msMarks:4, wsMarks:0 },

      // Q7
      { id:"7.1", label:"Limitations of model A compared with model B (NaCl)", max:2,
        topic:TOPICS[0], ao:{AO1:0, AO2:0, AO3:2}, msMarks:0, wsMarks:0 },
      { id:"7.2", label:"Formula of aluminium sulfate from ions", max:1,
        topic:TOPICS[0], ao:{AO1:0, AO2:1, AO3:0}, msMarks:0, wsMarks:0 },
      { id:"7.3", label:"Why aluminium conducts better than sodium", max:1,
        topic:TOPICS[6], ao:{AO1:0, AO2:1, AO3:0}, msMarks:0, wsMarks:0 },
      { id:"7.4", label:"Compare SiO₂ and poly(ethene) (structure & bonding)", max:4,
        topic:TOPICS[9], ao:{AO1:4, AO2:0, AO3:0}, msMarks:0, wsMarks:0 },
    ];

    // =========================
    // BUILD INPUT TABLE
    // =========================
    const scoreRowsEl = document.getElementById("scoreRows");

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function tagText(item){
      const tags = [];
      // AO tag
      if(item.ao.AO1) tags.push("AO1");
      if(item.ao.AO2) tags.push("AO2");
      if(item.ao.AO3) tags.push("AO3");
      // MS/WS
      if(item.msMarks > 0) tags.push("MS");
      if(item.wsMarks > 0) tags.push("WS");
      return tags;
    }

    function renderInputRows(){
      scoreRowsEl.innerHTML = "";
      ITEMS.forEach((it) => {
        const tr = document.createElement("tr");
        const tags = tagText(it).map(t => `<span class="tag">${t}</span>`).join(" ");
        tr.innerHTML = `
          <td class="qid">${it.id}</td>
          <td>${escapeHtml(it.label)}</td>
          <td class="max">${it.max} mark${it.max===1?"":"s"}</td>
          <td class="scorecell">
            <input
              class="scoreinput"
              type="number"
              inputmode="numeric"
              min="0"
              max="${it.max}"
              step="1"
              id="score_${it.id}"
              aria-label="Score for ${it.id}"
              placeholder="0–${it.max}"
            />
          </td>
          <td>${tags || ""}</td>
        `;
        scoreRowsEl.appendChild(tr);
      });
    }

    renderInputRows();

    // =========================
    // HELPERS + VALIDATION
    // =========================
    const errorBox = document.getElementById("errorBox");

    function showError(msg){
      errorBox.textContent = msg;
      errorBox.style.display = "block";
    }
    function clearError(){
      errorBox.textContent = "";
      errorBox.style.display = "none";
    }

    function getScore(id){
      const el = document.getElementById(`score_${id}`);
      const raw = (el.value ?? "").trim();
      if(raw === "") return null;
      const n = Number(raw);
      if(Number.isNaN(n)) return null;
      return n;
    }

    function setScore(id, val){
      document.getElementById(`score_${id}`).value = val;
    }

    function clamp(n, min, max){
      return Math.min(max, Math.max(min, n));
    }

    function classifyTraffic(pct){
      if(pct >= 70) return "good";
      if(pct >= 40) return "mid";
      return "low";
    }

    function fmtPct(num){
      if(!Number.isFinite(num)) return "0%";
      return `${Math.round(num)}%`;
    }

    function fmtLine(got, total){
      const pct = total > 0 ? (got/total)*100 : 0;
      return `${Math.round(pct)}% (${got}/${total})`;
    }

    // =========================
    // CALCULATE REPORT
    // =========================
    function calculate(){
      const name = (document.getElementById("studentName").value || "").trim();
      const grade = (document.getElementById("studentGrade").value || "").trim();

      let totalGot = 0;

      for(const it of ITEMS){
        const s = getScore(it.id);
        if(s === null){
          showError(`Please fill every score box (or click “Fill blanks with 0”). Missing: ${it.id}`);
          return null;
        }
        if(!Number.isInteger(s) || s < 0 || s > it.max){
          showError(`Check ${it.id}: scores must be whole numbers between 0 and ${it.max}.`);
          return null;
        }
        totalGot += s;
      }

      clearError();

      // Topic totals
      const topicTotals = new Map();
      TOPICS.forEach(t => topicTotals.set(t, { topic:t, got:0, total:0 }));

      // AO totals
      const aoTotals = { AO1:{got:0,total:0}, AO2:{got:0,total:0}, AO3:{got:0,total:0} };

      // MS and WS totals
      let msTotal = 0, msGot = 0;
      let wsTotal = 0, wsGot = 0;

      // For each item, allocate "got" proportionally into AO/MS/WS for fairness
      for(const it of ITEMS){
        const s = getScore(it.id);
        const ratio = it.max > 0 ? (s / it.max) : 0;

        // Topic
        const t = topicTotals.get(it.topic) || { topic:it.topic, got:0, total:0 };
        t.total += it.max;
        t.got += s;
        topicTotals.set(it.topic, t);

        // AO proportional
        for(const k of ["AO1","AO2","AO3"]){
          const part = it.ao[k] || 0;
          aoTotals[k].total += part;
          aoTotals[k].got += part * ratio;
        }

        // MS / WS proportional
        if(it.msMarks && it.msMarks > 0){
          msTotal += it.msMarks;
          msGot += it.msMarks * ratio;
        }
        if(it.wsMarks && it.wsMarks > 0){
          wsTotal += it.wsMarks;
          wsGot += it.wsMarks * ratio;
        }
      }

      const topicsArr = Array.from(topicTotals.values())
        .filter(t => t.total > 0)
        .map(t => ({...t, pct: (t.got / t.total) * 100}))
        .sort((a,b) => b.pct - a.pct);

      const overallPct = (totalGot / TOTAL_PAPER_MARKS) * 100;

      return {
        student: { name: name || "Student", grade: grade || "—" },
        overall: { got: totalGot, total: TOTAL_PAPER_MARKS, pct: overallPct },
        topics: topicsArr,
        aos: aoTotals,
        ms: { got: msGot, total: msTotal },
        ws: { got: wsGot, total: wsTotal }
      };
    }

    // =========================
    // RENDER REPORT
    // =========================
    function renderReport(result){
      document.getElementById("reportName").textContent = `${result.student.name} – Report`;
      document.getElementById("reportMeta").textContent =
        `Grade: ${result.student.grade} • Chemistry Paper 1H (Trilogy) • June 2025`;

      document.getElementById("overallScore").textContent = `${result.overall.got}/${result.overall.total}`;
      document.getElementById("overallPct").textContent = fmtPct(result.overall.pct);

      // Topics
      const list = document.getElementById("topicList");
      list.innerHTML = "";
      result.topics.forEach(t => {
        const cls = classifyTraffic(t.pct);
        const div = document.createElement("div");
        div.className = `topicRow ${cls}`;
        div.innerHTML = `
          <div class="left">
            <p class="name">${escapeHtml(t.topic)}</p>
            <p class="sub">${t.got}/${t.total} marks</p>
          </div>
          <div class="right">
            <div class="pct">${fmtPct(t.pct)}</div>
            <div class="sub">${t.got}/${t.total}</div>
          </div>
        `;
        list.appendChild(div);
      });

      // AO lines (display as whole marks)
      const ao1g = Math.round(result.aos.AO1.got);
      const ao2g = Math.round(result.aos.AO2.got);
      const ao3g = Math.round(result.aos.AO3.got);

      document.getElementById("ao1Line").textContent = fmtLine(ao1g, result.aos.AO1.total);
      document.getElementById("ao2Line").textContent = fmtLine(ao2g, result.aos.AO2.total);
      document.getElementById("ao3Line").textContent = fmtLine(ao3g, result.aos.AO3.total);

      // MS & WS (whole marks for display)
      const msg = Math.round(result.ms.got);
      const wsg = Math.round(result.ws.got);

      document.getElementById("msLine").textContent =
        result.ms.total > 0 ? fmtLine(msg, result.ms.total) : "—";
      document.getElementById("wsLine").textContent =
        result.ws.total > 0 ? fmtLine(wsg, result.ws.total) : "—";
    }

    // =========================
    // BUTTONS
    // =========================
    const inputSection = document.getElementById("inputSection");
    const reportSection = document.getElementById("reportSection");

    document.getElementById("generateBtn").addEventListener("click", () => {
      const result = calculate();
      if(!result) return;
      renderReport(result);

      inputSection.classList.add("hidden");
      reportSection.classList.remove("hidden");
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    document.getElementById("editBtn").addEventListener("click", () => {
      reportSection.classList.add("hidden");
      inputSection.classList.remove("hidden");
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    document.getElementById("printBtn").addEventListener("click", () => {
      window.print();
    });

    document.getElementById("fillZerosBtn").addEventListener("click", () => {
      ITEMS.forEach(it => {
        const v = getScore(it.id);
        if(v === null) setScore(it.id, 0);
      });
      clearError();
    });

    document.getElementById("resetBtn").addEventListener("click", () => {
      document.getElementById("studentName").value = "";
      document.getElementById("studentGrade").value = "";
      ITEMS.forEach(it => setScore(it.id, ""));
      document.getElementById("actionPlan").value = "";
      clearError();
    });

    // Gentle clamp on blur (prevents accidental out-of-range values)
    document.addEventListener("focusout", (e) => {
      const el = e.target;
      if(el && el.id && el.id.startsWith("score_")){
        const id = el.id.replace("score_","");
        const it = ITEMS.find(x => x.id === id);
        if(!it) return;

        const raw = (el.value ?? "").trim();
        if(raw === "") return;

        let n = Number(raw);
        if(Number.isNaN(n)) { el.value = ""; return; }

        n = Math.round(n);
        n = clamp(n, 0, it.max);
        el.value = n;
      }
    });
  </script>
</body>
</html>
