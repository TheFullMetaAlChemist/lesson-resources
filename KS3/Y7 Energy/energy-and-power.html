<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KS3 Physics: Food and Fuels v3</title>
    <style>
        /* Basic Reset & Body Styling */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
             scroll-behavior: smooth; /* Smooth scrolling if needed */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            background-color: #f0f4f8;
            color: #333;
            padding-bottom: 70px; /* Increased Space for footer + calc toggle */
        }

        /* Main Container */
        .container {
            max-width: 1000px;
            margin: 20px auto;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: #fff;
            padding: 20px;
            text-align: center;
            border-bottom: 4px solid #004085;
        }

        header h1 { margin-bottom: 5px; font-size: 2.5em; }
        header h2 { font-weight: normal; font-size: 1.2em; }

        /* Main Navigation Tabs */
        .tab-nav { display: flex; background-color: #e9ecef; border-bottom: 1px solid #dee2e6; }
        .tab-button { flex-grow: 1; padding: 15px 20px; cursor: pointer; background-color: #e9ecef; border: none; border-right: 1px solid #dee2e6; font-size: 1.1em; color: #495057; transition: background-color 0.3s, color 0.3s; text-align: center; }
        .tab-button:last-child { border-right: none; }
        .tab-button:hover { background-color: #d4dadf; }
        .tab-button.active { background-color: #007bff; color: #fff; font-weight: bold; }

        /* Tab Content Area */
        .tab-content { padding: 25px; display: none; }
        .tab-content.active { display: block; }

        /* Tutorial Sub-Tabs */
        .tutorial-sub-nav { display: flex; flex-wrap: wrap; background-color: #f8f9fa; margin-bottom: 20px; border-radius: 5px; border: 1px solid #dee2e6; padding: 5px; }
        .tutorial-sub-button { padding: 8px 15px; cursor: pointer; background-color: transparent; border: none; border-radius: 4px; font-size: 0.95em; color: #007bff; margin: 2px; transition: background-color 0.3s, color 0.3s; }
        .tutorial-sub-button:hover { background-color: #e2e6ea; }
        .tutorial-sub-button.active { background-color: #007bff; color: #fff; font-weight: bold; }
        .tutorial-sub-content { display: none; padding-top: 10px; border-top: 1px solid #eee; margin-top: -1px; }
        .tutorial-sub-content.active { display: block; }

        /* General Content Styling */
        h3 { color: #0056b3; margin-top: 20px; margin-bottom: 10px; border-bottom: 2px solid #e0e0e0; padding-bottom: 5px; }
        h4 { color: #0067cc; margin-top: 15px; margin-bottom: 8px; }
        h5 { color: #333; margin-top: 10px; margin-bottom: 5px; font-size: 1.1em; }
        p, ul, li { margin-bottom: 10px; }
        ul { margin-left: 20px; }
        code { background-color: #f1f1f1; padding: 2px 5px; border-radius: 3px; font-family: monospace; }
        strong { color: #0056b3; }
        .highlight-box { background-color: #e7f3ff; border-left: 4px solid #007bff; padding: 15px; margin: 15px 0; border-radius: 4px; }
        .highlight-box.fact { background-color: #fffbe7; border-left: 4px solid #ffcc00; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
        th { background-color: #f2f2f2; font-weight: bold; }
        tr:nth-child(even) { background-color: #f9f9f9; }

        /* Interactive Elements */
        button, .sim-button, .menu-check-button, .calc-toggle-button { background-color: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 1em; transition: background-color 0.3s; margin: 5px; }
        button:hover, .sim-button:hover, .menu-check-button:hover, .calc-toggle-button:hover { background-color: #0056b3; }
        button:disabled, .sim-button:disabled, .menu-check-button:disabled { background-color: #cccccc; cursor: not-allowed; }
        .reveal-answer { color: #007bff; cursor: pointer; text-decoration: underline; margin-left: 10px; }
        .answer-hidden { font-style: italic; color: #777; }
        .answer-shown { font-weight: bold; color: #28a745; }
        input[type="text"], input[type="number"], select { padding: 8px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px; min-width: 100px; }

        /* Simulation Styles */
        .simulation-container { display: flex; gap: 20px; align-items: flex-start; margin-top: 20px; flex-wrap: wrap; }
        .sim-controls { flex: 1; min-width: 200px; }
        .sim-visuals { flex: 2; min-width: 350px; background-color: #f8f9fa; padding: 10px; border-radius: 5px; border: 1px solid #dee2e6; position: relative; height: 370px; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; }
        #sim-stand { width: 100px; height: 250px; border-left: 5px solid #555; border-bottom: 5px solid #555; position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; justify-content: center; }
        #sim-tube { width: 50px; height: 150px; border: 3px solid #add8e6; border-top: none; background: linear-gradient(to top, #6495ed 50%, transparent 50%); position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%); border-radius: 0 0 15px 15px; overflow: hidden; }
        #sim-thermometer { width: 10px; height: 130px; background-color: #eee; border: 1px solid #bbb; border-radius: 5px 5px 0 0; position: absolute; bottom: 105px; left: calc(50% + 10px); transform: translateX(-50%); z-index: 10; }
        #sim-thermo-liquid { width: 4px; height: 20%; background-color: red; position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); border-radius: 2px; transition: height 1s ease-out; }
        #sim-thermo-bulb { width: 10px; height: 10px; background-color: red; border-radius: 50%; position: absolute; bottom: 0px; left: 50%; transform: translateX(-50%); }
        #sim-food { width: 40px; height: 30px; background-color: #deb887; position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); text-align: center; line-height: 30px; font-size: 0.8em; color: #fff; border-radius: 3px; z-index: 5; }
        #sim-flame { width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-bottom: 30px solid orange; position: absolute; bottom: 65px; left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.5s; z-index: 6; }
        #sim-flame.burning { opacity: 0.9; animation: flicker 0.2s infinite alternate; }
        @keyframes flicker { 0% { border-bottom-color: orange; transform: translateX(-50%) scaleY(1) scaleX(1); } 50% { border-bottom-color: yellow; transform: translateX(-45%) scaleY(0.95) scaleX(1.05); } 100% { border-bottom-color: orangered; transform: translateX(-55%) scaleY(1.05) scaleX(0.95); } }
        #sim-results { position: absolute; top: 10px; right: 10px; background: rgba(255, 255, 255, 0.85); padding: 8px 12px; border-radius: 5px; border: 1px solid #ddd; font-size: 0.9em; text-align: right; box-shadow: 0 1px 3px rgba(0,0,0,0.1); z-index: 20; }
        #sim-results table { margin: 0; width: auto; }
        #sim-results td { padding: 3px 5px; border: none; }
        #sim-results td:first-child { font-weight: bold; padding-right: 10px; }

        /* Practice Section */
        .question { background-color: #f9f9f9; border: 1px solid #eee; padding: 15px; margin-bottom: 15px; border-radius: 5px; }
        .question p { margin-bottom: 8px; }
        .feedback { margin-top: 10px; font-weight: bold; padding: 8px; border-radius: 4px; display: none; }
        .feedback.correct { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; display: block; }
        .feedback.incorrect { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; display: block; }
        .word-bank { background-color: #f0f0f0; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 0.9em; border: 1px dashed #ccc; }
        .word-bank strong { color: #333; }
        .word-bank code { background-color: #e0e0e0; }

        /* Game Section */
        .game-container { display: flex; gap: 20px; flex-wrap: wrap; }
        .game-status, .game-actions { flex: 1; min-width: 280px; /* Wider for more buttons */ background-color: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6; }
        #energy-bar-container { width: 100%; height: 30px; background-color: #e9ecef; border-radius: 15px; overflow: hidden; margin: 10px 0; border: 1px solid #ccc; }
        #energy-bar { height: 100%; width: 50%; background-color: #28a745; border-radius: 15px 0 0 15px; transition: width 0.5s ease-in-out, background-color 0.5s; text-align: right; color: white; font-size: 0.8em; line-height: 30px; padding-right: 5px; }
        #game-message { margin-top: 10px; font-weight: bold; min-height: 20px; }
        .game-buttons button { display: block; width: calc(50% - 10px); /* Two columns */ margin: 5px; float: left; font-size: 0.9em; padding: 8px 10px; }
         .game-buttons::after { content:""; display:table; clear:both; } /* Clear float */
        .game-note { font-size: 0.9em; color: #666; margin-top: 0px; margin-bottom: 10px; clear: both; padding-top: 5px; }
        .game-explanation { clear: both; margin-top: 20px; padding: 15px; background-color: #fffbe7; border: 1px solid #ffeeba; border-radius: 5px; font-size: 0.95em; }
        .game-explanation h5 { margin-top: 0; color: #856404; }

        /* Menu Planner Section */
        .menu-planner-container { display: flex; gap: 30px; flex-wrap: wrap; }
        .menu-controls, .menu-summary { flex: 1; min-width: 280px; }
        #menu-food-options button { background-color: #e7f3ff; color: #0056b3; border: 1px solid #b8daff; padding: 5px 10px; margin: 3px; font-size: 0.9em; cursor: pointer; border-radius: 4px; transition: background-color 0.2s, transform 0.1s; }
        #menu-food-options button:hover { background-color: #cce5ff; }
        #menu-food-options button.selected { background-color: #007bff; color: white; border-color: #0056b3; font-weight: bold; transform: scale(1.05); }
        #menu-food-options button span { font-size: 0.85em; color: #555; }
        #menu-food-options button.selected span { color: #eee; }
        #selected-menu-items { list-style: none; padding-left: 0; max-height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 10px; margin-bottom: 10px; background-color: #fdfdfd; }
        #selected-menu-items li { margin-bottom: 5px; padding-bottom: 5px; border-bottom: 1px dashed #eee; }
        #selected-menu-items li:last-child { border-bottom: none; }
        #menu-total-kj, #menu-target-kj { font-weight: bold; }
        #menu-feedback { margin-top: 15px; font-weight: bold; padding: 10px; border-radius: 5px; display: none; }

         /* Floating Calculator Styles */
        #calculator {
            position: fixed;
            bottom: 60px; /* Above footer/toggle */
            right: 20px;
            width: 260px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none; /* Hidden by default */
            overflow: hidden; /* Important for minimize */
            transition: height 0.3s ease;
        }
        #calculator.minimized {
            height: 35px; /* Just enough for header */
        }
        #calc-header {
            padding: 5px 10px;
            cursor: move;
            background-color: #d0d0d0;
            border-bottom: 1px solid #ccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 35px;
        }
        #calc-header span { font-weight: bold; font-size: 0.9em; }
        #calc-controls button {
            background: #aaa;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 6px;
            font-size: 0.8em;
            line-height: 1;
            cursor: pointer;
            margin-left: 4px;
        }
         #calc-controls button:hover { background: #888; }
        #calc-body { padding: 10px; }
        #calc-display {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            font-size: 1.2em;
            text-align: right;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #fff;
        }
        .calc-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
        }
        .calc-buttons button {
            padding: 10px;
            font-size: 1em;
            background-color: #e0e0e0;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            color: #333;
             margin: 0; /* Override general button margin */
        }
        .calc-buttons button:hover { background-color: #d0d0d0; }
        .calc-buttons button.operator { background-color: #ffae42; color: white; } /* Orange */
        .calc-buttons button.operator:hover { background-color: #ff8c00; }
        .calc-buttons button.equals { background-color: #007bff; color: white; grid-column: span 2; } /* Blue */
        .calc-buttons button.equals:hover { background-color: #0056b3; }
        .calc-buttons button.clear { background-color: #dc3545; color: white; } /* Red */
        .calc-buttons button.clear:hover { background-color: #c82333; }

         /* Calculator Toggle Button */
         .calc-toggle-button {
             position: fixed;
             bottom: 15px;
             right: 20px;
             z-index: 1001; /* Above calculator when closed */
             font-size: 0.9em;
             padding: 8px 12px;
         }


         /* Footer */
        footer {
            text-align: center;
            margin-top: 30px;
            padding: 15px;
            font-size: 0.9em;
            color: #777;
             background-color: #e9ecef;
             border-top: 1px solid #dee2e6;
             position: fixed;
             bottom: 0;
             left: 0;
             width: 100%;
             z-index: 999; /* Below calculator */
        }

    </style>
</head>
<body>
    <!-- Calculator Toggle Button -->
    <button id="calc-toggle" class="calc-toggle-button" onclick="toggleCalculator()">Show Calculator</button>

    <!-- Calculator Element -->
    <div id="calculator">
        <div id="calc-header">
            <span>Calculator</span>
            <div id="calc-controls">
                <button id="calc-minimize" onclick="minimizeCalculator()">_</button>
                <button id="calc-close" onclick="closeCalculator()">X</button>
            </div>
        </div>
        <div id="calc-body">
            <input type="text" id="calc-display" readonly>
            <div class="calc-buttons">
                <button onclick="calcClear()">C</button>
                <button onclick="calcInput('/')" class="operator">/</button>
                <button onclick="calcInput('*')" class="operator">*</button>
                <button onclick="calcInput('-')" class="operator">-</button>

                <button onclick="calcInput('7')">7</button>
                <button onclick="calcInput('8')">8</button>
                <button onclick="calcInput('9')">9</button>
                <button onclick="calcInput('+')" class="operator" style="grid-row: span 2;">+</button>

                <button onclick="calcInput('4')">4</button>
                <button onclick="calcInput('5')">5</button>
                <button onclick="calcInput('6')">6</button>


                <button onclick="calcInput('1')">1</button>
                <button onclick="calcInput('2')">2</button>
                <button onclick="calcInput('3')">3</button>
                <button onclick="calcEquals()" class="equals" style="grid-row: span 2;">=</button>

                <button onclick="calcInput('0')" style="grid-column: span 2;">0</button>
                <button onclick="calcInput('.')">.</button>

            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>3.1.1 Food and Fuels</h1>
            <h2>An Interactive KS3 Physics Lesson</h2>
        </header>

        <nav class="tab-nav">
            <button class="tab-button active" onclick="openTab(event, 'tutorial')">Tutorial</button>
            <button class="tab-button" onclick="openTab(event, 'practice')">Practice</button>
            <button class="tab-button" onclick="openTab(event, 'game')">Game</button>
        </nav>

        <!-- Tutorial Section -->
        <section id="tutorial" class="tab-content active">
            <h3>Tutorial Sections</h3>
            <nav class="tutorial-sub-nav">
                <button class="tutorial-sub-button active" onclick="openSubTab(event, 'intro')">Introduction & Units</button>
                <button class="tutorial-sub-button" onclick="openSubTab(event, 'food-fuels')">Energy in Food & Fuels</button>
                <button class="tutorial-sub-button" onclick="openSubTab(event, 'simulation')">Simulation</button>
                <button class="tutorial-sub-button" onclick="openSubTab(event, 'needs')">Energy Needs & Activities</button>
                <button class="tutorial-sub-button" onclick="openSubTab(event, 'menu-planner')">Daily Menu Planner</button>
            </nav>

            <!-- Sub-Tab: Introduction & Units -->
            <div id="intro" class="tutorial-sub-content active">
                 <!-- Content same as before -->
                 <h4>Learning Objectives</h4>
                 <p>After this lesson, you should be able to:</p>
                 <ul>
                     <li>State the unit of energy content of food.</li>
                     <li>Compare the energy values of different foods and fuels.</li>
                     <li>Compare the energy in foods and fuels with the energy needed for different activities.</li>
                      <li>Plan a simple menu based on energy requirements.</li>
                 </ul>
                 <h4>Why Do We Need Energy?</h4>
                 <p>What did you have for breakfast? You need energy from food to do many things, including walking, breathing, keeping warm, and even reading this! Your brain needs energy to work constantly.</p>
                 <h4>How Much Energy? Units of Energy</h4>
                 <p>Different foods and fuels are stores of different amounts of <strong>chemical energy</strong>. Energy is measured in <strong>joules (J)</strong>. One joule is a very small amount of energy, so we often use <strong>kilojoules (kJ)</strong>.</p>
                 <div class="highlight-box"><strong>Key Conversion:</strong> 1 kJ = 1000 J</div>
                 <p><strong>Question A:</strong> State the unit of energy often used for food.
                     <span class="reveal-answer" onclick="revealAnswer(this, 'Kilojoules (kJ)')">(Click to reveal)</span><span class="answer-hidden"></span></p>
            </div>

            <!-- Sub-Tab: Energy in Food & Fuels -->
            <div id="food-fuels" class="tutorial-sub-content">
                <!-- Content same as before -->
                <h4>Energy in Food</h4>
                 <p>Food labels tell you how much energy is in the store associated with that food. The amount of energy stored in different foods varies greatly.</p>
                 <h5>Energy (kJ) per 100 g</h5>
                 <table><thead><tr><th>Food</th><th>Energy (kJ) per 100 g</th></tr></thead><tbody><tr><td>Apple</td><td>200</td></tr><tr><td>Banana</td><td>340</td></tr><tr><td>Peas</td><td>250</td></tr><tr><td>Chips</td><td>1000</td></tr><tr><td>Cooked Beef</td><td>1000</td></tr><tr><td>Chocolate</td><td>1500</td></tr><tr><td>Bread (Slice)</td><td>~350</td></tr><tr><td>Milk (200ml)</td><td>~500</td></tr><tr><td>Yogurt (Pot)</td><td>~400</td></tr><tr><td>Chicken Breast (100g)</td><td>~650</td></tr><tr><td>Rice (Cooked, 100g)</td><td>~550</td></tr><tr><td>Salad (Mixed, 100g)</td><td>~100</td></tr></tbody></table>
                 <p>When you choose which foods to eat, you need to consider the nutritional value (like vitamins, fibre, protein) as well as the energy content.</p>
                 <h4>How Much Energy in Fuels?</h4>
                  <p>Coal, oil, wood, and natural gas are <strong>fuels</strong>. Like food, they are stores of chemical energy...</p>
                  <div class="highlight-box"><p>A lump of coal might store around <strong>3000 kJ</strong> of energy... which is the same amount as two 100g bars of chocolate!</p></div>
                  <p><strong>Question B:</strong> Name three fuels. <span class="reveal-answer" onclick="revealAnswer(this, 'Coal, Oil, Wood (or Natural Gas)')">(Click to reveal)</span><span class="answer-hidden"></span></p>
            </div>

             <!-- Sub-Tab: Simulation -->
            <div id="simulation" class="tutorial-sub-content">
                 <!-- Content same as before -->
                 <h4>Experiment Simulation: Measuring Energy in Food</h4>
                 <p>We can estimate the amount of energy stored in food by burning it and using the heat released to warm up water...</p>
                 <div class="simulation-container">
                     <div class="sim-controls">
                         <h5>1. Select Food:</h5><select id="food-selector"><option value="apple" data-energy="1">Apple (low energy)</option><option value="banana" data-energy="2">Banana</option><option value="chips" data-energy="5">Chips</option><option value="chocolate" data-energy="8">Chocolate (high energy)</option><option value="marshmallow" data-energy="7">Marshmallow</option></select>
                         <h5>2. Burn Food:</h5><button id="burn-button" class="sim-button" onclick="runSimulation()">Burn Food Sample</button><button id="reset-button" class="sim-button" onclick="resetSimulation()" disabled>Reset</button>
                         <h5>Explanation:</h5><p>The burning food releases heat energy...</p>
                     </div>
                     <div class="sim-visuals">
                         <div id="sim-results"><table><tr><td>Initial Temp:</td><td><span id="initial-temp">20</span>°C</td></tr><tr><td>Final Temp:</td><td><span id="final-temp">--</span>°C</td></tr><tr><td>Temp Change:</td><td><span id="temp-change">--</span>°C</td></tr></table></div>
                         <div id="sim-stand"><div id="sim-tube"></div><div id="sim-thermometer"><div id="sim-thermo-liquid"></div><div id="sim-thermo-bulb"></div></div><div id="sim-food">Food</div><div id="sim-flame"></div></div>
                     </div>
                 </div>
            </div>

             <!-- Sub-Tab: Energy Needs & Activities -->
            <div id="needs" class="tutorial-sub-content">
                 <!-- Content same as before -->
                 <h4>How Much Energy Do You Need Each Day?</h4>
                 <p>You need different amounts of energy depending on what you do each day...</p><ul><li>Sleeping: ~300 kJ per hour</li><li>Working (e.g., school): ~600 kJ per hour</li><li>Relaxing (e.g., watching TV): ~360 kJ per hour</li><li>Playing (e.g., football): ~3600 kJ per hour</li></ul>
                  <div class="highlight-box fact"><strong>Fantastic Fact:</strong> An average adult man needs about 12,000 kJ per day...</div>
                 <h4>Energy Cost of Activities</h4><p>There is an energy cost to everything that you do...</p>
                 <table><thead><tr><th>Activity</th><th>Energy (kJ) for each minute of activity</th></tr></thead><tbody><tr><td>Sitting</td><td>6</td></tr><tr><td>Standing</td><td>7</td></tr><tr><td>Washing, dressing</td><td>15</td></tr><tr><td>Walking slowly</td><td>13</td></tr><tr><td>Cycling</td><td>25</td></tr><tr><td>Running</td><td>60</td></tr><tr><td>Swimming</td><td>73</td></tr></tbody></table>
                 <h4>Energy Balance</h4><p><strong>Energy balance</strong> means the energy you take in from food equals the energy you use...</p>
            </div>

            <!-- Sub-Tab: Menu Planner -->
            <div id="menu-planner" class="tutorial-sub-content">
                <!-- Content same as before -->
                <h4>Daily Menu Planner</h4><p>Different people need different amounts of energy each day...</p>
                <div class="menu-planner-container">
                    <div class="menu-controls">
                        <h5>1. Choose a Profile:</h5><select id="menu-profile-select" onchange="handleProfileChange()"><option value="">-- Select Profile --</option><option value="office_worker">Office Worker (Sedentary)</option><option value="teen_active">Active Teenager (Growing & Active)</option><option value="athlete">Athlete (High Activity)</option></select>
                        <p>Target Daily Energy: <strong id="menu-target-kj">---</strong> kJ</p>
                        <h5>2. Select Foods for the Day:</h5><div id="menu-food-options"></div>
                    </div>
                    <div class="menu-summary">
                        <h5>3. Your Selected Menu:</h5><ul id="selected-menu-items"><li><i>No items selected yet.</i></li></ul>
                        <p>Total Menu Energy: <strong id="menu-total-kj">0</strong> kJ</p>
                        <h5>4. Check Your Menu:</h5><button class="menu-check-button" onclick="checkMenu()">Check Menu</button><div id="menu-feedback"></div>
                    </div>
                </div>
            </div>

        </section>

        <!-- Practice Section -->
        <section id="practice" class="tab-content">
             <h3>Test Your Knowledge</h3>
             <p>Answer the following questions based on the tutorial.</p>

             <div class="question" id="q1">
                 <p><strong>Question 1:</strong> Complete the sentences using words from the word bank:</p>
                 <div class="word-bank">
                    <strong>Word Bank:</strong> <code>food</code>, <code>fuels</code>, <code>kilojoules (kJ)</code>, <code>breathing</code>, <code>grow</code>, <code>Joules (J)</code>, <code>heat</code>, <code>move</code>, <code>fat</code>
                 </div>
                 <p>Energy is stored in <input type="text" id="q1a" size="10"> and <input type="text" id="q1b" size="10">. The amount of energy stored is measured in <input type="text" id="q1c" size="10">. When you are asleep, your body needs energy for keeping warm and <input type="text" id="q1d" size="15">. Children need more energy than adults to allow them to <input type="text" id="q1e" size="10">.</p>
                 <button onclick="checkQ1()">Check Answer</button>
                 <div class="feedback" id="f1"></div>
             </div>

             <div class="question" id="q2">
                  <!-- Content same as before -->
                 <p><strong>Question 2:</strong> Chips contain 1000 kJ per 100g. Cycling uses 25 kJ per minute. How many minutes to cycle off 200 g of chips?</p>
                 <p>Energy in 200g chips = <input type="number" id="q2a" size="6"> kJ</p>
                 <p>Time = Energy / Rate = <span id="q2a-display">?</span> / 25 kJ/min = <input type="number" id="q2b" size="6"> minutes</p>
                 <button onclick="checkQ2()">Check Answer</button><div class="feedback" id="f2"></div><div id="q2-hint" style="font-size: 0.9em; color: #555; margin-top: 5px; display: none;">Hint: Total energy in 200g? Then time = Energy / Rate.</div>
             </div>

              <div class="question" id="q3">
                   <!-- Content same as before -->
                 <p><strong>Question 3:</strong> Which activity uses the MOST energy per minute?</p>
                 <select id="q3a"><option value="">-- Select --</option><option value="sitting">Sitting</option><option value="walking">Walking slowly</option><option value="running">Running</option><option value="swimming">Swimming</option></select>
                 <button onclick="checkQ3()">Check Answer</button><div class="feedback" id="f3"></div>
             </div>

              <div class="question" id="q4">
                   <!-- Content same as before -->
                 <p><strong>Question 4:</strong> In the simulation, which food causes the largest temperature rise?</p>
                 <select id="q4a"><option value="">-- Select --</option><option value="apple">Apple</option><option value="banana">Banana</option><option value="chips">Chips</option><option value="chocolate">Chocolate</option></select>
                 <button onclick="checkQ4()">Check Answer</button><div class="feedback" id="f4"></div>
             </div>

             <div class="question" id="q5">
                  <!-- Content same as before -->
                 <p><strong>Question 5:</strong> 100g chocolate = 1500 kJ. Running = 60 kJ/min at 150 m/min. How far to run to burn off 50 g of chocolate?</p>
                 <p>Energy in 50g chocolate = <input type="number" id="q5a" size="6"> kJ</p>
                 <p>Time needed = <span id="q5a-display">?</span> / 60 kJ/min = <input type="number" id="q5b" size="6"> minutes</p>
                  <p>Distance = <span id="q5b-display">?</span> min x 150 m/min = <input type="number" id="q5c" size="6"> metres</p>
                 <button onclick="checkQ5()">Check Answer</button><div class="feedback" id="f5"></div><div id="q5-hint" style="font-size: 0.9em; color: #555; margin-top: 5px; display: none;">Hint: Energy in 50g? Time = Energy / Rate? Distance = Time x Speed?</div>
             </div>
        </section>

        <!-- Game Section -->
        <section id="game" class="tab-content">
            <h3>Game: Energy Balance Challenge</h3>
            <p>Try to manage your energy intake (eating) and expenditure (activities) over 10 hours. Keep your energy levels in the green zone (40%-70%)!</p>

            <div class="game-container">
                <div class="game-status">
                    <h4>Current Status</h4>
                    <p>Energy Level: <span id="energy-level-value">6000</span> kJ</p>
                    <div id="energy-bar-container"><div id="energy-bar"></div></div>
                    <p>Time Elapsed: <span id="game-time">0</span> hours</p>
                    <div id="game-message">Keep your energy balanced!</div>
                     <button onclick="resetGame()">Restart Game</button>
                </div>
                <div class="game-actions">
                    <h4>Actions (Each action takes 1 hour)</h4>
                     <p class="game-note"><i>(Note: Each hour also includes a ~<span id="basal-rate-display">300</span> kJ background energy burn)</i></p>
                    <div class="game-buttons">
                        <button onclick="gameAction('eat_apple')">Eat Apple (+200 kJ)</button>
                        <button onclick="gameAction('eat_salad')">Eat Salad (+100 kJ)</button>
                        <button onclick="gameAction('eat_fruit_salad')">Eat Fruit Salad (+400 kJ)</button>
                        <button onclick="gameAction('eat_pasta')">Eat Pasta (+2000 kJ)</button>
                        <button onclick="gameAction('eat_chocolate')">Eat Chocolate (+1500 kJ)</button>
                        <button onclick="gameAction('eat_pizza')">Eat Pizza (+1200 kJ)</button>
                        <button onclick="gameAction('eat_crisps')">Eat Crisps (+600 kJ)</button>

                        <button onclick="gameAction('relax')">Relax (-360 kJ)</button>
                        <button onclick="gameAction('light_walk')">Light Walk (-500 kJ)</button>
                        <button onclick="gameAction('work')">School Work (-600 kJ)</button>
                        <button onclick="gameAction('studying')">Studying (-400 kJ)</button>
                        <button onclick="gameAction('cycling')">Cycling (-1500 kJ)</button>
                        <button onclick="gameAction('play_football')">Play Football (-3600 kJ)</button>
                        <button onclick="gameAction('swimming')">Swimming (-4400 kJ)</button>
                    </div>
                </div>
            </div>
            <div class="game-explanation">
                <h5>Beyond Kilojoules: Why Just Eating Chocolate Isn't Healthy!</h5>
                <p>While foods like chocolate, chips, and pizza provide a lot of energy (kJ), they often lack other important things your body needs. A healthy diet isn't just about getting enough energy, it's about getting the *right kind* of energy and nutrients.</p>
                <ul>
                    <li><strong>Nutrients:</strong> Fruits, vegetables, lean meats, and whole grains provide vitamins, minerals, and fibre essential for growth, repair, and fighting illness. High-energy 'junk' foods often lack these.</li>
                    <li><strong>Fibre:</strong> Important for digestion. Found in fruits, vegetables, and whole grains, but often low in processed foods.</li>
                    <li><strong>Sugar & Fat:</strong> While needed in moderation, too much sugar (common in sweets, fizzy drinks) and unhealthy fats (common in fried foods, pastries) can lead to health problems like weight gain, tooth decay, and heart issues later in life.</li>
                </ul>
                <p><strong>The Goal:</strong> Aim for a balanced diet with plenty of variety, getting energy from different sources alongside essential nutrients.</p>
            </div>

        </section>

    </div> <!-- End Container -->

    <footer>
       KS3 Physics | Food and Fuels Interactive Lesson v3
    </footer>

    <script>
        // --- Main Tab Navigation ---
        function openTab(evt, tabName) {
            // ... (same as v2) ...
            var i, tabcontent, tabbuttons;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) tabcontent[i].style.display = "none";
            tabbuttons = document.getElementsByClassName("tab-button");
            for (i = 0; i < tabbuttons.length; i++) tabbuttons[i].className = tabbuttons[i].className.replace(" active", "");
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
            if (tabName === 'tutorial') {
                 const allSubContents = document.querySelectorAll('.tutorial-sub-content'); allSubContents.forEach(content => content.classList.remove('active'));
                 const allSubButtons = document.querySelectorAll('.tutorial-sub-button'); allSubButtons.forEach(button => button.classList.remove('active'));
                 if(document.getElementById('intro')) document.getElementById('intro').classList.add('active');
                 const firstSubButton = document.querySelector('.tutorial-sub-nav .tutorial-sub-button'); if(firstSubButton) firstSubButton.classList.add('active');
                 if(!document.getElementById('menu-food-options').hasChildNodes()) { populateFoodOptions(); handleProfileChange();} // Lazy load menu options
            }
            if (tabName === 'game') resetGame();
        }

         // --- Tutorial Sub-Tab Navigation ---
        function openSubTab(evt, subTabName) {
            // ... (same as v2) ...
            var i, subTabContent, subTabButtons;
            subTabContent = document.getElementsByClassName("tutorial-sub-content");
            for (i = 0; i < subTabContent.length; i++) { subTabContent[i].style.display = "none"; subTabContent[i].classList.remove("active"); }
            subTabButtons = document.getElementsByClassName("tutorial-sub-button");
            for (i = 0; i < subTabButtons.length; i++) subTabButtons[i].className = subTabButtons[i].className.replace(" active", "");
            const currentSubTab = document.getElementById(subTabName);
            if(currentSubTab) { currentSubTab.style.display = "block"; currentSubTab.classList.add("active"); }
            evt.currentTarget.className += " active";
             // Populate menu options if switching to planner and not already done
            if(subTabName === 'menu-planner' && !document.getElementById('menu-food-options').hasChildNodes()){
                 populateFoodOptions();
                 handleProfileChange();
            }
        }

        // --- Tutorial: Reveal Answer ---
        function revealAnswer(element, answer) { /* ... (same as v2) ... */
            const answerSpan = element.nextElementSibling; if(!answerSpan) return;
            if (answerSpan.classList.contains('answer-hidden')) { answerSpan.textContent = `Answer: ${answer}`; answerSpan.classList.remove('answer-hidden'); answerSpan.classList.add('answer-shown'); element.textContent = '(Hide Answer)'; }
            else { answerSpan.textContent = ''; answerSpan.classList.remove('answer-shown'); answerSpan.classList.add('answer-hidden'); element.textContent = '(Click to reveal)'; }
        }

        // --- Tutorial: Simulation ---
        const initialTemp = 20; let simRunning = false;
        const foodSelector = document.getElementById('food-selector'); const burnButton = document.getElementById('burn-button'); const resetButton = document.getElementById('reset-button');
        const initialTempDisplay = document.getElementById('initial-temp'); const finalTempDisplay = document.getElementById('final-temp'); const tempChangeDisplay = document.getElementById('temp-change');
        const thermoLiquid = document.getElementById('sim-thermo-liquid'); const simFood = document.getElementById('sim-food'); const simFlame = document.getElementById('sim-flame');
        const foodEnergyFactors = { apple: 1, banana: 2, chips: 5, chocolate: 8, marshmallow: 7 };
        const foodColors = { apple: '#90EE90', banana: '#FFEA00', chips: '#FFD700', chocolate: '#7B3F00', marshmallow: '#FFFFFF' };
        function updateFoodVisual() { /* ... (same as v2) ... */
            if(!foodSelector || !simFood) return;
            const selectedFood = foodSelector.value; simFood.textContent = selectedFood.charAt(0).toUpperCase() + selectedFood.slice(1); simFood.style.backgroundColor = foodColors[selectedFood] || '#deb887'; simFood.style.color = (selectedFood === 'marshmallow' || selectedFood === 'banana' || selectedFood === 'chips') ? '#333' : '#fff';
        }
        if (foodSelector) foodSelector.addEventListener('change', updateFoodVisual);
        function runSimulation() { /* ... (same as v2 - check elements exist) ... */
            if (simRunning || !burnButton || !resetButton || !foodSelector || !finalTempDisplay || !tempChangeDisplay || !thermoLiquid || !simFlame) return;
            simRunning = true; burnButton.disabled = true; resetButton.disabled = true; foodSelector.disabled = true;
            const selectedFood = foodSelector.value; const energyFactor = parseFloat(foodSelector.options[foodSelector.selectedIndex].getAttribute('data-energy')); const validEnergyFactor = isNaN(energyFactor) ? 1 : energyFactor;
            const maxTempRise = 3 + validEnergyFactor * 5; const finalTemp = initialTemp + maxTempRise;
            simFlame.classList.add('burning'); const initialHeight = 20; const finalHeight = Math.min(95, initialHeight + maxTempRise * 1.5); thermoLiquid.style.height = finalHeight + '%';
            setTimeout(() => { finalTempDisplay.textContent = finalTemp.toFixed(1); tempChangeDisplay.textContent = maxTempRise.toFixed(1); simFlame.classList.remove('burning'); resetButton.disabled = false; simRunning = false; }, 2500);
        }
        function resetSimulation() { /* ... (same as v2 - check elements exist) ... */
            if(initialTempDisplay) initialTempDisplay.textContent = initialTemp; if(finalTempDisplay) finalTempDisplay.textContent = '--'; if(tempChangeDisplay) tempChangeDisplay.textContent = '--';
            if(thermoLiquid) thermoLiquid.style.height = '20%'; if(burnButton) burnButton.disabled = false; if(resetButton) resetButton.disabled = true; if(foodSelector) foodSelector.disabled = false;
            if(simFlame) simFlame.classList.remove('burning'); updateFoodVisual();
        }

        // --- Tutorial: Menu Planner ---
        const profiles = { office_worker: { name: "Office Worker (Sedentary)", targetKJ: 9000 }, teen_active: { name: "Active Teenager (Growing & Active)", targetKJ: 11000 }, athlete: { name: "Athlete (High Activity)", targetKJ: 14000 } };
        const menuFoods = { apple: { name: "Apple", kj: 350 }, banana: { name: "Banana", kj: 400 }, bread_slice: { name: "Bread (2 sl)", kj: 700 }, cereal_bowl: { name: "Cereal+Milk", kj: 1200 }, yogurt: { name: "Yogurt", kj: 400 }, milk_glass: { name: "Milk", kj: 500 }, orange_juice: { name: "OJ", kj: 450 }, sandwich_ham: { name: "Ham Sandwich", kj: 1500 }, sandwich_cheese: { name: "Cheese Sandwich", kj: 1800 }, salad_chicken: { name: "Chicken Salad", kj: 1400 }, pasta_tomato: { name: "Pasta+Sauce", kj: 2000 }, chicken_rice_veg: { name: "Chicken Meal", kj: 2500 }, beef_potatoes: { name: "Beef Meal", kj: 2800 }, fish_chips: { name: "Fish & Chips", kj: 3500 }, pizza_slice: { name: "Pizza (2 sl)", kj: 2400 }, chocolate_bar: { name: "Choc Bar (50g)", kj: 1100 }, crisps_bag: { name: "Crisps", kj: 600 }, fizzy_drink: { name: "Fizzy Drink", kj: 600 } };
        let selectedProfile = null; let selectedFoodItems = {}; let currentMenuTotalKJ = 0;
        const foodOptionsContainer = document.getElementById('menu-food-options'); const selectedMenuItemsList = document.getElementById('selected-menu-items'); const menuTotalKJDisplay = document.getElementById('menu-total-kj'); const menuTargetKJDisplay = document.getElementById('menu-target-kj'); const menuFeedbackDisplay = document.getElementById('menu-feedback'); const profileSelect = document.getElementById('menu-profile-select');
        function populateFoodOptions() { /* ... (same as v2) ... */
             if (!foodOptionsContainer) return; foodOptionsContainer.innerHTML = '';
             for (const key in menuFoods) { const food = menuFoods[key]; const button = document.createElement('button'); button.dataset.key = key; button.innerHTML = `${food.name} <span>(${food.kj} kJ)</span>`; button.onclick = () => toggleFoodItem(key); foodOptionsContainer.appendChild(button); }
        }
        function handleProfileChange() { /* ... (same as v2) ... */
             if (!profileSelect || !menuTargetKJDisplay || !menuFeedbackDisplay) return; const selectedValue = profileSelect.value; selectedProfile = profiles[selectedValue];
             if (selectedProfile) { menuTargetKJDisplay.textContent = selectedProfile.targetKJ; } else { menuTargetKJDisplay.textContent = '---'; }
             selectedFoodItems = {}; updateMenuDisplay(); menuFeedbackDisplay.style.display = 'none';
             if(foodOptionsContainer){ const buttons = foodOptionsContainer.querySelectorAll('button'); buttons.forEach(btn => btn.classList.remove('selected')); }
        }
        function toggleFoodItem(key) { /* ... (same as v2) ... */
             if (!menuFoods[key] || !foodOptionsContainer) return; const food = menuFoods[key]; const button = foodOptionsContainer.querySelector(`button[data-key="${key}"]`);
             if (selectedFoodItems[key]) { delete selectedFoodItems[key]; if(button) button.classList.remove('selected'); }
             else { selectedFoodItems[key] = 1; if(button) button.classList.add('selected'); }
             updateMenuDisplay();
        }
        function updateMenuDisplay() { /* ... (same as v2) ... */
             if(!selectedMenuItemsList || !menuTotalKJDisplay) return; currentMenuTotalKJ = 0; selectedMenuItemsList.innerHTML = '';
             if (Object.keys(selectedFoodItems).length === 0) { selectedMenuItemsList.innerHTML = '<li><i>No items selected yet.</i></li>'; }
             else { for (const key in selectedFoodItems) { if (selectedFoodItems[key] > 0) { const food = menuFoods[key]; const listItem = document.createElement('li'); listItem.textContent = `${food.name} (${food.kj} kJ)`; selectedMenuItemsList.appendChild(listItem); currentMenuTotalKJ += food.kj; } } }
             menuTotalKJDisplay.textContent = currentMenuTotalKJ;
        }
        function checkMenu() { /* ... (same as v2) ... */
            if (!menuFeedbackDisplay) return;
            if (!selectedProfile) { menuFeedbackDisplay.textContent = 'Please select a profile first.'; menuFeedbackDisplay.style.backgroundColor = '#fff3cd'; menuFeedbackDisplay.style.color = '#856404'; menuFeedbackDisplay.style.display = 'block'; return; }
            const target = selectedProfile.targetKJ; const total = currentMenuTotalKJ; const lowerBound = target * 0.9; const upperBound = target * 1.1;
            let feedbackText = ''; let bgColor = ''; let textColor = '';
            if (total === 0) { feedbackText = 'Your menu is empty!'; bgColor = '#f8d7da'; textColor = '#721c24'; }
            else if (total < lowerBound) { feedbackText = `Your menu total (${total} kJ) is quite low vs target (${target} kJ). Need more energy!`; bgColor = '#fff3cd'; textColor = '#856404'; }
            else if (total > upperBound) { feedbackText = `Your menu total (${total} kJ) is quite high vs target (${target} kJ). Excess energy.`; bgColor = '#fff3cd'; textColor = '#856404'; }
            else { feedbackText = `Great job! Menu total (${total} kJ) is well-matched to target (${target} kJ).`; bgColor = '#d4edda'; textColor = '#155724'; }
            menuFeedbackDisplay.textContent = feedbackText; menuFeedbackDisplay.style.backgroundColor = bgColor; menuFeedbackDisplay.style.color = textColor; menuFeedbackDisplay.style.display = 'block';
        }

        // --- Practice Questions ---
        function showFeedback(id, isCorrect, message) { /* ... (same as v2) ... */
            const feedbackEl = document.getElementById(id); if(!feedbackEl) return; feedbackEl.textContent = message; feedbackEl.className = 'feedback ' + (isCorrect ? 'correct' : 'incorrect'); feedbackEl.style.display = 'block';
        }
        function checkQ1() { /* ... (same as v2, but checking against new word bank) ... */
             const a = document.getElementById('q1a').value.trim().toLowerCase(); const b = document.getElementById('q1b').value.trim().toLowerCase(); const c = document.getElementById('q1c').value.trim().toLowerCase(); const d = document.getElementById('q1d').value.trim().toLowerCase(); const e = document.getElementById('q1e').value.trim().toLowerCase();
             const correctA = ['food', 'foods'].includes(a); const correctB = ['fuel', 'fuels'].includes(b); const correctAB = (correctA && correctB) || (['fuel', 'fuels'].includes(a) && ['food', 'foods'].includes(b));
             const correctC = ['kj', 'kilojoules', 'kilojoule', 'kilojoules (kj)'].includes(c); const correctD = ['breathing', 'digestion', 'processes', 'functioning'].includes(d); const correctE = ['grow', 'growth'].includes(e);
             if (correctAB && correctC && correctD && correctE) { showFeedback('f1', true, 'Correct!'); }
             else { let errorMsg = "Not quite right. Check: "; if (!correctAB) errorMsg += "Energy stores, "; if (!correctC) errorMsg += "Unit, "; if (!correctD) errorMsg += "Asleep need, "; if (!correctE) errorMsg += "Children need."; showFeedback('f1', false, errorMsg.slice(0, -2) + '. Use the word bank.'); }
        }
        function checkQ2() { /* ... (same as v2) ... */ }
        if(document.getElementById('q2a')) document.getElementById('q2a').addEventListener('input', () => { if(document.getElementById('q2a-display')) document.getElementById('q2a-display').textContent = document.getElementById('q2a').value || '?'; });
        function checkQ3() { /* ... (same as v2) ... */ }
        function checkQ4() { /* ... (same as v2) ... */ }
        function checkQ5() { /* ... (same as v2) ... */ }
        if(document.getElementById('q5a')) document.getElementById('q5a').addEventListener('input', () => { if(document.getElementById('q5a-display')) document.getElementById('q5a-display').textContent = document.getElementById('q5a').value || '?'; });
        if(document.getElementById('q5b')) document.getElementById('q5b').addEventListener('input', () => { if(document.getElementById('q5b-display')) document.getElementById('q5b-display').textContent = document.getElementById('q5b').value || '?'; });

        // --- Game Logic ---
        let currentEnergy = 6000; const maxEnergy = 12000; let gameTime = 0; const basalRate = 300;
        const energyActions = { // Expanded list
            eat_apple: { change: 200, message: "Ate an apple." },          eat_salad: { change: 100, message: "Ate a salad." },
            eat_fruit_salad: { change: 400, message: "Ate fruit salad." }, eat_pasta: { change: 2000, message: "Ate pasta." },
            eat_chocolate: { change: 1500, message: "Ate chocolate." },    eat_pizza: { change: 1200, message: "Ate pizza." },
            eat_crisps: { change: 600, message: "Ate crisps." },
            relax: { change: -360, message: "Relaxed." },                  light_walk: { change: -500, message: "Went for a walk." },
            work: { change: -600, message: "Did school work." },           studying: { change: -400, message: "Studied." },
            cycling: { change: -1500, message: "Cycled." },                play_football: { change: -3600, message: "Played football." },
            swimming: { change: -4400, message: "Went swimming." }
        };
        const energyLevelValueEl = document.getElementById('energy-level-value'); const energyBarEl = document.getElementById('energy-bar'); const gameTimeEl = document.getElementById('game-time'); const gameMessageEl = document.getElementById('game-message'); const basalRateDisplayEl = document.getElementById('basal-rate-display');
        function updateGameDisplay() { /* ... (same as v2) ... */
             currentEnergy = Math.max(0, currentEnergy); const energyPercent = Math.min(100, (currentEnergy / maxEnergy) * 100);
             if(energyLevelValueEl) energyLevelValueEl.textContent = Math.round(currentEnergy) + " kJ";
             if(energyBarEl) { energyBarEl.style.width = energyPercent + '%'; energyBarEl.textContent = Math.round(energyPercent) + '%';
                 if (energyPercent < 20) energyBarEl.style.backgroundColor = '#dc3545'; else if (energyPercent < 40) energyBarEl.style.backgroundColor = '#ffc107'; else if (energyPercent <= 70) energyBarEl.style.backgroundColor = '#28a745'; else if (energyPercent <= 90) energyBarEl.style.backgroundColor = '#ffc107'; else energyBarEl.style.backgroundColor = '#dc3545';
             }
             if(gameTimeEl) gameTimeEl.textContent = gameTime + " hours";
             if (gameTime < 10 && gameMessageEl) {
                 let statusMsg = "";
                  if (energyPercent < 20) statusMsg = "Critically low!"; else if (energyPercent < 40) statusMsg = "Feeling tired!"; else if (energyPercent <= 70) statusMsg = "Balanced."; else if (energyPercent <= 90) statusMsg = "Feeling full."; else statusMsg = "Too much energy!";
                  // Only update if the message isn't showing the action result
                  if (!gameMessageEl.textContent.includes('kJ')) gameMessageEl.textContent = statusMsg;
             }
             if(basalRateDisplayEl) basalRateDisplayEl.textContent = basalRate;
        }
         function gameAction(actionKey) { /* ... (minor change to message display) ... */
             if (gameTime >= 10 || !energyActions[actionKey] || !gameMessageEl) return; const action = energyActions[actionKey];
             const netChange = action.change - basalRate;
             currentEnergy += netChange;
             gameTime++;
             // Display action message + net change briefly
             gameMessageEl.textContent = `${action.message} (Net: ${netChange >= 0 ? '+' : ''}${netChange} kJ)`;
             updateGameDisplay();
             if (gameTime >= 10) endGame();
             else {
                 // Revert to status message after a delay
                 setTimeout(() => {
                     if (gameTime < 10) updateGameDisplay(); // Update based on current state
                 }, 2000); // Show action result for 2 seconds
             }
         }
         function endGame() { /* ... (same as v2) ... */
              const finalPercent = (currentEnergy / maxEnergy) * 100; let finalMessage = "Game Over! "; let msgColor = '#333';
              if (finalPercent >= 40 && finalPercent <= 70) { finalMessage += "Balanced energy! 👍"; msgColor = 'green'; }
              else if (finalPercent < 40) { finalMessage += "Ended too low. 😟"; msgColor = 'red'; }
              else { finalMessage += "Ended too high. 😬"; msgColor = 'orange'; }
              if(gameMessageEl) { gameMessageEl.textContent = finalMessage; gameMessageEl.style.color = msgColor; }
              document.querySelectorAll('.game-buttons button').forEach(btn => btn.disabled = true);
         }
         function resetGame() { /* ... (same as v2) ... */
             currentEnergy = 6000; gameTime = 0;
             if(gameMessageEl) { gameMessageEl.textContent = "Keep your energy balanced!"; gameMessageEl.style.color = '#333'; }
             document.querySelectorAll('.game-buttons button').forEach(btn => btn.disabled = false);
             updateGameDisplay();
         }

        // --- Calculator Logic ---
        const calculator = document.getElementById('calculator');
        const calcDisplay = document.getElementById('calc-display');
        const calcToggleButton = document.getElementById('calc-toggle');
        const minimizeButton = document.getElementById('calc-minimize');
        let calcVisible = false;
        let calcMinimized = false;
        let operand1 = '';
        let operand2 = '';
        let currentOperator = null;
        let shouldResetDisplay = false;

        function toggleCalculator() {
            calcVisible = !calcVisible;
            calculator.style.display = calcVisible ? 'block' : 'none';
            calcToggleButton.textContent = calcVisible ? 'Hide Calculator' : 'Show Calculator';
            // If showing, ensure it's not minimized
            if (calcVisible && calcMinimized) {
                restoreCalculator();
            }
        }
        function closeCalculator() {
            calcVisible = false;
            calculator.style.display = 'none';
            calcToggleButton.textContent = 'Show Calculator';
        }
        function minimizeCalculator() {
            calcMinimized = true;
            calculator.classList.add('minimized');
            minimizeButton.textContent = '[]'; // Change icon to restore symbol
            minimizeButton.onclick = restoreCalculator;
        }
        function restoreCalculator() {
            calcMinimized = false;
            calculator.classList.remove('minimized');
            minimizeButton.textContent = '_'; // Change icon back to minimize
            minimizeButton.onclick = minimizeCalculator;
        }

        // Dragging functionality
        let isDragging = false;
        let offsetX, offsetY;
        const calcHeader = document.getElementById('calc-header');

        if(calcHeader) {
            calcHeader.addEventListener('mousedown', (e) => {
                // Prevent dragging if clicking on buttons inside header
                if (e.target.tagName === 'BUTTON') return;
                isDragging = true;
                offsetX = e.clientX - calculator.offsetLeft;
                offsetY = e.clientY - calculator.offsetTop;
                calculator.style.cursor = 'grabbing'; // Indicate dragging
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
                e.preventDefault(); // Prevent text selection during drag
            });
        }

        function onMouseMove(e) {
            if (!isDragging) return;
            let newX = e.clientX - offsetX;
            let newY = e.clientY - offsetY;

            // Basic boundary check (optional)
            newX = Math.max(0, Math.min(newX, window.innerWidth - calculator.offsetWidth));
            newY = Math.max(0, Math.min(newY, window.innerHeight - calculator.offsetHeight));

            calculator.style.left = newX + 'px';
            calculator.style.top = newY + 'px';
        }

        function onMouseUp() {
            if(isDragging) {
                isDragging = false;
                calculator.style.cursor = 'move'; // Reset cursor
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }
        }

        // Calculator Input & Operations
        function calcInput(value) {
            if (calcDisplay.value === '0' || shouldResetDisplay) {
                calcDisplay.value = value;
                shouldResetDisplay = false;
            } else {
                // Prevent multiple decimal points
                if (value === '.' && calcDisplay.value.includes('.')) return;
                calcDisplay.value += value;
            }
        }

        function calcClear() {
            calcDisplay.value = '0';
            operand1 = '';
            operand2 = '';
            currentOperator = null;
            shouldResetDisplay = false;
        }

        function setOperator(operator) {
            if (currentOperator !== null && !shouldResetDisplay) {
                // If an operator exists and we haven't just calculated, perform previous calc first
                calcEquals();
            }
            operand1 = calcDisplay.value;
            currentOperator = operator;
            shouldResetDisplay = true; // Ready for next number
        }

        function calcEquals() {
            if (currentOperator === null || shouldResetDisplay) return; // Nothing to calculate or waiting for second operand
            if (operand1 === '') return; // Should not happen if operator is set, but safety check

            operand2 = calcDisplay.value;
            let result;
            const num1 = parseFloat(operand1);
            const num2 = parseFloat(operand2);

            switch (currentOperator) {
                case '+': result = num1 + num2; break;
                case '-': result = num1 - num2; break;
                case '*': result = num1 * num2; break;
                case '/':
                    if (num2 === 0) {
                        result = 'Error'; // Handle division by zero
                    } else {
                        result = num1 / num2;
                    }
                    break;
                default: return;
            }

            calcDisplay.value = result;
            operand1 = result.toString(); // Store result for chained operations
            currentOperator = null; // Reset operator after calculation
            shouldResetDisplay = true; // Display resets on next number input
        }

         // Assign setOperator to operator buttons correctly
        document.querySelectorAll('.calc-buttons button.operator').forEach(button => {
            button.onclick = () => setOperator(button.textContent);
        });


        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
             openTab({ currentTarget: document.querySelector('.tab-button.active') }, 'tutorial');
             resetSimulation();
             resetGame();
             // Don't populate menu initially, do it when tab is opened
             // populateFoodOptions(); handleProfileChange();
             calcClear(); // Ensure calculator display is '0'
        });

    </script>

</body>
</html>
